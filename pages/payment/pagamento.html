<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento - Achei na Ilha</title>
    <link rel="icon" type="image/svg+xml" href="../../assets/images/logo-achei-na-ilha.png">
    <link rel="alternate icon" href="../../assets/images/logo-achei-na-ilha.png">
    <link rel="stylesheet" href="../../assets/css/header.css">
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <!-- Sistema de Toast -->
    <script src="../../assets/js/toast.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding-bottom: 40px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .page-title {
            text-align: center;
            color: #333;
            margin-bottom: 40px;
        }

        .page-title h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .page-title p {
            color: #666;
            font-size: 16px;
        }

        .payment-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .calculator-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .summary-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 100px;
            height: fit-content;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .days-input-wrapper {
            position: relative;
        }

        .days-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            transition: border-color 0.3s;
        }

        .days-input:focus {
            outline: none;
            border-color: #0077B6;
        }

        .days-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .days-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .days-btn:hover {
            border-color: #0077B6;
            color: #0077B6;
        }

        .days-btn.recommended {
            background: #e3f2fd;
            border-color: #0077B6;
            color: #0077B6;
        }

        .days-btn.active {
            background: #0077B6;
            color: white;
            border-color: #0077B6;
        }

        .days-help {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            font-style: italic;
        }

        .highlight-option {
            margin-top: 30px;
            padding: 20px;
            background: #fff9e6;
            border: 2px solid #ffd700;
            border-radius: 8px;
        }

        .highlight-option label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
            color: #333;
        }

        .highlight-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }

        .highlight-info {
            margin-top: 10px;
            font-size: 13px;
            color: #666;
            padding-left: 32px;
        }

        .price-breakdown {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .price-row:last-child {
            border-bottom: none;
        }

        .price-label {
            color: #666;
            font-size: 14px;
        }

        .price-value {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .price-total {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #0077B6;
        }

        .price-total .price-label {
            font-size: 18px;
            color: #333;
            font-weight: 600;
        }

        .price-total .price-value {
            font-size: 24px;
            color: #0077B6;
        }

        .announcement-info {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
        }

        .announcement-info h4 {
            color: #2e7d32;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .announcement-info p {
            color: #666;
            font-size: 13px;
            line-height: 1.5;
        }

        .payment-methods {
            margin-top: 30px;
        }

        .payment-method {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-method:hover {
            border-color: #0077B6;
        }

        .payment-method input[type="radio"] {
            margin-right: 12px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .payment-method label {
            flex: 1;
            cursor: pointer;
            font-weight: 500;
            color: #333;
            margin: 0;
        }

        .payment-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .btn-pay {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .btn-pay:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .btn-pay:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 13px;
            color: #856404;
        }

        /* Estilos para se√ß√£o PIX */
        #pixSection {
            animation: fadeIn 0.3s ease-in;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }
        
        /* Overlay escuro quando PIX estiver vis√≠vel */
        #pixOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
        }
        
        #pixSection[style*="display: block"],
        #pixSection:not([style*="display: none"]) {
            display: block !important;
        }
        
        #pixSection[style*="display: none"] {
            display: none !important;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        #pixCode {
            word-break: break-all;
        }
        
        /* Responsivo para mobile */
        @media (max-width: 768px) {
            #pixSection {
                width: 95%;
                max-width: 95%;
                padding: 20px;
                max-height: 95vh;
            }
        }

        .pix-success {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
        }

        .pix-success h3 {
            color: #155724;
            margin-bottom: 10px;
        }

        .pix-success p {
            color: #155724;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .payment-wrapper {
                grid-template-columns: 1fr;
            }

            .summary-section {
                position: relative;
                top: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header-container"></div>

    <div class="container">
        <div class="page-title">
            <h1>üí∞ Pagamento do An√∫ncio</h1>
            <p>Escolha a dura√ß√£o e personalize seu an√∫ncio</p>
        </div>

        <div class="payment-wrapper">
            <!-- Calculadora -->
            <div class="calculator-section" id="calculatorSection">
                <h2 class="section-title">üìä Calculadora de Pre√ßo</h2>

                <div class="form-group">
                    <label>Quantidade de Dias</label>
                    <div class="days-input-wrapper">
                        <input 
                            type="number" 
                            id="daysInput" 
                            class="days-input" 
                            min="3" 
                            max="30"
                            value="7"
                            required
                        >
                    </div>
                    <div class="days-buttons">
                        <button type="button" class="days-btn" data-days="3">M√≠nimo (3 dias)</button>
                        <button type="button" class="days-btn recommended active" data-days="7">Recomendado (7 dias)</button>
                        <button type="button" class="days-btn" data-days="14">14 dias</button>
                        <button type="button" class="days-btn" data-days="30">30 dias</button>
                    </div>
                    <p class="days-help">M√≠nimo de 3 dias. Recomendamos 7 dias para melhor alcance.</p>
                </div>

                <div class="highlight-option">
                    <label>
                        <input 
                            type="checkbox" 
                            id="highlightCheckbox" 
                            class="highlight-checkbox"
                        >
                        <span>‚≠ê Adicionar ao Destaque</span>
                    </label>
                    <div class="highlight-info">
                        Seu an√∫ncio ficar√° em destaque por 3 dias. Aparecer√° no topo das buscas!
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o de QR Code PIX (aparece ap√≥s gerar PIX) -->
            <div class="calculator-section" id="pixSection" style="display: none;">
                <h2 class="section-title">üì± Pague com PIX</h2>
                
                <div style="text-align: center; margin-bottom: 20px;">
                    <p style="color: #666; margin-bottom: 15px;">Escaneie o QR Code com o app do seu banco ou copie o c√≥digo PIX</p>
                    
                    <!-- QR Code -->
                    <div id="qrcodeContainer" style="margin: 20px auto; max-width: 300px;">
                        <canvas id="qrcodeCanvas" style="display: none;"></canvas>
                        <img id="qrcodeImage" src="" alt="QR Code PIX" style="max-width: 100%; border: 4px solid #f0f0f0; border-radius: 12px; padding: 10px; background: white;">
                    </div>
                    
                    <!-- C√≥digo PIX Copia e Cola -->
                    <div style="margin-top: 20px;">
                        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 10px; font-size: 14px;">
                            C√≥digo PIX (Copia e Cola)
                        </label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input 
                                type="text" 
                                id="pixCode" 
                                readonly 
                                style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 12px; font-family: monospace; background: #f9f9f9;"
                            >
                            <button 
                                onclick="copyPixCode()" 
                                id="btnCopyPix"
                                style="padding: 12px 20px; background: #0077B6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap;"
                            >
                                üìã Copiar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Informa√ß√µes do Pagamento -->
                    <div style="background: #f0f7ff; padding: 20px; border-radius: 8px; margin-top: 20px; text-align: left;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #666; font-weight: 500;">Valor:</span>
                            <span style="color: #0077B6; font-weight: 700; font-size: 18px;" id="pixValue">R$ 0,00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #666; font-weight: 500;">Status:</span>
                            <span style="color: #ff9800; font-weight: 600;" id="pixStatus">‚è≥ Aguardando pagamento...</span>
                        </div>
                        <div style="font-size: 12px; color: #999; margin-top: 15px; text-align: center;">
                            O pagamento ser√° verificado automaticamente
                        </div>
                    </div>
                    
                    <!-- Bot√£o de Cancelar -->
                    <button 
                        onclick="cancelPixPayment()" 
                        style="margin-top: 20px; padding: 12px 24px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;"
                    >
                        ‚ùå Cancelar Pagamento
                    </button>
                </div>
            </div>

            <!-- Resumo -->
            <div class="summary-section" id="summarySection">
                <h2 class="section-title">üìã Resumo do Pedido</h2>

                <div class="announcement-info" id="announcementInfo">
                    <h4>üìù An√∫ncio:</h4>
                    <p id="announcementTitle">Carregando...</p>
                </div>

                <div class="price-breakdown">
                    <div class="price-row">
                        <span class="price-label">Publica√ß√£o (por dia)</span>
                        <span class="price-value" id="dailyPrice">R$ 9,90</span>
                    </div>
                    <div class="price-row">
                        <span class="price-label">Dias selecionados</span>
                        <span class="price-value" id="daysSelected">7 dias</span>
                    </div>
                    <div class="price-row" id="highlightRow" style="display: none;">
                        <span class="price-label">‚≠ê Destaque (3 dias)</span>
                        <span class="price-value" id="highlightPrice">R$ 8,90</span>
                    </div>
                    <div class="price-row price-total">
                        <span class="price-label">Total</span>
                        <span class="price-value" id="totalPrice">R$ 69,30</span>
                    </div>
                </div>

                <div class="payment-methods">
                    <h3 style="margin-bottom: 15px; font-size: 16px;">Forma de Pagamento</h3>
                    <div class="payment-method" style="background: #e8f5e9; border-color: #4caf50;">
                        <input type="radio" id="paymentPix" name="paymentMethod" value="pix" checked disabled>
                        <label for="paymentPix">
                            <span class="payment-icon">üí≥</span>
                            PIX - Aprova√ß√£o Imediata
                        </label>
                    </div>
                </div>

                <button class="btn-pay" id="btnPay" onclick="processPayment()">
                    üí≥ Gerar PIX
                </button>

                <div class="warning-box" id="warningBox">
                    ‚ö†Ô∏è Ap√≥s o pagamento ser confirmado, seu an√∫ncio ser√° publicado imediatamente.
                </div>
            </div>

            </div>
        </div>
    </div>

    <!-- Sistema de Toast (carregado apenas uma vez) -->
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../assets/js/supabase-config.js"></script>
    <script src="../../assets/js/supabase-auth-service.js"></script>
    <script src="../../assets/js/config-service.js"></script>
    <script src="../../assets/js/header-auth.js"></script>

    <script>
        // Esconder bot√£o flutuante na p√°gina de pagamento
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const floatingBtn = document.getElementById('floatingAnnounceBtn');
                if (floatingBtn) {
                    floatingBtn.style.display = 'none';
                }
            }, 1000);
        });

        let authService;
        
        // Vari√°veis de configura√ß√£o (ser√£o carregadas do banco - SEM valores hardcoded)
        let DAILY_PRICE = null;
        let HIGHLIGHT_PRICE = null;
        let MIN_DAYS = null;
        let MAX_DAYS = null;
        let MAX_PRICE = null;
        let RECOMMENDED_DAYS = null;
        
        // Configura√ß√µes do PushinPay PIX (ser√£o carregadas do banco - SEM valores hardcoded)
        let PUSHINPAY_API_KEY = null;
        let N8N_PIX_CREATE_URL = null;
        let N8N_PIX_CHECK_URL = null;
        let N8N_WEBHOOK_URL = null;
        
        // Vari√°veis globais para controle do PIX
        let pixCheckInterval = null;
        let currentPixId = null;

        // Fun√ß√£o para carregar configura√ß√µes do banco
        async function loadConfigurations(forceRefresh = false) {
            try {
                if (!window.configService) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                if (window.configService) {
                    await window.configService.initialize();
                    
                    // Se for√ßar refresh, limpar cache primeiro
                    if (forceRefresh) {
                        window.configService.clearCache();
                    }
                    
                    // Carregar configura√ß√µes de pre√ßos (OBRIGAT√ìRIO - do banco)
                    const pricingConfig = await window.configService.getPricingConfig();
                    if (!pricingConfig.dailyPrice || !pricingConfig.highlightPrice || !pricingConfig.minDays || !pricingConfig.maxDays || !pricingConfig.maxPrice || !pricingConfig.recommendedDays) {
                        throw new Error('Configura√ß√µes de pre√ßos n√£o encontradas no banco de dados. Verifique a tabela configuracoes.');
                    }
                    DAILY_PRICE = pricingConfig.dailyPrice;
                    HIGHLIGHT_PRICE = pricingConfig.highlightPrice;
                    MIN_DAYS = pricingConfig.minDays;
                    MAX_DAYS = pricingConfig.maxDays;
                    MAX_PRICE = pricingConfig.maxPrice;
                    RECOMMENDED_DAYS = pricingConfig.recommendedDays;

                    // Carregar configura√ß√µes PushinPay (OBRIGAT√ìRIO - do banco)
                    const pushinpayConfig = await window.configService.getPushinPayConfig(forceRefresh);
                    
                    // Verificar isProduction corretamente
                    const isProduction = pushinpayConfig.isProduction === true;
                    
                    // Validar que as API keys existem
                    if (isProduction && !pushinpayConfig.apiKeyProd) {
                        throw new Error('API Key de produ√ß√£o do PushinPay n√£o encontrada no banco de dados.');
                    }
                    if (!isProduction && !pushinpayConfig.apiKeySandbox) {
                        throw new Error('API Key de sandbox do PushinPay n√£o encontrada no banco de dados.');
                    }
                    
                    PUSHINPAY_API_KEY = isProduction ? pushinpayConfig.apiKeyProd : pushinpayConfig.apiKeySandbox;
                    

                    // Carregar configura√ß√µes N8N (OBRIGAT√ìRIO - do banco)
                    const n8nConfig = await window.configService.getN8NConfig();
                    if (!n8nConfig.pixCreateUrl || !n8nConfig.pixCheckUrl || !n8nConfig.webhookUrl) {
                        throw new Error('Configura√ß√µes N8N n√£o encontradas no banco de dados. Verifique a tabela configuracoes.');
                    }
                    N8N_PIX_CREATE_URL = n8nConfig.pixCreateUrl;
                    N8N_PIX_CHECK_URL = n8nConfig.pixCheckUrl;
                    N8N_WEBHOOK_URL = n8nConfig.webhookUrl;
                } else {
                    throw new Error('ConfigService n√£o dispon√≠vel. Verifique se os scripts foram carregados corretamente.');
                }
            } catch (error) {
                // Em caso de erro, mostrar mensagem clara e n√£o continuar
                const errorMsg = `Erro ao carregar configura√ß√µes do banco de dados: ${error.message}`;
                console.error(errorMsg, error);
                if (window.toast && window.toast.container) {
                    window.toast.error(errorMsg);
                } else {
                    alert(errorMsg + '\n\nO sistema n√£o pode continuar sem as configura√ß√µes do banco de dados.');
                }
                throw error; // Propagar erro para que a p√°gina n√£o continue sem configura√ß√µes
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Carregar configura√ß√µes primeiro (para garantir que est√£o dispon√≠veis)
                await loadConfigurations(true); // forceRefresh = true na inicializa√ß√£o
                
                // Carregar header
                const headerResponse = await fetch('../../components/header-component.html');
                const headerHTML = await headerResponse.text();
                document.getElementById('header-container').innerHTML = headerHTML;

                // Aguardar authService
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (window.authService) {
                    authService = window.authService;
                    await checkAuth();
                    
                    // Verificar se h√° PIX pendente ANTES de carregar outras coisas
                    const hasPendingPix = await checkPendingPixPayment();
                    
                    if (!hasPendingPix) {
                        // S√≥ carregar informa√ß√µes se n√£o houver PIX pendente
                        loadAnnouncementInfo();
                        setupCalculators();
                    }
                } else {
                    if (window.toast) window.toast.error('Erro ao carregar servi√ßo de autentica√ß√£o');
                    else alert('Erro ao carregar servi√ßo de autentica√ß√£o');
                }
            } catch (error) {
            }
        });

        async function checkAuth() {
            if (!authService) {
                // Verificar token como fallback
                const tokenKey = Object.keys(localStorage).find(key => 
                    (key.includes('supabase') || key.includes('sb-')) && 
                    key.includes('auth-token')
                );
                if (tokenKey) {
                    try {
                        const tokenData = JSON.parse(localStorage.getItem(tokenKey));
                        if (tokenData && tokenData.access_token) {
                            return true;
                        }
                    } catch (e) {
                        // Ignorar
                    }
                }
                if (window.toast) window.toast.warning('Voc√™ precisa estar logado para publicar um an√∫ncio');
                else alert('Voc√™ precisa estar logado para publicar um an√∫ncio');
                window.location.href = '../../pages/auth/login.html';
                return false;
            }
            
            // Aguardar inicializa√ß√£o se necess√°rio
            if (!authService.isInitialized) {
                await authService.initialize();
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            const user = await authService.getCurrentUser();
            if (!user) {
                // Verificar token como fallback
                const tokenKey = Object.keys(localStorage).find(key => 
                    (key.includes('supabase') || key.includes('sb-')) && 
                    key.includes('auth-token')
                );
                if (tokenKey) {
                    try {
                        const tokenData = JSON.parse(localStorage.getItem(tokenKey));
                        if (tokenData && tokenData.access_token) {
                            return true;
                        }
                    } catch (e) {
                        // Ignorar
                    }
                }
                if (window.toast) window.toast.warning('Voc√™ precisa estar logado para publicar um an√∫ncio');
                else alert('Voc√™ precisa estar logado para publicar um an√∫ncio');
                window.location.href = '../../pages/auth/login.html';
                return false;
            }
            return true;
        }

        function loadAnnouncementInfo() {
            // Tentar obter dados do an√∫ncio da sess√£o ou localStorage
            const anuncioData = JSON.parse(localStorage.getItem('pendingAnnouncement') || '{}');
            
            if (anuncioData.titulo) {
                document.getElementById('announcementTitle').textContent = anuncioData.titulo;
                
                // Se √© um rascunho existente, mostrar mensagem diferente
                if (anuncioData.id && !anuncioData.id.startsWith('temp_')) {
                    const warningBox = document.getElementById('warningBox');
                    if (warningBox) {
                        warningBox.textContent = '‚ö†Ô∏è Ap√≥s o pagamento, seu rascunho ser√° publicado imediatamente.';
                    }
                }
            } else {
                document.getElementById('announcementTitle').textContent = 'Informa√ß√µes n√£o dispon√≠veis';
            }
        }

        function setupCalculators() {
            // Verificar se as configura√ß√µes foram carregadas
            if (MIN_DAYS === null || MAX_DAYS === null || DAILY_PRICE === null || HIGHLIGHT_PRICE === null || MAX_PRICE === null) {
                console.warn('Configura√ß√µes n√£o carregadas ainda. Tentando novamente...');
                setTimeout(() => {
                    if (MIN_DAYS !== null && MAX_DAYS !== null) {
                        setupCalculators();
                    }
                }, 1000);
                return;
            }
            
            const daysInput = document.getElementById('daysInput');
            const highlightCheckbox = document.getElementById('highlightCheckbox');
            const daysButtons = document.querySelectorAll('.days-btn');

            // Atualizar atributos min/max do input com valores do banco
            if (daysInput) {
                daysInput.min = MIN_DAYS;
                daysInput.max = MAX_DAYS;
            }

            // Bot√µes de dias r√°pidos
            daysButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const days = parseInt(btn.dataset.days);
                    daysInput.value = days;
                    
                    // Atualizar bot√µes ativos
                    daysButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    calculatePrice();
                });
            });

            // Input manual
            daysInput.addEventListener('input', () => {
                let value = parseInt(daysInput.value) || MIN_DAYS;
                
                if (value < MIN_DAYS) {
                    value = MIN_DAYS;
                    daysInput.value = MIN_DAYS;
                }
                if (value > MAX_DAYS) {
                    value = MAX_DAYS;
                    daysInput.value = MAX_DAYS;
                }
                
                // Atualizar bot√µes ativos
                daysButtons.forEach(btn => {
                    if (parseInt(btn.dataset.days) === parseInt(daysInput.value)) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                calculatePrice();
            });

            // Checkbox de destaque
            highlightCheckbox.addEventListener('change', () => {
                calculatePrice();
            });

            // Calcular pre√ßo inicial
            calculatePrice();
        }

        function calculatePrice() {
            // Verificar se as configura√ß√µes foram carregadas
            if (DAILY_PRICE === null || HIGHLIGHT_PRICE === null || MAX_PRICE === null || MIN_DAYS === null || MAX_DAYS === null) {
                console.warn('Configura√ß√µes n√£o carregadas. N√£o √© poss√≠vel calcular pre√ßo.');
                return;
            }
            
            let days = parseInt(document.getElementById('daysInput').value) || MIN_DAYS;
            
            // Garantir que est√° dentro dos limites
            if (days < MIN_DAYS) {
                days = MIN_DAYS;
                document.getElementById('daysInput').value = MIN_DAYS;
            }
            if (days > MAX_DAYS) {
                days = MAX_DAYS;
                document.getElementById('daysInput').value = MAX_DAYS;
            }
            
            const hasHighlight = document.getElementById('highlightCheckbox').checked;

            // L√≥gica especial: Se for 30 dias + destaque, total = R$ 150,00
            let basePrice;
            let highlightPrice = hasHighlight ? HIGHLIGHT_PRICE : 0;
            let total;
            let dailyPriceDisplay = DAILY_PRICE; // Valor por dia para exibi√ß√£o

            if (hasHighlight && days === MAX_DAYS) {
                // 30 dias + destaque = R$ 150,00 total
                // basePrice = 150 - 8.90 = 141.10
                basePrice = MAX_PRICE - HIGHLIGHT_PRICE; // 150.00 - 8.90 = 141.10
                total = MAX_PRICE; // R$ 150,00
                // Valor por dia ajustado: 141.10 / 30 = 4.703333... ‚âà R$ 4,70
                dailyPriceDisplay = basePrice / days; // R$ 4,70 por dia
            } else {
                // C√°lculo normal
                basePrice = Math.min(days * DAILY_PRICE, MAX_PRICE); // N√£o ultrapassar m√°ximo
                total = basePrice + highlightPrice;
                dailyPriceDisplay = DAILY_PRICE; // R$ 5,00 por dia
            }

            // Atualizar exibi√ß√£o
            document.getElementById('dailyPrice').textContent = formatCurrency(dailyPriceDisplay);
            document.getElementById('daysSelected').textContent = `${days} ${days === 1 ? 'dia' : 'dias'}`;
            
            if (hasHighlight) {
                document.getElementById('highlightRow').style.display = 'flex';
                document.getElementById('highlightPrice').textContent = formatCurrency(highlightPrice);
            } else {
                document.getElementById('highlightRow').style.display = 'none';
            }

            document.getElementById('totalPrice').textContent = formatCurrency(total);
        }

        function formatCurrency(value) {
            return `R$ ${value.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;
        }

        async function processPayment() {
            try {
                if (!await checkAuth()) return;

                const btnPay = document.getElementById('btnPay');
                btnPay.disabled = true;
                btnPay.textContent = '‚è≥ Processando...';

                let days = parseInt(document.getElementById('daysInput').value) || MIN_DAYS;
                
                // Garantir que est√° dentro dos limites
                if (days < MIN_DAYS) {
                    days = MIN_DAYS;
                    document.getElementById('daysInput').value = MIN_DAYS;
                }
                if (days > MAX_DAYS) {
                    days = MAX_DAYS;
                    document.getElementById('daysInput').value = MAX_DAYS;
                }
                
                const hasHighlight = document.getElementById('highlightCheckbox').checked;
                const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

                // Calcular valores
                // L√≥gica especial: Se for 30 dias + destaque, total = R$ 150,00
                let basePrice;
                let highlightPrice = hasHighlight ? HIGHLIGHT_PRICE : 0;
                let total;

                if (hasHighlight && days === MAX_DAYS) {
                    // 30 dias + destaque = R$ 150,00 total
                    basePrice = MAX_PRICE - HIGHLIGHT_PRICE; // 150.00 - 8.90 = 141.10
                    total = MAX_PRICE; // R$ 150,00
                } else {
                    // C√°lculo normal
                    basePrice = Math.min(days * DAILY_PRICE, MAX_PRICE); // N√£o ultrapassar m√°ximo
                    total = basePrice + highlightPrice;
                }

                // Obter dados do an√∫ncio do localStorage
                const anuncioData = JSON.parse(localStorage.getItem('pendingAnnouncement') || '{}');
                
                if (!anuncioData || !anuncioData.dados) {
                    throw new Error('Dados do an√∫ncio n√£o encontrados');
                }

                // Obter dados do usu√°rio e an√∫ncio
                const supabase = authService.getSupabase();
                if (!supabase) {
                    throw new Error('Supabase n√£o dispon√≠vel');
                }

                const user = await authService.getCurrentUser();
                if (!user) {
                    throw new Error('Usu√°rio n√£o logado');
                }

                const dadosCompletos = anuncioData.dados || {};
                
                // Verificar se √© um an√∫ncio existente (rascunho) ou novo
                // Se anuncioData.id existe e √© um UUID v√°lido (n√£o temp_), √© um rascunho existente
                let anuncioId = anuncioData.id;
                const isRascunhoExistente = anuncioId && 
                                           typeof anuncioId === 'string' && 
                                           !anuncioId.startsWith('temp_') && 
                                           anuncioId.length > 10;
                
                // Preparar dados do an√∫ncio
                const anuncioDataDB = {
                    usuario_id: user.id,
                    titulo: dadosCompletos.titulo,
                    descricao: dadosCompletos.descricao,
                    tipo_imovel: dadosCompletos.tipo,
                    categoria: dadosCompletos.categoria,
                    valor: dadosCompletos.preco,
                    endereco: dadosCompletos.localizacao || '',
                    bairro: null,
                    cidade: 'Ilha',
                    estado: 'BA',
                    cep: null,
                    area_terreno: null,
                    area_construida: null,
                    quartos: dadosCompletos.quartos || null,
                    banheiros: dadosCompletos.banheiros || null,
                    vagas_garagem: dadosCompletos.vagasGaragem || null,
                    emoji: dadosCompletos.emoji || null,
                    caracteristicas: dadosCompletos.caracteristicas || [],
                    // Nota: imagens n√£o √© uma coluna direta na tabela anuncios
                    // As imagens s√£o armazenadas em outra estrutura ou tabela relacionada
                    ativo: false, // Ainda n√£o publicado
                    status: 'pendente_pagamento' // Aguardando pagamento
                };

                // Criar ou atualizar an√∫ncio no banco de dados
                if (isRascunhoExistente) {
                    // √â um rascunho existente, fazer UPDATE
                    const { data: updatedData, error: updateError } = await supabase
                        .from('anuncios')
                        .update(anuncioDataDB)
                        .eq('id', anuncioId)
                        .select()
                        .single();

                    if (updateError || !updatedData) {
                        throw new Error('Erro ao atualizar an√∫ncio: ' + (updateError?.message || 'Erro desconhecido'));
                    }

                    anuncioId = updatedData.id;

                    // Atualizar imagens: remover as antigas e inserir as novas
                    if (dadosCompletos.imagens && Array.isArray(dadosCompletos.imagens)) {
                        try {
                            // Remover imagens antigas deste an√∫ncio
                            await supabase
                                .from('imagens_anuncio')
                                .delete()
                                .eq('anuncio_id', anuncioId);

                            // Inserir novas imagens (se houver)
                            if (dadosCompletos.imagens.length > 0) {
                                const imagensData = dadosCompletos.imagens.map((url, index) => ({
                                    anuncio_id: anuncioId,
                                    url: url,
                                    ordem: index,
                                    principal: index === 0 // Primeira imagem √© principal
                                }));

                                const { error: imagensError } = await supabase
                                    .from('imagens_anuncio')
                                    .insert(imagensData);

                                if (imagensError) {
                                    console.warn('Aviso: Erro ao atualizar imagens:', imagensError.message);
                                }
                            }
                        } catch (imagensError) {
                            console.warn('Aviso: Erro ao processar imagens:', imagensError);
                        }
                    }
                } else {
                    // √â um novo an√∫ncio, fazer INSERT
                    const { data: insertedData, error: insertError } = await supabase
                        .from('anuncios')
                        .insert([anuncioDataDB])
                        .select()
                        .single();

                    if (insertError || !insertedData) {
                        throw new Error('Erro ao criar an√∫ncio: ' + (insertError?.message || 'Erro desconhecido'));
                    }

                    anuncioId = insertedData.id;

                    // Salvar imagens na tabela imagens_anuncio (se houver imagens)
                    if (dadosCompletos.imagens && Array.isArray(dadosCompletos.imagens) && dadosCompletos.imagens.length > 0) {
                        try {
                            // Preparar dados das imagens para inser√ß√£o
                            const imagensData = dadosCompletos.imagens.map((url, index) => ({
                                anuncio_id: anuncioId,
                                url: url,
                                ordem: index,
                                principal: index === 0 // Primeira imagem √© principal
                            }));

                            // Inserir todas as imagens de uma vez
                            const { error: imagensError } = await supabase
                                .from('imagens_anuncio')
                                .insert(imagensData);

                            if (imagensError) {
                                // N√£o √© cr√≠tico se falhar, mas logar o erro
                                console.warn('Aviso: Erro ao salvar imagens:', imagensError.message);
                            }
                        } catch (imagensError) {
                            // N√£o √© cr√≠tico se falhar, apenas logar
                            console.warn('Aviso: Erro ao processar imagens:', imagensError);
                        }
                    }
                }

                // Converter valor para centavos (PushinPay usa centavos)
                const valorCentavos = Math.round(total * 100);

                // Recarregar configura√ß√µes antes de criar PIX para garantir valor atualizado
                await loadConfigurations(true); // forceRefresh = true
                
                // Validar que as configura√ß√µes foram carregadas
                if (!PUSHINPAY_API_KEY || !N8N_PIX_CREATE_URL) {
                    throw new Error('Configura√ß√µes de pagamento n√£o foram carregadas do banco de dados.');
                }

                // Criar PIX no PushinPay via n8n (proxy para evitar CORS)
                const pixResponse = await fetch(N8N_PIX_CREATE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        api_key: PUSHINPAY_API_KEY,
                        value: valorCentavos, // Valor em centavos
                        anuncio_id: anuncioId // ID do an√∫ncio para salvar transaction_id no banco
                    })
                });

                if (!pixResponse.ok) {
                    const errorData = await pixResponse.json().catch(() => ({ message: 'Erro desconhecido' }));
                    throw new Error('Erro ao criar PIX: ' + (errorData.message || `Status ${pixResponse.status}`));
                }

                const pixResult = await pixResponse.json();

                // Estrutura da resposta pode ser:
                // 1. Array: [{ data: {...}, success: true }]
                // 2. Objeto direto: { id, qr_code, qr_code_base64, ... }
                // 3. Objeto com data: { data: { id, qr_code, ... }, success: true }
                
                let resultData;
                
                if (Array.isArray(pixResult)) {
                    // Se for array, pegar o primeiro elemento
                    const firstItem = pixResult[0];
                    if (firstItem && firstItem.data) {
                        resultData = firstItem.data;
                    } else if (firstItem) {
                        resultData = firstItem;
                    }
                } else if (pixResult.data) {
                    // Se tem data, usar data
                    resultData = pixResult.data;
                } else {
                    // Se n√£o tem data, usar o objeto direto
                    resultData = pixResult;
                }

                // Verificar se houve erro na resposta
                if (resultData.error || (pixResult.error && !resultData)) {
                    throw new Error(resultData.error || pixResult.error || 'Erro ao criar PIX');
                }

                if (!resultData) {
                    throw new Error('Dados do PIX n√£o encontrados na resposta');
                }

                // Estrutura esperada: { id, qr_code, status: "created", value, qr_code_base64, anuncio_id }
                // IMPORTANTE: transaction_id vem em MINUSCULA do n8n e deve ser salvo assim
                let transactionId = resultData.id;
                const pixCode = resultData.qr_code;
                const qrCodeBase64 = resultData.qr_code_base64;
                
                if (!transactionId) {
                    throw new Error('ID da transa√ß√£o n√£o encontrado na resposta');
                }
                
                // GARANTIR que transaction_id est√° em MINUSCULA antes de salvar
                transactionId = String(transactionId).toLowerCase();
                
                if (!pixCode) {
                    throw new Error('QR Code n√£o encontrado na resposta');
                }
                
                // Salvar ID da transa√ß√£o no an√∫ncio (status pendente)
                // IMPORTANTE: Salvar em MINUSCULA para manter consist√™ncia
                try {
                    const { error: updateError } = await supabase
                        .from('anuncios')
                        .update({
                            transacao_id: transactionId, // Garantido em MINUSCULA
                            status: 'pendente_pagamento'
                        })
                        .eq('id', anuncioId);
                    
                    if (updateError) {
                        throw new Error('Erro ao salvar ID da transa√ß√£o no banco: ' + updateError.message);
                    }
                } catch (e) {
                    throw new Error('Erro ao salvar ID da transa√ß√£o no banco: ' + (e.message || 'Erro desconhecido'));
                }

                // Armazenar dados globalmente para verifica√ß√£o de status
                currentPixId = transactionId;
                
                // Salvar no localStorage para persistir entre recarregamentos
                const pixPendingData = {
                    transactionId: transactionId,
                    anuncioId: anuncioId, // IMPORTANTE: Salvar anuncioId para usar como fallback
                    paymentData: {
                        days,
                        total,
                        basePrice,
                        highlightPrice,
                        hasHighlight,
                        user: user.id,
                        anuncioId: anuncioId // Adicionar anuncioId para usar como fallback
                    },
                    pixCode: pixCode,
                    qrCodeBase64: qrCodeBase64,
                    timestamp: Date.now()
                };
                localStorage.setItem('pixPendingPayment', JSON.stringify(pixPendingData));
                
                // Esconder calculadora e resumo, mostrar apenas PIX
                document.getElementById('calculatorSection').style.display = 'none';
                document.getElementById('summarySection').style.display = 'none';
                
                // Exibir QR Code na tela
                // Usar qr_code_base64 para imagem e qr_code para copiar
                displayPixQrCode(pixCode, qrCodeBase64, total);
                
                // Iniciar verifica√ß√£o de pagamento
                startPixCheck(transactionId, anuncioId, {
                    days,
                    total,
                    basePrice,
                    highlightPrice,
                    hasHighlight,
                    user: user.id,
                    anuncioId: anuncioId // Adicionar anuncioId para usar como fallback
                });

            } catch (error) {
                if (window.toast) window.toast.error('Erro ao processar pagamento: ' + error.message);
                else alert('Erro ao processar pagamento: ' + error.message);
                
                const btnPay = document.getElementById('btnPay');
                btnPay.disabled = false;
                btnPay.textContent = 'üí≥ Gerar PIX';
            }
        }

        // Exibir QR Code do PIX
        function displayPixQrCode(pixCode, qrCodeBase64, valor) {
            // Criar overlay se n√£o existir
            let overlay = document.getElementById('pixOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'pixOverlay';
                overlay.onclick = cancelPixPayment; // Fechar ao clicar no overlay
                document.body.appendChild(overlay);
            }
            
            // Mostrar overlay e se√ß√£o PIX
            overlay.style.display = 'block';
            document.getElementById('pixSection').style.display = 'block';
            
            // Esconder bot√£o de pagamento
            document.getElementById('btnPay').style.display = 'none';
            
            // Preencher c√≥digo PIX (Copia e Cola)
            document.getElementById('pixCode').value = pixCode;
            
            // Preencher valor
            document.getElementById('pixValue').textContent = formatCurrency(valor);
            
            // Exibir QR Code visual
            const qrcodeCanvas = document.getElementById('qrcodeCanvas');
            const qrcodeImage = document.getElementById('qrcodeImage');
            
            // Sempre tentar usar qr_code_base64 primeiro (melhor qualidade)
            if (qrCodeBase64) {
                // Se j√° tem prefixo data:image, usar direto
                if (qrCodeBase64.startsWith('data:image')) {
                    qrcodeImage.src = qrCodeBase64;
                    qrcodeCanvas.style.display = 'none';
                    qrcodeImage.style.display = 'block';
                } else {
                    // Se n√£o tem prefixo, adicionar (assumindo PNG)
                    qrcodeImage.src = `data:image/png;base64,${qrCodeBase64}`;
                    qrcodeCanvas.style.display = 'none';
                    qrcodeImage.style.display = 'block';
                }
            } else {
                // Fallback: Se n√£o temos base64, gerar QR code do pixCode usando a biblioteca
                qrcodeCanvas.style.display = 'block';
                qrcodeImage.style.display = 'none';
                
                // Limpar canvas anterior
                const ctx = qrcodeCanvas.getContext('2d');
                ctx.clearRect(0, 0, qrcodeCanvas.width, qrcodeCanvas.height);
                
                // Gerar QR code
                if (typeof QRCode !== 'undefined') {
                    QRCode.toCanvas(qrcodeCanvas, pixCode, {
                        width: 300,
                        margin: 2,
                        color: {
                            dark: '#000000',
                            light: '#FFFFFF'
                        }
                    }, (error) => {
                        if (error) {
                            console.error('Erro ao gerar QR code:', error);
                            // Se falhar, mostrar mensagem
                            if (window.toast && window.toast.container) {
                                try {
                                    window.toast.warning('QR Code gerado, mas imagem n√£o p√¥de ser exibida. Use o c√≥digo PIX para copiar.');
                                } catch (e) {
                                    // Ignorar erro do toast
                                }
                            }
                        }
                    });
                } else {
                    console.warn('Biblioteca QRCode n√£o dispon√≠vel. Exibindo apenas c√≥digo PIX.');
                }
            }
            
            // Scroll para se√ß√£o PIX
            document.getElementById('pixSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Copiar c√≥digo PIX
        function copyPixCode() {
            const pixCodeInput = document.getElementById('pixCode');
            pixCodeInput.select();
            pixCodeInput.setSelectionRange(0, 99999); // Para mobile
            
            try {
                document.execCommand('copy');
                const btnCopy = document.getElementById('btnCopyPix');
                const originalText = btnCopy.textContent;
                btnCopy.textContent = '‚úÖ Copiado!';
                btnCopy.style.background = '#28a745';
                
                setTimeout(() => {
                    btnCopy.textContent = originalText;
                    btnCopy.style.background = '#0077B6';
                }, 2000);
            } catch (err) {
                if (window.toast) window.toast.error('Erro ao copiar. Por favor, copie manualmente.');
                else alert('Erro ao copiar. Por favor, copie manualmente.');
            }
        }

        // Verificar status do pagamento PIX via n8n (proxy para evitar CORS)
        async function checkPixStatus(transactionId) {
            try {
                // Recarregar configura√ß√µes antes de verificar status para garantir API key correta
                await loadConfigurations(true); // forceRefresh = true
                
                // Validar que as configura√ß√µes foram carregadas
                if (!PUSHINPAY_API_KEY || !N8N_PIX_CHECK_URL) {
                    throw new Error('Configura√ß√µes de pagamento n√£o foram carregadas do banco de dados.');
                }
                
                const response = await fetch(N8N_PIX_CHECK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        api_key: PUSHINPAY_API_KEY,
                        transaction_id: String(transactionId).toLowerCase() // Garantir MINUSCULA
                    })
                });

                if (!response.ok) {
                    throw new Error('Erro ao verificar status do PIX');
                }

                const pixData = await response.json();
                
                // Estrutura da resposta do n8n pode ser:
                // 1. Array: [{ data: {...}, success: true }]
                // 2. Objeto direto: { data: {...}, success: true }
                // 3. Objeto com data: { data: { status: "paid", ... }, success: true }
                
                let resultData;
                
                if (Array.isArray(pixData)) {
                    // Se for array, pegar o primeiro elemento
                    const firstItem = pixData[0];
                    if (firstItem && firstItem.data) {
                        resultData = firstItem.data;
                    } else if (firstItem) {
                        resultData = firstItem;
                    }
                } else if (pixData.data) {
                    // Se tem data, usar data
                    resultData = pixData.data;
                } else {
                    // Se n√£o tem data, usar o objeto direto
                    resultData = pixData;
                }
                
                // Verificar se houve erro
                if (resultData && resultData.error) {
                    return { paid: false, status: 'error', data: null };
                }
                
                if (!resultData) {
                    return { paid: false, status: 'error', data: null };
                }
                
                // Verificar status conforme estrutura real da API
                // Status poss√≠veis: "created", "paid"
                const status = resultData.status;
                const isPaid = status === 'paid';
                
                return {
                    paid: isPaid,
                    status: status,
                    data: resultData
                };
            } catch (error) {
                console.error('Erro ao verificar status do PIX:', error);
                return { paid: false, status: 'error', data: null, error: error.message };
            }
        }

        // Verificar se h√° PIX pendente no localStorage
        async function checkPendingPixPayment() {
            try {
                const pixPendingStr = localStorage.getItem('pixPendingPayment');
                if (!pixPendingStr) {
                    return false; // N√£o h√° PIX pendente
                }

                const pixPendingData = JSON.parse(pixPendingStr);
                
                // Verificar se o PIX ainda √© v√°lido (n√£o expirou h√° mais de 15 minutos)
                const now = Date.now();
                const pixAge = now - pixPendingData.timestamp;
                const maxAge = 15 * 60 * 1000; // 15 minutos
                
                if (pixAge > maxAge) {
                    // PIX expirado, limpar localStorage
                    localStorage.removeItem('pixPendingPayment');
                    return false;
                }

                // Verificar status do pagamento
                // IMPORTANTE: transaction_id est√° em MINUSCULA no banco
                const transactionIdUpper = String(pixPendingData.transactionId).toLowerCase();
                const result = await checkPixStatus(transactionIdUpper);
                
                if (result.paid) {
                    // Pagamento confirmado! Processar e limpar localStorage
                    try {
                        await atualizarAnuncioAposPagamento(transactionIdUpper, pixPendingData.paymentData);
                    } catch (updateError) {
                        console.error('Erro ao atualizar an√∫ncio ap√≥s pagamento:', updateError);
                        // Tentar usar anuncioId do localStorage como fallback
                        if (pixPendingData.anuncioId) {
                            try {
                                const supabase = authService.getSupabase();
                                if (supabase) {
                                    const diasPublicacao = pixPendingData.paymentData.days || 7;
                                    const agora = new Date();
                                    const dataInicio = agora.toISOString();
                                    const dataFim = new Date(agora);
                                    dataFim.setDate(dataFim.getDate() + diasPublicacao);
                                    
                                    await supabase
                                        .from('anuncios')
                                        .update({
                                            status: 'publicado',
                                            ativo: true,
                                            data_inicio_publicacao: dataInicio,
                                            data_fim_publicacao: dataFim.toISOString(),
                                            dias_publicacao: diasPublicacao,
                                            valor_pagamento: pixPendingData.paymentData.total,
                                            forma_pagamento: 'pix',
                                            em_destaque: pixPendingData.paymentData.hasHighlight || false
                                        })
                                        .eq('id', pixPendingData.anuncioId);
                                }
                            } catch (fallbackError) {
                                console.error('Erro no fallback:', fallbackError);
                            }
                        }
                    }
                    
                    // Limpar localStorage
                    localStorage.removeItem('pixPendingPayment');
                    
                    // Mostrar mensagem e redirecionar
                    if (window.toast && window.toast.container) {
                        try {
                            window.toast.success('‚úÖ Pagamento confirmado! Seu an√∫ncio foi publicado com sucesso.');
                        } catch (e) {
                            // Ignorar erro do toast
                        }
                    }
                    
                    setTimeout(() => {
                        window.location.href = '../../pages/user/meus-anuncios.html';
                    }, 2000);
                    
                    return true;
                } else {
                    // Pagamento ainda n√£o confirmado, mostrar tela PIX
                    document.getElementById('calculatorSection').style.display = 'none';
                    document.getElementById('summarySection').style.display = 'none';
                    
                    // Criar overlay se n√£o existir
                    let overlay = document.getElementById('pixOverlay');
                    if (!overlay) {
                        overlay = document.createElement('div');
                        overlay.id = 'pixOverlay';
                        overlay.onclick = cancelPixPayment; // Fechar ao clicar no overlay
                        document.body.appendChild(overlay);
                    }
                    overlay.style.display = 'block';
                    document.getElementById('pixSection').style.display = 'block';
                    
                    // Restaurar dados do PIX (sem chamar displayPixQrCode para evitar duplicar overlay)
                    document.getElementById('pixCode').value = pixPendingData.pixCode;
                    document.getElementById('pixValue').textContent = formatCurrency(pixPendingData.paymentData.total);
                    
                    // Exibir QR Code visual
                    const qrcodeCanvas = document.getElementById('qrcodeCanvas');
                    const qrcodeImage = document.getElementById('qrcodeImage');
                    
                    if (pixPendingData.qrCodeBase64) {
                        if (pixPendingData.qrCodeBase64.startsWith('data:image')) {
                            qrcodeImage.src = pixPendingData.qrCodeBase64;
                        } else {
                            qrcodeImage.src = `data:image/png;base64,${pixPendingData.qrCodeBase64}`;
                        }
                        qrcodeCanvas.style.display = 'none';
                        qrcodeImage.style.display = 'block';
                    }
                    
                    // Iniciar verifica√ß√£o de pagamento
                    currentPixId = pixPendingData.transactionId;
                    startPixCheck(pixPendingData.transactionId, pixPendingData.anuncioId, pixPendingData.paymentData);
                    
                    return true;
                }
            } catch (error) {
                console.error('Erro ao verificar PIX pendente:', error);
                // Em caso de erro, limpar localStorage e mostrar tela normal
                localStorage.removeItem('pixPendingPayment');
                return false;
            }
        }

        // Iniciar verifica√ß√£o peri√≥dica do pagamento
        function startPixCheck(transactionId, anuncioId, paymentData) {
            // Atualizar status inicial
            document.getElementById('pixStatus').textContent = '‚è≥ Aguardando pagamento...';
            document.getElementById('pixStatus').style.color = '#ff9800';
            
            // Fun√ß√£o para verificar pagamento
            const checkPayment = async () => {
                try {
                    const result = await checkPixStatus(transactionId);
                    
                    if (result.paid) {
                        // Pagamento confirmado! PARAR IMEDIATAMENTE de verificar
                        if (pixCheckInterval) {
                            clearInterval(pixCheckInterval);
                            pixCheckInterval = null;
                        }
                        
                        // Atualizar status visual
                        document.getElementById('pixStatus').textContent = '‚úÖ Pagamento confirmado!';
                        document.getElementById('pixStatus').style.color = '#28a745';
                        
                        // IMPORTANTE: Garantir que transactionId est√° em MINUSCULA
                        const transactionIdUpper = String(transactionId).toLowerCase();
                        
                        // Atualizar an√∫ncio diretamente no banco de dados (ap√≥s parar verifica√ß√£o)
                        let atualizacaoSucesso = false;
                        try {
                            await atualizarAnuncioAposPagamento(transactionIdUpper, paymentData);
                            atualizacaoSucesso = true;
                        } catch (updateError) {
                            console.error('Erro ao atualizar an√∫ncio ap√≥s pagamento:', updateError);
                            // Tentar usar anuncioId do paymentData como fallback
                            if (paymentData.anuncioId) {
                                try {
                                    const supabase = authService.getSupabase();
                                    if (supabase) {
                                        const diasPublicacao = paymentData.days || 7;
                                        const agora = new Date();
                                        const dataInicio = agora.toISOString();
                                        const dataFim = new Date(agora);
                                        dataFim.setDate(dataFim.getDate() + diasPublicacao);
                                        
                                        await supabase
                                            .from('anuncios')
                                            .update({
                                                status: 'publicado',
                                                ativo: true,
                                                data_inicio_publicacao: dataInicio,
                                                data_fim_publicacao: dataFim.toISOString(),
                                                dias_publicacao: diasPublicacao,
                                                valor_pagamento: paymentData.total,
                                                forma_pagamento: 'pix',
                                                em_destaque: paymentData.hasHighlight || false
                                            })
                                            .eq('id', paymentData.anuncioId);
                                        atualizacaoSucesso = true;
                                    }
                                } catch (fallbackError) {
                                    console.error('Erro no fallback:', fallbackError);
                                }
                            }
                        }
                        
                        // Limpar localStorage ap√≥s pagamento confirmado
                        localStorage.removeItem('pixPendingPayment');
                        
                        // Esconder overlay e se√ß√£o PIX
                        const overlay = document.getElementById('pixOverlay');
                        if (overlay) {
                            overlay.style.display = 'none';
                        }
                        document.getElementById('pixSection').style.display = 'none';
                        
                        // Mostrar mensagem de sucesso e redirecionar (mesmo se atualiza√ß√£o falhou)
                        if (window.toast && window.toast.container) {
                            try {
                                if (atualizacaoSucesso) {
                                    window.toast.success('‚úÖ Pagamento confirmado! Seu an√∫ncio foi publicado com sucesso.');
                                } else {
                                    window.toast.warning('‚úÖ Pagamento confirmado! Mas houve um problema ao atualizar o an√∫ncio. Entre em contato com o suporte.');
                                }
                            } catch (e) {
                                // Fallback
                            }
                        }
                        
                        // Redirecionar ap√≥s 2 segundos (sempre redirecionar, mesmo se atualiza√ß√£o falhou)
                        setTimeout(() => {
                            window.location.href = '../../pages/user/meus-anuncios.html';
                        }, 2000);
                    } else if (result.status === 'error') {
                        // Erro na verifica√ß√£o, continuar tentando
                    } else {
                        // Ainda n√£o pago, continuar verificando
                    }
                } catch (error) {
                    console.error('Erro ao verificar status do PIX:', error);
                    // Continuar tentando mesmo em caso de erro
                }
            };
            
            // Verificar imediatamente (n√£o esperar 10 segundos)
            checkPayment();
            
            // Verificar a cada 10 segundos (ajustado de 3 para 10)
            pixCheckInterval = setInterval(checkPayment, 10000);
            
            // Parar ap√≥s 15 minutos (seguran√ßa)
            setTimeout(() => {
                if (pixCheckInterval) {
                    clearInterval(pixCheckInterval);
                    pixCheckInterval = null;
                    document.getElementById('pixStatus').textContent = '‚è∞ Tempo esgotado. Gere um novo PIX.';
                    document.getElementById('pixStatus').style.color = '#dc3545';
                }
            }, 15 * 60 * 1000); // 15 minutos
        }

        // Atualizar an√∫ncio diretamente no banco de dados ap√≥s pagamento confirmado
        async function atualizarAnuncioAposPagamento(transactionId, paymentData) {
            try {
                // Obter cliente Supabase
                const supabase = authService.getSupabase();
                if (!supabase) {
                    throw new Error('Supabase n√£o dispon√≠vel');
                }

                // IMPORTANTE: transaction_id est√° em MINUSCULA no banco
                const transactionIdUpper = String(transactionId).toLowerCase();
                
                // Buscar an√∫ncio pelo transaction_id
                const { data: anuncioEncontrado, error: buscaError } = await supabase
                    .from('anuncios')
                    .select('id, dias_publicacao, transacao_id')
                    .eq('transacao_id', transactionIdUpper)
                    .single();

                if (buscaError || !anuncioEncontrado) {
                    // Estrat√©gia 2: Tentar buscar sem converter para MINUSCULA
                    const { data: anuncioEncontrado2, error: buscaError2 } = await supabase
                        .from('anuncios')
                        .select('id, dias_publicacao, transacao_id')
                        .eq('transacao_id', transactionId)
                        .maybeSingle();
                    
                    if (anuncioEncontrado2 && !buscaError2) {
                        anuncioEncontrado = anuncioEncontrado2;
                    } else {
                        // Estrat√©gia 3: Tentar buscar usando ILIKE (case insensitive)
                        const { data: anuncioEncontrado3, error: buscaError3 } = await supabase
                            .from('anuncios')
                            .select('id, dias_publicacao, transacao_id')
                            .ilike('transacao_id', `%${transactionIdUpper}%`)
                            .maybeSingle();
                        
                        if (anuncioEncontrado3 && !buscaError3) {
                            anuncioEncontrado = anuncioEncontrado3;
                        } else {
                            // Estrat√©gia 4: Se n√£o encontrar, usar anuncioId do paymentData (se dispon√≠vel)
                            // Isso pode acontecer se o transaction_id n√£o foi salvo corretamente
                            throw new Error(`An√∫ncio n√£o encontrado com transaction_id: ${transactionIdUpper}. Tente novamente ou entre em contato com o suporte.`);
                        }
                    }
                }

                if (!anuncioEncontrado) {
                    throw new Error('An√∫ncio n√£o encontrado com o transaction_id fornecido');
                }

                const anuncioId = anuncioEncontrado.id;
                const diasPublicacao = paymentData.days || anuncioEncontrado.dias_publicacao || 7;

                // Calcular datas
                const agora = new Date();
                const dataInicio = agora.toISOString();
                
                // Data de fim = agora + dias de publica√ß√£o
                const dataFim = new Date(agora);
                dataFim.setDate(dataFim.getDate() + diasPublicacao);
                const dataFimISO = dataFim.toISOString();

                // Se tiver destaque, calcular data de fim do destaque (3 dias)
                let dataFimDestaque = null;
                if (paymentData.hasHighlight) {
                    const dataFimDestaqueCalc = new Date(agora);
                    dataFimDestaqueCalc.setDate(dataFimDestaqueCalc.getDate() + 3);
                    dataFimDestaque = dataFimDestaqueCalc.toISOString();
                }

                // Preparar dados para atualiza√ß√£o
                const dadosAtualizacao = {
                    status: 'publicado',
                    ativo: true,
                    data_inicio_publicacao: dataInicio,
                    data_fim_publicacao: dataFimISO,
                    dias_publicacao: diasPublicacao,
                    valor_pagamento: paymentData.total,
                    forma_pagamento: 'pix',
                    em_destaque: paymentData.hasHighlight || false
                };

                // Adicionar data de fim do destaque se aplic√°vel
                if (dataFimDestaque) {
                    dadosAtualizacao.data_fim_destaque = dataFimDestaque;
                }

                // Atualizar an√∫ncio no banco
                const { error: updateError } = await supabase
                    .from('anuncios')
                    .update(dadosAtualizacao)
                    .eq('id', anuncioId);

                if (updateError) {
                    throw new Error('Erro ao atualizar an√∫ncio: ' + updateError.message);
                }

                // Criar registro na tabela de pagamentos (se existir)
                try {
                    const { error: pagamentoError } = await supabase
                        .from('pagamentos_anuncio')
                        .insert({
                            anuncio_id: anuncioId,
                            usuario_id: paymentData.user,
                            valor_total: paymentData.total,
                            valor_publicacao: paymentData.basePrice,
                            valor_destaque: paymentData.highlightPrice || 0,
                            dias_publicacao: diasPublicacao,
                            dias_destaque: paymentData.hasHighlight ? 3 : 0,
                            forma_pagamento: 'pix',
                            status_pagamento: 'aprovado',
                            transacao_id: String(transactionId).toLowerCase(), // Garantir MINUSCULA
                            gateway_pagamento: 'pushinpay',
                            aprovado_em: agora.toISOString()
                        });

                    // Se a tabela n√£o existir, n√£o √© cr√≠tico (apenas logar)
                    if (pagamentoError && !pagamentoError.message.includes('does not exist')) {
                        // N√£o lan√ßar erro, apenas logar (opcional)
                    }
                } catch (pagamentoError) {
                    // Tabela de pagamentos pode n√£o existir, n√£o √© cr√≠tico
                }

            } catch (error) {
                // Em caso de erro, tentar novamente ou logar
                throw new Error('Erro ao atualizar an√∫ncio ap√≥s pagamento: ' + error.message);
            }
        }

        // Cancelar pagamento PIX
        function cancelPixPayment() {
            if (pixCheckInterval) {
                clearInterval(pixCheckInterval);
                pixCheckInterval = null;
            }
            
            // Limpar localStorage do PIX pendente (mas preservar dados do an√∫ncio)
            localStorage.removeItem('pixPendingPayment');
            
            currentPixId = null;
            
            // Esconder overlay e se√ß√£o PIX
            const overlay = document.getElementById('pixOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
            document.getElementById('pixSection').style.display = 'none';
            
            // Recarregar a p√°gina para resetar tudo, mas preservando dados do an√∫ncio
            // O localStorage 'pendingAnnouncement' ser√° mantido para o processo continuar
            window.location.reload();
        }
    </script>
</body>
</html>
