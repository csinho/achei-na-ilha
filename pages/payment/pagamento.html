<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento - Achei na Ilha</title>
    <link rel="icon" type="image/svg+xml" href="../../assets/images/logo-achei-na-ilha.png">
    <link rel="alternate icon" href="../../assets/images/logo-achei-na-ilha.png">
    <link rel="stylesheet" href="../../assets/css/header.css">
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding-bottom: 40px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .page-title {
            text-align: center;
            color: #333;
            margin-bottom: 40px;
        }

        .page-title h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .page-title p {
            color: #666;
            font-size: 16px;
        }

        .payment-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .calculator-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .summary-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 100px;
            height: fit-content;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .days-input-wrapper {
            position: relative;
        }

        .days-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            transition: border-color 0.3s;
        }

        .days-input:focus {
            outline: none;
            border-color: #0077B6;
        }

        .days-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .days-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .days-btn:hover {
            border-color: #0077B6;
            color: #0077B6;
        }

        .days-btn.recommended {
            background: #e3f2fd;
            border-color: #0077B6;
            color: #0077B6;
        }

        .days-btn.active {
            background: #0077B6;
            color: white;
            border-color: #0077B6;
        }

        .days-help {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            font-style: italic;
        }

        .highlight-option {
            margin-top: 30px;
            padding: 20px;
            background: #fff9e6;
            border: 2px solid #ffd700;
            border-radius: 8px;
        }

        .highlight-option label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
            color: #333;
        }

        .highlight-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }

        .highlight-info {
            margin-top: 10px;
            font-size: 13px;
            color: #666;
            padding-left: 32px;
        }

        .price-breakdown {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .price-row:last-child {
            border-bottom: none;
        }

        .price-label {
            color: #666;
            font-size: 14px;
        }

        .price-value {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .price-total {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #0077B6;
        }

        .price-total .price-label {
            font-size: 18px;
            color: #333;
            font-weight: 600;
        }

        .price-total .price-value {
            font-size: 24px;
            color: #0077B6;
        }

        .announcement-info {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
        }

        .announcement-info h4 {
            color: #2e7d32;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .announcement-info p {
            color: #666;
            font-size: 13px;
            line-height: 1.5;
        }

        .payment-methods {
            margin-top: 30px;
        }

        .payment-method {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-method:hover {
            border-color: #0077B6;
        }

        .payment-method input[type="radio"] {
            margin-right: 12px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .payment-method label {
            flex: 1;
            cursor: pointer;
            font-weight: 500;
            color: #333;
            margin: 0;
        }

        .payment-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .btn-pay {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .btn-pay:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .btn-pay:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 13px;
            color: #856404;
        }

        /* Estilos para se√ß√£o PIX */
        #pixSection {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #pixCode {
            word-break: break-all;
        }

        .pix-success {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
        }

        .pix-success h3 {
            color: #155724;
            margin-bottom: 10px;
        }

        .pix-success p {
            color: #155724;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .payment-wrapper {
                grid-template-columns: 1fr;
            }

            .summary-section {
                position: relative;
                top: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header-container"></div>

    <div class="container">
        <div class="page-title">
            <h1>üí∞ Pagamento do An√∫ncio</h1>
            <p>Escolha a dura√ß√£o e personalize seu an√∫ncio</p>
        </div>

        <div class="payment-wrapper">
            <!-- Calculadora -->
            <div class="calculator-section">
                <h2 class="section-title">üìä Calculadora de Pre√ßo</h2>

                <div class="form-group">
                    <label>Quantidade de Dias</label>
                    <div class="days-input-wrapper">
                        <input 
                            type="number" 
                            id="daysInput" 
                            class="days-input" 
                            min="3" 
                            value="7"
                            required
                        >
                    </div>
                    <div class="days-buttons">
                        <button type="button" class="days-btn" data-days="3">M√≠nimo (3 dias)</button>
                        <button type="button" class="days-btn recommended active" data-days="7">Recomendado (7 dias)</button>
                        <button type="button" class="days-btn" data-days="14">14 dias</button>
                        <button type="button" class="days-btn" data-days="30">30 dias</button>
                    </div>
                    <p class="days-help">M√≠nimo de 3 dias. Recomendamos 7 dias para melhor alcance.</p>
                </div>

                <div class="highlight-option">
                    <label>
                        <input 
                            type="checkbox" 
                            id="highlightCheckbox" 
                            class="highlight-checkbox"
                        >
                        <span>‚≠ê Adicionar ao Destaque</span>
                    </label>
                    <div class="highlight-info">
                        Seu an√∫ncio ficar√° em destaque por 3 dias. Aparecer√° no topo das buscas!
                    </div>
                </div>
            </div>

            <!-- Resumo -->
            <div class="summary-section">
                <h2 class="section-title">üìã Resumo do Pedido</h2>

                <div class="announcement-info" id="announcementInfo">
                    <h4>üìù An√∫ncio:</h4>
                    <p id="announcementTitle">Carregando...</p>
                </div>

                <div class="price-breakdown">
                    <div class="price-row">
                        <span class="price-label">Publica√ß√£o (por dia)</span>
                        <span class="price-value" id="dailyPrice">R$ 9,90</span>
                    </div>
                    <div class="price-row">
                        <span class="price-label">Dias selecionados</span>
                        <span class="price-value" id="daysSelected">7 dias</span>
                    </div>
                    <div class="price-row" id="highlightRow" style="display: none;">
                        <span class="price-label">‚≠ê Destaque (3 dias)</span>
                        <span class="price-value" id="highlightPrice">R$ 8,90</span>
                    </div>
                    <div class="price-row price-total">
                        <span class="price-label">Total</span>
                        <span class="price-value" id="totalPrice">R$ 69,30</span>
                    </div>
                </div>

                <div class="payment-methods">
                    <h3 style="margin-bottom: 15px; font-size: 16px;">Forma de Pagamento</h3>
                    <div class="payment-method" style="background: #e8f5e9; border-color: #4caf50;">
                        <input type="radio" id="paymentPix" name="paymentMethod" value="pix" checked disabled>
                        <label for="paymentPix">
                            <span class="payment-icon">üí≥</span>
                            PIX - Aprova√ß√£o Imediata
                        </label>
                    </div>
                </div>

                <button class="btn-pay" id="btnPay" onclick="processPayment()">
                    üí≥ Gerar PIX
                </button>

                <div class="warning-box" id="warningBox">
                    ‚ö†Ô∏è Ap√≥s o pagamento ser confirmado, seu an√∫ncio ser√° publicado imediatamente.
                </div>
            </div>

            <!-- Se√ß√£o de QR Code PIX (aparece ap√≥s gerar PIX) -->
            <div class="calculator-section" id="pixSection" style="display: none;">
                <h2 class="section-title">üì± Pague com PIX</h2>
                
                <div style="text-align: center; margin-bottom: 20px;">
                    <p style="color: #666; margin-bottom: 15px;">Escaneie o QR Code com o app do seu banco ou copie o c√≥digo PIX</p>
                    
                    <!-- QR Code -->
                    <div id="qrcodeContainer" style="margin: 20px auto; max-width: 300px;">
                        <canvas id="qrcodeCanvas" style="display: none;"></canvas>
                        <img id="qrcodeImage" src="" alt="QR Code PIX" style="max-width: 100%; border: 4px solid #f0f0f0; border-radius: 12px; padding: 10px; background: white;">
                    </div>
                    
                    <!-- C√≥digo PIX Copia e Cola -->
                    <div style="margin-top: 20px;">
                        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 10px; font-size: 14px;">
                            C√≥digo PIX (Copia e Cola)
                        </label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input 
                                type="text" 
                                id="pixCode" 
                                readonly 
                                style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 12px; font-family: monospace; background: #f9f9f9;"
                            >
                            <button 
                                onclick="copyPixCode()" 
                                id="btnCopyPix"
                                style="padding: 12px 20px; background: #0077B6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap;"
                            >
                                üìã Copiar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Informa√ß√µes do Pagamento -->
                    <div style="background: #f0f7ff; padding: 20px; border-radius: 8px; margin-top: 20px; text-align: left;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #666; font-weight: 500;">Valor:</span>
                            <span style="color: #0077B6; font-weight: 700; font-size: 18px;" id="pixValue">R$ 0,00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #666; font-weight: 500;">Status:</span>
                            <span style="color: #ff9800; font-weight: 600;" id="pixStatus">‚è≥ Aguardando pagamento...</span>
                        </div>
                        <div style="font-size: 12px; color: #999; margin-top: 15px; text-align: center;">
                            O pagamento ser√° verificado automaticamente
                        </div>
                    </div>
                    
                    <!-- Bot√£o de Cancelar -->
                    <button 
                        onclick="cancelPixPayment()" 
                        style="margin-top: 20px; padding: 12px 24px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;"
                    >
                        ‚ùå Cancelar Pagamento
                    </button>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../assets/js/supabase-auth-service.js"></script>
    <script src="../../assets/js/header-auth.js"></script>

    <script>
        // Esconder bot√£o flutuante na p√°gina de pagamento
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const floatingBtn = document.getElementById('floatingAnnounceBtn');
                if (floatingBtn) {
                    floatingBtn.style.display = 'none';
                }
            }, 1000);
        });

        let authService;
        const DAILY_PRICE = 9.90;
        const HIGHLIGHT_PRICE = 8.90;
        const MIN_DAYS = 3;
        const RECOMMENDED_DAYS = 7;
        
        // Configura√ß√µes do PushinPay PIX
        const PUSHINPAY_API_KEY = 'a04770e3-1bbf-4913-bf47-3fc05a440873|1tPtzIVtY6njf5LIgJ2GDK8zME2pQ8DNwZAe6reA91526390';
        const PUSHINPAY_API_URL = 'https://api.pushinpay.com.br'; // Verificar URL exata na documenta√ß√£o
        const N8N_WEBHOOK_URL = 'https://hooks.upcaodigital.com.br/webhook/acheinailha';
        
        // Vari√°veis globais para controle do PIX
        let pixCheckInterval = null;
        let currentPixId = null;

        // Inicializar
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Carregar header
                const headerResponse = await fetch('../../components/header-component.html');
                const headerHTML = await headerResponse.text();
                document.getElementById('header-container').innerHTML = headerHTML;

                // Aguardar authService
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (window.authService) {
                    authService = window.authService;
                    await checkAuth();
                    loadAnnouncementInfo();
                    setupCalculators();
                } else {
                    alert('Erro ao carregar servi√ßo de autentica√ß√£o');
                }
            } catch (error) {
            }
        });

        async function checkAuth() {
            if (!authService) {
                // Verificar token como fallback
                const tokenKey = Object.keys(localStorage).find(key => 
                    (key.includes('supabase') || key.includes('sb-')) && 
                    key.includes('auth-token')
                );
                if (tokenKey) {
                    try {
                        const tokenData = JSON.parse(localStorage.getItem(tokenKey));
                        if (tokenData && tokenData.access_token) {
                            return true;
                        }
                    } catch (e) {
                        // Ignorar
                    }
                }
                alert('Voc√™ precisa estar logado para publicar um an√∫ncio');
                window.location.href = '../../pages/auth/login.html';
                return false;
            }
            
            // Aguardar inicializa√ß√£o se necess√°rio
            if (!authService.isInitialized) {
                await authService.initialize();
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            const user = await authService.getCurrentUser();
            if (!user) {
                // Verificar token como fallback
                const tokenKey = Object.keys(localStorage).find(key => 
                    (key.includes('supabase') || key.includes('sb-')) && 
                    key.includes('auth-token')
                );
                if (tokenKey) {
                    try {
                        const tokenData = JSON.parse(localStorage.getItem(tokenKey));
                        if (tokenData && tokenData.access_token) {
                            return true;
                        }
                    } catch (e) {
                        // Ignorar
                    }
                }
                alert('Voc√™ precisa estar logado para publicar um an√∫ncio');
                window.location.href = '../../pages/auth/login.html';
                return false;
            }
            return true;
        }

        function loadAnnouncementInfo() {
            // Tentar obter dados do an√∫ncio da sess√£o ou localStorage
            const anuncioData = JSON.parse(localStorage.getItem('pendingAnnouncement') || '{}');
            
            if (anuncioData.titulo) {
                document.getElementById('announcementTitle').textContent = anuncioData.titulo;
                
                // Se √© um rascunho existente, mostrar mensagem diferente
                if (anuncioData.id && !anuncioData.id.startsWith('temp_')) {
                    const warningBox = document.getElementById('warningBox');
                    if (warningBox) {
                        warningBox.textContent = '‚ö†Ô∏è Ap√≥s o pagamento, seu rascunho ser√° publicado imediatamente.';
                    }
                }
            } else {
                document.getElementById('announcementTitle').textContent = 'Informa√ß√µes n√£o dispon√≠veis';
            }
        }

        function setupCalculators() {
            const daysInput = document.getElementById('daysInput');
            const highlightCheckbox = document.getElementById('highlightCheckbox');
            const daysButtons = document.querySelectorAll('.days-btn');

            // Bot√µes de dias r√°pidos
            daysButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const days = parseInt(btn.dataset.days);
                    daysInput.value = days;
                    
                    // Atualizar bot√µes ativos
                    daysButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    calculatePrice();
                });
            });

            // Input manual
            daysInput.addEventListener('input', () => {
                const value = parseInt(daysInput.value) || MIN_DAYS;
                
                if (value < MIN_DAYS) {
                    daysInput.value = MIN_DAYS;
                }
                
                // Atualizar bot√µes ativos
                daysButtons.forEach(btn => {
                    if (parseInt(btn.dataset.days) === parseInt(daysInput.value)) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                calculatePrice();
            });

            // Checkbox de destaque
            highlightCheckbox.addEventListener('change', () => {
                calculatePrice();
            });

            // Calcular pre√ßo inicial
            calculatePrice();
        }

        function calculatePrice() {
            const days = parseInt(document.getElementById('daysInput').value) || MIN_DAYS;
            const hasHighlight = document.getElementById('highlightCheckbox').checked;

            const basePrice = days * DAILY_PRICE;
            const highlightPrice = hasHighlight ? HIGHLIGHT_PRICE : 0;
            const total = basePrice + highlightPrice;

            // Atualizar exibi√ß√£o
            document.getElementById('daysSelected').textContent = `${days} ${days === 1 ? 'dia' : 'dias'}`;
            
            if (hasHighlight) {
                document.getElementById('highlightRow').style.display = 'flex';
                document.getElementById('highlightPrice').textContent = `R$ ${HIGHLIGHT_PRICE.toFixed(2).replace('.', ',')}`;
            } else {
                document.getElementById('highlightRow').style.display = 'none';
            }

            document.getElementById('totalPrice').textContent = formatCurrency(total);
        }

        function formatCurrency(value) {
            return `R$ ${value.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;
        }

        async function processPayment() {
            try {
                if (!await checkAuth()) return;

                const btnPay = document.getElementById('btnPay');
                btnPay.disabled = true;
                btnPay.textContent = '‚è≥ Processando...';

                const days = parseInt(document.getElementById('daysInput').value) || MIN_DAYS;
                const hasHighlight = document.getElementById('highlightCheckbox').checked;
                const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

                // Calcular valores
                const basePrice = days * DAILY_PRICE;
                const highlightPrice = hasHighlight ? HIGHLIGHT_PRICE : 0;
                const total = basePrice + highlightPrice;

                // Obter dados do an√∫ncio
                const anuncioData = JSON.parse(localStorage.getItem('pendingAnnouncement') || '{}');
                
                if (!anuncioData.id) {
                    throw new Error('Dados do an√∫ncio n√£o encontrados');
                }

                // Obter dados do usu√°rio e an√∫ncio
                const supabase = authService.getSupabase();
                if (!supabase) {
                    throw new Error('Supabase n√£o dispon√≠vel');
                }

                const user = await authService.getCurrentUser();
                if (!user) {
                    throw new Error('Usu√°rio n√£o logado');
                }

                const dadosCompletos = anuncioData.dados || {};
                
                // Verificar se √© um an√∫ncio existente (rascunho) ou novo
                let anuncioId = anuncioData.id || anuncioData.dados?.id;
                
                // Se n√£o tem ID v√°lido, criar an√∫ncio primeiro (como rascunho)
                if (!anuncioId || typeof anuncioId !== 'string' || anuncioId.startsWith('temp_') || anuncioId.length <= 10) {
                    const anuncioDataDB = {
                        usuario_id: user.id,
                        titulo: dadosCompletos.titulo,
                        descricao: dadosCompletos.descricao,
                        tipo_imovel: dadosCompletos.tipo,
                        categoria: dadosCompletos.categoria,
                        valor: dadosCompletos.preco,
                        endereco: dadosCompletos.localizacao || '',
                        bairro: null,
                        cidade: 'Ilha',
                        estado: 'BA',
                        cep: null,
                        area_terreno: null,
                        area_construida: null,
                        quartos: dadosCompletos.quartos || null,
                        banheiros: dadosCompletos.banheiros || null,
                        vagas_garagem: dadosCompletos.vagasGaragem || null,
                        emoji: dadosCompletos.emoji || null,
                        caracteristicas: dadosCompletos.caracteristicas || [],
                        ativo: false, // Ainda n√£o publicado
                        status: 'pendente_pagamento' // Aguardando pagamento
                    };

                    const { data: insertedData, error: insertError } = await supabase
                        .from('anuncios')
                        .insert([anuncioDataDB])
                        .select()
                        .single();

                    if (insertError || !insertedData) {
                        throw new Error('Erro ao criar an√∫ncio: ' + (insertError?.message || 'Erro desconhecido'));
                    }

                    anuncioId = insertedData.id;
                }

                // Converter valor para centavos (PushinPay usa centavos)
                const valorCentavos = Math.round(total * 100);

                // Criar PIX no PushinPay
                const pixData = {
                    value: valorCentavos, // Valor em centavos
                    description: `An√∫ncio - ${days} ${days === 1 ? 'dia' : 'dias'}${hasHighlight ? ' + Destaque' : ''}`,
                    metadata: {
                        anuncio_id: anuncioId,
                        dias_publicacao: days,
                        valor_total: total,
                        valor_base: basePrice,
                        valor_destaque: highlightPrice,
                        em_destaque: hasHighlight,
                        forma_pagamento: 'pix',
                        user_id: user.id,
                        tipo: 'anuncio'
                    }
                };

                // Fazer requisi√ß√£o para criar PIX
                const pixResponse = await fetch(`${PUSHINPAY_API_URL}/pix/qrcode`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${PUSHINPAY_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(pixData)
                });

                if (!pixResponse.ok) {
                    const errorData = await pixResponse.json().catch(() => ({ message: 'Erro desconhecido' }));
                    throw new Error('Erro ao criar PIX: ' + (errorData.message || `Status ${pixResponse.status}`));
                }

                const pixResult = await pixResponse.json();

                // Verificar se a resposta cont√©m o QR Code
                if (!pixResult.qr_code && !pixResult.qrcode && !pixResult.pix_code) {
                    throw new Error('Resposta do PIX inv√°lida. QR Code n√£o encontrado.');
                }

                // Obter dados do PIX
                const pixCode = pixResult.qr_code || pixResult.qrcode || pixResult.pix_code;
                const pixId = pixResult.id || pixResult.transaction_id || pixResult.pix_id;
                
                // Salvar ID da transa√ß√£o no an√∫ncio (status pendente)
                try {
                    await supabase
                        .from('anuncios')
                        .update({
                            transacao_id: pixId,
                            status: 'pendente_pagamento'
                        })
                        .eq('id', anuncioId);
                } catch (e) {
                    // N√£o foi poss√≠vel salvar ID da transa√ß√£o
                }

                // Armazenar dados globalmente
                currentPixId = pixId;
                
                // Exibir QR Code na tela
                displayPixQrCode(pixCode, total);
                
                // Iniciar verifica√ß√£o de pagamento
                startPixCheck(pixId, anuncioId, {
                    days,
                    total,
                    basePrice,
                    highlightPrice,
                    hasHighlight,
                    user: user.id
                });

            } catch (error) {
                alert('Erro ao processar pagamento: ' + error.message);
                
                const btnPay = document.getElementById('btnPay');
                btnPay.disabled = false;
                btnPay.textContent = 'üí≥ Gerar PIX';
            }
        }

        // Exibir QR Code do PIX
        function displayPixQrCode(pixCode, valor) {
            // Mostrar se√ß√£o PIX
            document.getElementById('pixSection').style.display = 'block';
            
            // Esconder bot√£o de pagamento
            document.getElementById('btnPay').style.display = 'none';
            
            // Preencher c√≥digo PIX
            document.getElementById('pixCode').value = pixCode;
            
            // Preencher valor
            document.getElementById('pixValue').textContent = formatCurrency(valor);
            
            // Gerar QR Code visual
            const qrcodeCanvas = document.getElementById('qrcodeCanvas');
            const qrcodeImage = document.getElementById('qrcodeImage');
            
            QRCode.toCanvas(qrcodeCanvas, pixCode, {
                width: 300,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function (error) {
                if (error) {
                    qrcodeImage.style.display = 'none';
                } else {
                    // Converter canvas para imagem
                    qrcodeImage.src = qrcodeCanvas.toDataURL();
                    qrcodeCanvas.style.display = 'none';
                    qrcodeImage.style.display = 'block';
                }
            });
            
            // Scroll para se√ß√£o PIX
            document.getElementById('pixSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Copiar c√≥digo PIX
        function copyPixCode() {
            const pixCodeInput = document.getElementById('pixCode');
            pixCodeInput.select();
            pixCodeInput.setSelectionRange(0, 99999); // Para mobile
            
            try {
                document.execCommand('copy');
                const btnCopy = document.getElementById('btnCopyPix');
                const originalText = btnCopy.textContent;
                btnCopy.textContent = '‚úÖ Copiado!';
                btnCopy.style.background = '#28a745';
                
                setTimeout(() => {
                    btnCopy.textContent = originalText;
                    btnCopy.style.background = '#0077B6';
                }, 2000);
            } catch (err) {
                alert('Erro ao copiar. Por favor, copie manualmente.');
            }
        }

        // Verificar status do pagamento PIX
        async function checkPixStatus(pixId) {
            try {
                const response = await fetch(`${PUSHINPAY_API_URL}/pix/${pixId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${PUSHINPAY_API_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Erro ao verificar status do PIX');
                }

                const pixData = await response.json();
                
                // Verificar status (pode variar: 'paid', 'pago', 'approved', etc.)
                const status = pixData.status || pixData.payment_status;
                const isPaid = status === 'paid' || status === 'pago' || status === 'approved' || status === 'aprovado';
                
                return {
                    paid: isPaid,
                    status: status,
                    data: pixData
                };
            } catch (error) {
                return { paid: false, status: 'error', data: null };
            }
        }

        // Iniciar verifica√ß√£o peri√≥dica do pagamento
        function startPixCheck(pixId, anuncioId, paymentData) {
            // Atualizar status inicial
            document.getElementById('pixStatus').textContent = '‚è≥ Aguardando pagamento...';
            document.getElementById('pixStatus').style.color = '#ff9800';
            
            // Verificar a cada 3 segundos
            pixCheckInterval = setInterval(async () => {
                const result = await checkPixStatus(pixId);
                
                if (result.paid) {
                    // Pagamento confirmado!
                    clearInterval(pixCheckInterval);
                    pixCheckInterval = null;
                    
                    // Atualizar status visual
                    document.getElementById('pixStatus').textContent = '‚úÖ Pagamento confirmado!';
                    document.getElementById('pixStatus').style.color = '#28a745';
                    
                    // Disparar webhook para n8n
                    await sendWebhookToN8n(anuncioId, pixId, paymentData, result.data);
                    
                    // Mostrar mensagem de sucesso
                    setTimeout(() => {
                        alert('‚úÖ Pagamento confirmado! Seu an√∫ncio ser√° publicado em instantes.');
                        window.location.href = '../../pages/user/meus-anuncios.html';
                    }, 2000);
                } else if (result.status === 'error') {
                    // Erro na verifica√ß√£o, continuar tentando
                }
            }, 3000); // Verificar a cada 3 segundos
            
            // Parar ap√≥s 15 minutos (seguran√ßa)
            setTimeout(() => {
                if (pixCheckInterval) {
                    clearInterval(pixCheckInterval);
                    pixCheckInterval = null;
                    document.getElementById('pixStatus').textContent = '‚è∞ Tempo esgotado. Gere um novo PIX.';
                    document.getElementById('pixStatus').style.color = '#dc3545';
                }
            }, 15 * 60 * 1000); // 15 minutos
        }

        // Enviar webhook para n8n quando pagamento confirmado
        async function sendWebhookToN8n(anuncioId, pixId, paymentData, pixResult) {
            try {
                const webhookData = {
                    event: 'payment.paid',
                    tipo: 'pix',
                    data: {
                        id: pixId,
                        anuncio_id: anuncioId,
                        amount: paymentData.total,
                        status: 'paid',
                        payment_method: 'pix',
                        metadata: {
                            anuncio_id: anuncioId,
                            dias_publicacao: paymentData.days,
                            valor_total: paymentData.total,
                            valor_base: paymentData.basePrice,
                            valor_destaque: paymentData.highlightPrice,
                            em_destaque: paymentData.hasHighlight,
                            forma_pagamento: 'pix',
                            user_id: paymentData.user,
                            tipo: 'anuncio'
                        },
                        created_at: new Date().toISOString()
                    }
                };

                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(webhookData)
                });

                // Webhook enviado (sucesso ou erro n√£o bloqueia o fluxo)
            } catch (error) {
                // Erro ao enviar webhook (n√£o bloqueia o fluxo)
            }
        }

        // Cancelar pagamento PIX
        function cancelPixPayment() {
            if (pixCheckInterval) {
                clearInterval(pixCheckInterval);
                pixCheckInterval = null;
            }
            
            currentPixId = null;
            
            // Esconder se√ß√£o PIX
            document.getElementById('pixSection').style.display = 'none';
            
            // Mostrar bot√£o de pagamento novamente
            document.getElementById('btnPay').style.display = 'block';
            document.getElementById('btnPay').disabled = false;
            document.getElementById('btnPay').textContent = 'üí≥ Gerar PIX';
        }
    </script>
</body>
</html>
