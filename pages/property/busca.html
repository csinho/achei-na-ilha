<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Achei na Ilha - Buscar Im√≥veis</title>
    <link rel="icon" type="image/svg+xml" href="../../assets/images/logo-achei-na-ilha.png">
    <link rel="alternate icon" href="../../assets/images/logo-achei-na-ilha.png">
    <link rel="stylesheet" href="../../assets/css/header.css">
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../assets/js/supabase-config.js"></script>
    
    <style>
         * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f8ff;
            background-image: url('../../assets/images/grid-background.webp');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(135, 206, 250, 0.2) 0%, rgba(255, 215, 0, 0.15) 100%);
            z-index: 0;
            pointer-events: none;
        }

        .search-section {
            background: white;
            padding: 20px 0;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
        }

        .search-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .search-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: #0077B6;
        }

        .btn-search {
            background: #0077B6;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-search:hover {
            background: #005a8d;
        }

        .btn-clear {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-clear:hover {
            background: #c82333;
        }

        /* Slider de Publicidades */
        .publicidades-slider {
            width: 100%;
            position: relative;
            margin-top: 0;
            background: #000;
            overflow: hidden;
        }

        .publicidades-slider-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            aspect-ratio: 6 / 1;
        }

        .publicidades-slides {
            display: flex;
            transition: transform 0.5s ease-in-out;
            height: 100%;
        }

        .publicidades-slide {
            min-width: 100%;
            height: 100%;
            position: relative;
            display: none;
        }

        .publicidades-slide.active {
            display: block;
        }

        .publicidades-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            aspect-ratio: 6 / 1;
        }

        .publicidades-slide a {
            display: block;
            width: 100%;
            height: 100%;
            position: relative;
        }

        .publicidades-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            z-index: 10;
            transition: all 0.3s;
        }

        .publicidades-nav:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .publicidades-nav.prev {
            left: 20px;
        }

        .publicidades-nav.next {
            right: 20px;
        }

        .publicidades-dots {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        .publicidades-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s;
        }

        .publicidades-dot.active {
            background: white;
            width: 30px;
            border-radius: 6px;
        }

        @media (max-width: 768px) {
            .publicidades-slider-container {
                aspect-ratio: 6 / 1;
            }

            .publicidades-nav {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .publicidades-nav.prev {
                left: 10px;
            }

            .publicidades-nav.next {
                right: 10px;
            }
        }

        .main-layout {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .sidebar {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
            z-index: 1;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #0077B6;
        }

        .filter-section {
            margin-bottom: 25px;
        }

        .filter-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .filter-label {
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
            font-weight: 500;
        }

        select, input[type="number"], input[type="range"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            transition: border-color 0.2s;
        }

        select:focus, input[type="number"]:focus {
            outline: none;
            border-color: #0077B6;
        }

        .price-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .price-range input {
            flex: 1;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .checkbox-item label {
            font-size: 14px;
            color: #333;
            cursor: pointer;
        }

        .results-area {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            min-height: 400px;
            position: relative;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
            min-width: 0;
        }

        .results-count {
            font-size: 16px;
            color: #333;
            font-weight: 600;
        }

        .sort-options {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
        }

        .sort-select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .sort-options label {
            white-space: nowrap;
            font-size: 14px;
            color: #333;
        }

        .main-content {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .ad-banner {
            background: linear-gradient(135deg, #C9643B, #a5512e);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .ad-banner.visible {
            display: block;
        }

        .listings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
            min-height: 200px;
        }

        /* An√∫ncios em destaque - borda dourada e efeito pulsante */
        .listing-card-destaque {
            border: 3px solid #FFD700 !important;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 4px 12px rgba(0, 0, 0, 0.15) !important;
            animation: pulse-gold 2s ease-in-out infinite;
            position: relative;
        }

        @keyframes pulse-gold {
            0%, 100% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 4px 12px rgba(0, 0, 0, 0.15);
                border-color: #FFD700;
            }
            50% {
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 6px 16px rgba(0, 0, 0, 0.2);
                border-color: #FFA500;
            }
        }

        .listing-card-destaque::before {
            content: '‚≠ê DESTAQUE';
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            font-size: 10px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 4px;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.5px;
        }

        .listing-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1px solid #e0e0e0;
            margin-bottom: 16px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }

        .listing-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: #0077B6;
        }

        .carousel-container {
            position: relative;
            width: 100%;
            height: 180px;
            overflow: hidden;
            border-radius: 8px 8px 0 0;
        }

        .carousel-images {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
        }

        .carousel-image {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .carousel-image.active {
            opacity: 1;
        }

        .listing-image-fallback {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #e0e0e0, #f5f5f5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }

        .carousel-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
        }

        .carousel-button.prev {
            left: 10px;
        }

        .carousel-button.next {
            right: 10px;
        }

        .carousel-container:hover .carousel-button {
            opacity: 1;
        }

        .carousel-button:hover {
            background: rgba(0, 0, 0, 0.7);
        }

        .listing-content {
            padding: 16px;
        }

        .listing-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .listing-emoji {
            font-size: 18px;
            margin-right: 8px;
        }

        .listing-price {
            font-size: 20px;
            font-weight: 700;
            color: #0077B6;
            margin-bottom: 8px;
        }

        .listing-location {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .listing-details {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }

        .detail-item {
            display: inline-block;
            padding: 4px 8px;
            background: #e8f4fd;
            color: #0077B6;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .listing-type {
            display: inline-block;
            padding: 4px 8px;
            background: #f0f0f0;
            color: #666;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Bot√£o de favoritar */
        .listing-favorite {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 20;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .listing-favorite:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }

        .favorite-icon {
            font-size: 18px;
            color: #666;
            transition: all 0.2s ease;
        }

        .listing-favorite.active .favorite-icon {
            color: #e91e63;
        }

        .listing-favorite.active .favorite-icon::after {
            content: '‚ô•';
        }

        .listing-favorite:not(.active) .favorite-icon::after {
            content: '‚ô°';
        }

        .listing-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 6px;
        }

        .listing-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #f0f0f0;
            color: #666;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .listing-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #999;
            margin-top: auto;
            padding-top: 4px;
        }

        .listing-date {
            color: #999;
        }

        .listing-location-mobile {
            color: #999;
        }

        /* Bottom navigation removido - funcionalidades movidas para header e bot√£o flutuante */

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        /* Layout Mobile - Cards horizontais */
        @media (max-width: 768px) {
            .listings-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 0 12px;
            }

            .listing-card {
                flex-direction: row;
                min-height: 140px;
                border-radius: 12px;
                margin-bottom: 12px;
                align-items: stretch;
            }

            .carousel-container {
                width: 140px;
                min-width: 140px;
                height: 100%;
                border-radius: 12px 0 0 12px;
                flex-shrink: 0;
                align-self: stretch;
            }

            .listing-content {
                flex: 1;
                padding: 12px;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                min-width: 0;
            }

            .listing-title {
                font-size: 14px;
                margin-bottom: 6px;
                -webkit-line-clamp: 2;
                line-clamp: 2;
            }

            .listing-emoji {
                display: none;
            }

            .listing-price {
                font-size: 18px;
                margin-bottom: 4px;
            }

            .listing-location {
                display: none;
            }

            .listing-details {
                gap: 6px;
                margin-bottom: 6px;
                flex-wrap: wrap;
            }

            .detail-item {
                font-size: 10px;
                padding: 2px 6px;
                background: #e8f4fd;
                color: #0077B6;
                border-radius: 3px;
                font-weight: 500;
                white-space: nowrap;
            }

            .listing-type {
                display: none;
            }

            .listing-badge {
                font-size: 10px;
                padding: 3px 6px;
            }

            .listing-footer {
                font-size: 10px;
            }

            .carousel-button {
                width: 24px;
                height: 24px;
                font-size: 14px;
            }

            .carousel-button.prev {
                left: 6px;
            }

            .carousel-button.next {
                right: 6px;
            }

            .listing-favorite {
                width: 28px;
                height: 28px;
            }

            .favorite-icon {
                font-size: 16px;
            }
        }

        /* Bot√£o de Filtros Mobile - oculto por padr√£o (desktop) */
        .mobile-filters-btn {
            display: none;
        }

        .mobile-filters-modal {
            display: none;
        }

        @media (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .sidebar {
                display: none; /* Esconder sidebar no mobile */
            }

            .results-area {
                order: 1;
            }

            /* Bot√£o de Filtros Mobile - vis√≠vel apenas no mobile */
            .mobile-filters-btn {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 12px 20px;
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 20px;
                font-size: 16px;
                font-weight: 500;
                color: #333;
                cursor: pointer;
                margin: 0 0 30px 0;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                transition: all 0.2s;
                width: 100%;
                justify-content: center;
            }

            .mobile-filters-btn:active {
                background: #f5f5f5;
                transform: scale(0.98);
            }

            .mobile-filters-btn svg {
                width: 20px;
                height: 20px;
            }

            /* Modal de Filtros Mobile */
            .mobile-filters-modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 10000;
            } 

            .mobile-filters-modal.active {
                display: block;
            } 

            .mobile-filters-overlay {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(2px);
                animation: fadeIn 0.3s ease;
            }

            .mobile-filters-content {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-radius: 20px 20px 0 0;
                max-height: 90vh;
                display: flex;
                flex-direction: column;
                animation: slideUp 0.3s ease;
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            }

            .mobile-filters-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 20px;
                border-bottom: 1px solid #e0e0e0;
                flex-shrink: 0;
            }

            .mobile-filters-header h3 {
                font-size: 20px;
                font-weight: 600;
                color: #333;
                margin: 0;
            }

            .mobile-filters-close {
                background: none;
                border: none;
                padding: 8px;
                cursor: pointer;
                color: #666;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: background 0.2s;
            }

            .mobile-filters-close:active {
                background: #f0f0f0;
            }

            .mobile-filters-body {
                flex: 1;
                overflow-y: auto;
                padding: 20px;
                -webkit-overflow-scrolling: touch;
            }

            /* Garantir que os filtros apare√ßam no modal */
            .mobile-filters-body .filter-section {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                margin-bottom: 25px;
            }

            .mobile-filters-body .filter-section-title {
                display: block !important;
                visibility: visible !important;
                font-size: 16px;
                font-weight: 600;
                color: #333;
                margin-bottom: 12px;
            }

            .mobile-filters-body .checkbox-group {
                display: flex !important;
                flex-direction: column;
                gap: 8px;
            }

            .mobile-filters-body .checkbox-item {
                display: flex !important;
                align-items: center;
                gap: 8px;
            }

            .mobile-filters-body .filter-group {
                display: block !important;
                margin-bottom: 15px;
            }

            .mobile-filters-body .filter-label {
                display: block !important;
                font-size: 14px;
                color: #333;
                margin-bottom: 8px;
                font-weight: 500;
            }

            .mobile-filters-body select,
            .mobile-filters-body input[type="number"] {
                display: block !important;
                width: 100%;
                padding: 10px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
                font-size: 14px;
                background: white;
            }

            .mobile-filters-footer {
                display: flex;
                gap: 12px;
                padding: 20px;
                border-top: 1px solid #e0e0e0;
                flex-shrink: 0;
                background: white;
            }

            .btn-limpar-filtros {
                flex: 1;
                padding: 14px;
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 500;
                color: #333;
                cursor: pointer;
                transition: all 0.2s;
            }

            .btn-limpar-filtros:active {
                background: #f5f5f5;
            }

            .btn-aplicar-filtros {
                flex: 2;
                padding: 14px;
                background: #e60012;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                color: white;
                cursor: pointer;
                transition: all 0.2s;
            }

            .btn-aplicar-filtros:active {
                background: #cc0010;
                transform: scale(0.98);
            }

            @keyframes slideUp {
                from {
                    transform: translateY(100%);
                }
                to {
                    transform: translateY(0);
                }
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            .search-bar {
                flex-direction: column;
                gap: 10px;
            }

            .btn-search {
                width: 100%;
            }

            .listings-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .results-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .sort-options {
                width: 100%;
                justify-content: flex-start;
            }
        }

        @media (max-width: 480px) {
            .main-layout {
                padding: 0 10px;
            }

            .sidebar {
                padding: 15px;
            }

            .results-area {
                padding: 15px;
            }

            .filter-section {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Header ser√° carregado via JavaScript -->
    <div id="header-container"></div>

    <div class="search-section">
        <div class="search-container">
            <div class="search-bar">
                <input type="text" id="searchInput" class="search-input" placeholder="Buscar por t√≠tulo, localiza√ß√£o...">
                <button class="btn-search" onclick="buscarImoveis()">Buscar</button>
            </div>
        </div>
    </div>

    <!-- Slider de Publicidades -->
    <section class="publicidades-slider" id="publicidadesSlider" style="display: none;">
        <div class="publicidades-slider-container">
            <div class="publicidades-slides" id="publicidadesSlides"></div>
            <button class="publicidades-nav prev" onclick="navigatePublicidade('prev')">‚Äπ</button>
            <button class="publicidades-nav next" onclick="navigatePublicidade('next')">‚Ä∫</button>
            <div class="publicidades-dots" id="publicidadesDots"></div>
        </div>
    </section>


    <div class="main-layout">
        <div class="sidebar">
            <h3 class="sidebar-title">Filtros</h3>
            
            <div class="filter-section">
                <h4 class="filter-section-title">Categoria</h4>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterVenda" value="venda">
                        <label for="filterVenda">Venda</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterAluguel" value="aluguel">
                        <label for="filterAluguel">Aluguel</label>
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <h4 class="filter-section-title">Tipo de Im√≥vel</h4>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterCasa" value="casa">
                        <label for="filterCasa">Casa</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterApartamento" value="apartamento">
                        <label for="filterApartamento">Apartamento</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterTerreno" value="terreno">
                        <label for="filterTerreno">Terreno</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterComercial" value="comercial">
                        <label for="filterComercial">Comercial</label>
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <h4 class="filter-section-title">Faixa de Pre√ßo</h4>
                <div class="filter-group">
                    <label class="filter-label">Valor M√≠nimo</label>
                    <input type="number" id="filterMinPrice" placeholder="R$ 0">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Valor M√°ximo</label>
                    <input type="number" id="filterMaxPrice" placeholder="R$ 999999">
                </div>
            </div>

            <div class="filter-section">
                <h4 class="filter-section-title">Localiza√ß√£o</h4>
                <div class="filter-group">
                    <label class="filter-label">Cidade</label>
                    <select id="filterCidade">
                        <option value="">Todas as cidades</option>
                    </select>
                </div>
            </div>

            <div class="filter-section">
                <h4 class="filter-section-title">Quartos</h4>
                <div class="filter-group">
                    <label class="filter-label">M√≠nimo de Quartos</label>
                    <select id="filterQuartos">
                        <option value="">Qualquer</option>
                        <option value="1">1+</option>
                        <option value="2">2+</option>
                        <option value="3">3+</option>
                        <option value="4">4+</option>
                        <option value="5">5+</option>
                    </select>
                </div>
            </div>

            <div class="filter-section">
                <h4 class="filter-section-title">Banheiros</h4>
                <div class="filter-group">
                    <label class="filter-label">M√≠nimo de Banheiros</label>
                    <select id="filterBanheiros">
                        <option value="">Qualquer</option>
                        <option value="1">1+</option>
                        <option value="2">2+</option>
                        <option value="3">3+</option>
                        <option value="4">4+</option>
                    </select>
                </div>
            </div>

            <div class="filter-section">
                <h4 class="filter-section-title">Garagem</h4>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterTemGaragem" value="tem-garagem">
                        <label for="filterTemGaragem">Com Garagem</label>
                    </div>
                </div>
                <div class="filter-group" id="filterVagasContainer" style="display: none; margin-top: 20px;">
                    <label class="filter-label">M√≠nimo de Vagas</label>
                    <select id="filterVagasGaragem">
                        <option value="">Qualquer</option>
                        <option value="1">1+</option>
                        <option value="2">2+</option>
                        <option value="3">3+</option>
                        <option value="4">4+</option>
                    </select>
                </div>
            </div>

            <div class="filter-section">
                <h4 class="filter-section-title">Caracter√≠sticas</h4>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterPiscina" value="piscina">
                        <label for="filterPiscina">üèä Com Piscina</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterVistaMar" value="vista-mar">
                        <label for="filterVistaMar">üåÖ Vista para o Mar</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterChurrasqueira" value="churrasqueira">
                        <label for="filterChurrasqueira">üî• Churrasqueira</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterRoca" value="roca">
                        <label for="filterRoca">üåæ √Årea de Ro√ßa</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterFesta" value="area-festa">
                        <label for="filterFesta">üéâ √Årea para Festa</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterVaranda" value="varanda">
                        <label for="filterVaranda">üè° Varanda Grande</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterQuintal" value="quintal">
                        <label for="filterQuintal">üå≥ Quintal Espa√ßoso</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterCoco" value="coqueiros">
                        <label for="filterCoco">üå¥ Coqueiros</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterPoco" value="poco">
                        <label for="filterPoco">üíß Po√ßo Artesiano</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterCasaVerao" value="casa-verao">
                        <label for="filterCasaVerao">üèñÔ∏è Casa de Ver√£o</label>
                    </div>
                </div>
            </div>

            <button id="clearFiltersBtn" class="btn-clear" onclick="limparFiltros()" style="width: 100%; margin-top: 20px; display: none;">
                Limpar Filtros
            </button>
        </div>

        <div class="results-area">
            <!-- Bot√£o de Filtros Mobile (apenas vis√≠vel no mobile) -->
            <button class="mobile-filters-btn" id="mobileFiltersBtn" onclick="window.abrirFiltrosMobile()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="4" y1="6" x2="20" y2="6"></line>
                    <line x1="4" y1="12" x2="20" y2="12"></line>
                    <line x1="4" y1="18" x2="20" y2="18"></line>
                </svg>
                <span>Filtros</span>
            </button>
            <div class="results-header">
                <div class="results-count" id="resultsCount">Encontrados 0 im√≥veis</div>
                <div class="sort-options">
                    <label for="sortSelect">Ordenar por:</label>
                    <select id="sortSelect" class="sort-select" onchange="ordenarResultados()">
                        <option value="relevancia">Relev√¢ncia</option>
                        <option value="preco-menor">Menor Pre√ßo</option>
                        <option value="preco-maior">Maior Pre√ßo</option>
                        <option value="mais-recente">Mais Recente</option>
                    </select>
                </div>
            </div>

            <div id="adBanner" class="ad-banner">
                <h3>Publicidade Local</h3>
                <p>Espa√ßo reservado para an√∫ncios de com√©rcios locais</p>
            </div>

            <div id="listingsContainer" class="listings-grid"></div>

            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon">üè†</div>
                <h2>Nenhum im√≥vel encontrado</h2>
                <p>Tente ajustar os filtros ou criar um novo an√∫ncio</p>
            </div>
        </div>
    </div>

    <!-- Modal de Filtros Mobile -->
    <div class="mobile-filters-modal" id="mobileFiltersModal">
        <div class="mobile-filters-overlay" onclick="window.fecharFiltrosMobile()"></div>
        <div class="mobile-filters-content">
            <div class="mobile-filters-header">
                <h3>Filtros</h3>
                <button class="mobile-filters-close" onclick="window.fecharFiltrosMobile()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="mobile-filters-body" id="mobileFiltersBody">
                <!-- Conte√∫do dos filtros ser√° copiado do sidebar -->
            </div>
            <div class="mobile-filters-footer">
                <button class="btn-limpar-filtros" onclick="window.limparFiltrosMobile()">Limpar filtros</button>
                <button class="btn-aplicar-filtros" onclick="window.aplicarFiltrosMobile()">
                    Filtrar (<span id="mobileFiltersCount">0</span>)
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom navigation removido - funcionalidades movidas para header e bot√£o flutuante -->

    <script>
        // URL da imagem padr√£o para an√∫ncios sem imagens
        const IMAGEM_PADRAO = 'https://images.tcdn.com.br/img/img_prod/734896/patch_cord_cat6_amarelo_sohoplus_50_centimetros_2525_1_546d22ba08fae4a55e7ad243dfdc8b90.jpeg';
        
        // Array de an√∫ncios - ser√° preenchido apenas com dados do banco
        let todosAnuncios = [];

        async function carregarAnunciosDoSupabase() {
            try {
                // Verificar se Supabase est√° dispon√≠vel
                if (typeof window.supabase === 'undefined') {
                    return;
                }

                // Obter cliente Supabase - sempre usar getSupabaseClient para garantir inst√¢ncia √∫nica
                let supabaseClient = null;
                
                // Prioridade 1: tentar usar getSupabaseClient (que gerencia singleton)
                if (typeof window.getSupabaseClient === 'function') {
                    supabaseClient = window.getSupabaseClient();
                }
                
                // Prioridade 2: se getSupabaseClient n√£o retornou nada, tentar authService
                if (!supabaseClient && typeof window.authService !== 'undefined' && window.authService) {
                    // Aguardar inicializa√ß√£o do authService se necess√°rio
                    if (window.authService.isInitialized) {
                        supabaseClient = window.authService.getSupabase();
                    } else {
                        // Se authService existe mas n√£o est√° inicializado, aguardar
                        // N√£o criar nova inst√¢ncia aqui para evitar m√∫ltiplas inst√¢ncias
                        return;
                    }
                }

                if (!supabaseClient) {
                    return;
                }

                // Buscar an√∫ncios publicados do Supabase
                // Apenas an√∫ncios que est√£o:
                // - ativo = true
                // - status = 'publicado'
                // - data_fim_publicacao >= NOW() (n√£o expirou) ou data_fim_publicacao IS NULL
                const agora = new Date().toISOString();
                
                const { data: anunciosDB, error } = await supabaseClient
                    .from('anuncios')
                    .select(`
                        *,
                        imagens_anuncio:imagens_anuncio(url, principal, ordem)
                    `)
                    .eq('ativo', true)
                    .eq('status', 'publicado')
                    .or(`data_fim_publicacao.is.null,data_fim_publicacao.gte.${agora}`)
                    .order('criado_em', { ascending: false }); // Ordenar por data de cria√ß√£o (a ordena√ß√£o por destaque ser√° feita no JavaScript)

                if (error) {
                    return;
                }

                // Armazenar cliente globalmente para usar na subscription
                anunciosSupabaseClient = supabaseClient;

                if (anunciosDB && anunciosDB.length > 0) {
                    // Ordenar an√∫ncios: destaque primeiro, depois por data de cria√ß√£o
                    const anunciosOrdenados = [...anunciosDB].sort((a, b) => {
                        // Primeiro: an√∫ncios em destaque v√™m primeiro
                        if (a.em_destaque && !b.em_destaque) return -1;
                        if (!a.em_destaque && b.em_destaque) return 1;
                        // Se ambos t√™m ou n√£o t√™m destaque, ordenar por data de cria√ß√£o
                        const dataA = new Date(a.criado_em);
                        const dataB = new Date(b.criado_em);
                        return dataB - dataA; // Mais recente primeiro
                    });
                    
                    // Converter formato do banco para formato usado na p√°gina
                    const anunciosFormatados = anunciosOrdenados.map(anuncio => {
                        // Obter primeira imagem principal
                        const imagemPrincipal = anuncio.imagens_anuncio && anuncio.imagens_anuncio.length > 0
                            ? anuncio.imagens_anuncio.find(img => img.principal) || anuncio.imagens_anuncio[0]
                            : null;
                        
                        // Preparar array de imagens (usar imagem padr√£o se n√£o tiver)
                        const imagens = anuncio.imagens_anuncio && anuncio.imagens_anuncio.length > 0
                            ? anuncio.imagens_anuncio
                                .sort((a, b) => (a.ordem || 0) - (b.ordem || 0))
                                .map(img => img.url)
                            : [IMAGEM_PADRAO];

                        return {
                            id: anuncio.id,
                            titulo: anuncio.titulo,
                            preco: parseFloat(anuncio.valor),
                            localizacao: anuncio.endereco || anuncio.bairro || anuncio.cidade || 'Localiza√ß√£o n√£o informada',
                            tipo: anuncio.tipo_imovel,
                            categoria: anuncio.categoria,
                            emoji: anuncio.emoji || 'üè†',
                            quartos: anuncio.quartos || 0,
                            banheiros: anuncio.banheiros || 0,
                            area: anuncio.area || anuncio.area_construida || anuncio.area_terreno || null,
                            area_construida: anuncio.area_construida || null,
                            area_terreno: anuncio.area_terreno || null,
                            garagem: (anuncio.vagas_garagem && anuncio.vagas_garagem > 0) || false,
                            vagasGaragem: anuncio.vagas_garagem || 0,
                            caracteristicas: anuncio.caracteristicas || [],
                            imagens: imagens,
                            criado_em: anuncio.criado_em,
                            cidade: anuncio.cidade,
                            estado: anuncio.estado,
                            em_destaque: anuncio.em_destaque || false // Incluir campo em_destaque
                        };
                    });

                    // Substituir an√∫ncios pelos dados do banco
                    todosAnuncios = anunciosFormatados;
                    // Aplicar filtros novamente para atualizar a lista
                    aplicarFiltros();
                } else {
                }

                // Configurar realtime subscription ap√≥s carregar pela primeira vez
                if (anunciosSupabaseClient && !anunciosSubscription) {
                    configurarRealtimeAnuncios(anunciosSupabaseClient);
                }
            } catch (error) {
            }
        }

        function carregarAnunciosSalvos() {
            const anunciosSalvos = localStorage.getItem('anuncios');
            if (anunciosSalvos) {
                try {
                const anuncios = JSON.parse(anunciosSalvos);
                todosAnuncios = anuncios;
                } catch (e) {
                }
            }
        }

        function renderizarAnuncios(anuncios) {
            const container = document.getElementById('listingsContainer');
            const emptyState = document.getElementById('emptyState');

            if (!container) {
                return;
            }

            if (anuncios.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'grid';
            emptyState.style.display = 'none';

            // Formatar data relativa
            const formatarDataRelativa = (data) => {
                if (!data) return '';
                const agora = new Date();
                const dataAnuncio = new Date(data);
                
                // Resetar horas para comparar apenas as datas
                const hoje = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
                const dataAnuncioDate = new Date(dataAnuncio.getFullYear(), dataAnuncio.getMonth(), dataAnuncio.getDate());
                const ontem = new Date(hoje);
                ontem.setDate(ontem.getDate() - 1);
                
                const diffMs = hoje - dataAnuncioDate;
                const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                
                if (diffDias === 0) return 'Hoje';
                if (diffDias === 1) return 'Ontem';
                
                // Se for mais antigo, formatar como dd/mm/yyyy
                const dia = String(dataAnuncio.getDate()).padStart(2, '0');
                const mes = String(dataAnuncio.getMonth() + 1).padStart(2, '0');
                const ano = dataAnuncio.getFullYear();
                return `${dia}/${mes}/${ano}`;
            };

            container.innerHTML = anuncios.map(anuncio => {
                const dataPublicacao = anuncio.criado_em ? formatarDataRelativa(anuncio.criado_em) : '';
                const cidade = anuncio.cidade || 'Ilha';
                const estado = anuncio.estado || 'BA';
                const localizacaoCompleta = `${cidade}, ${estado}`;
                const area = anuncio.area || anuncio.area_construida || anuncio.area_terreno || null;
                
                // Adicionar classe especial para an√∫ncios em destaque
                const isDestaque = anuncio.em_destaque === true;
                const cardClass = isDestaque ? 'listing-card listing-card-destaque' : 'listing-card';
                
                return `
                <div class="${cardClass}" onclick="verDetalhes('${anuncio.id}')" data-anuncio-id="${anuncio.id}">
                    <div class="carousel-container">
                        <div class="carousel-images">
                            ${anuncio.imagens && anuncio.imagens.length > 0 
                                ? anuncio.imagens.map((img, index) => 
                                    `<img src="${img}" alt="${anuncio.titulo}" class="carousel-image ${index === 0 ? 'active' : ''}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='${IMAGEM_PADRAO}'">`
                                  ).join('')
                                : `<img src="${IMAGEM_PADRAO}" alt="${anuncio.titulo}" class="carousel-image active" style="width: 100%; height: 100%; object-fit: cover;">`
                            }
                        </div>
                        <button class="listing-favorite" onclick="event.stopPropagation(); toggleFavorite('${anuncio.id}')" data-anuncio-id="${anuncio.id}" title="Favoritar">
                            <span class="favorite-icon"></span>
                        </button>
                        ${anuncio.imagens && anuncio.imagens.length > 1 ? `
                            <button class="carousel-button prev" onclick="event.stopPropagation(); navigateCarousel(this.closest('.carousel-container'), -1)">‚Äπ</button>
                            <button class="carousel-button next" onclick="event.stopPropagation(); navigateCarousel(this.closest('.carousel-container'), 1)">‚Ä∫</button>
                        ` : ''}
                    </div>
                    <div class="listing-content">
                        <div class="listing-header">
                            <h3 class="listing-title">
                                ${anuncio.titulo}
                            </h3>
                            <div class="listing-badge">${anuncio.categoria === 'venda' ? 'Venda' : 'Aluguel'}</div>
                        </div>
                        <div class="listing-price">R$ ${anuncio.preco.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                        <div class="listing-details">
                            ${anuncio.quartos > 0 ? `<span class="detail-item">üõèÔ∏è ${anuncio.quartos} quarto${anuncio.quartos > 1 ? 's' : ''}</span>` : ''}
                            ${anuncio.banheiros > 0 ? `<span class="detail-item">üöø ${anuncio.banheiros} banheiro${anuncio.banheiros > 1 ? 's' : ''}</span>` : ''}
                            ${anuncio.area ? `<span class="detail-item">üìê ${anuncio.area}m¬≤</span>` : ''}
                            ${anuncio.garagem && anuncio.vagasGaragem > 0 ? `<span class="detail-item">üöó ${anuncio.vagasGaragem} vaga${anuncio.vagasGaragem > 1 ? 's' : ''}</span>` : ''}
                        </div>
                        <div class="listing-footer">
                            <span class="listing-location-mobile">${localizacaoCompleta}</span>
                            ${dataPublicacao ? `<span class="listing-date">${dataPublicacao}</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
            }).join('');
            
            // Inicializar carross√©is ap√≥s renderizar
            setTimeout(() => {
                document.querySelectorAll('.carousel-container').forEach(container => {
                    startCarousel(container);
                    addSwipeSupport(container);
                });
                // Carregar estado dos favoritos
                carregarFavoritos();
            }, 100);
        }

        function buscarImoveis() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            // Aplicar filtros + busca
            aplicarFiltros();
        }

        function verDetalhes(id) {
            // Salvar ID como string (pode ser UUID ou n√∫mero)
            localStorage.setItem('anuncioSelecionado', id);
            // Passar ID tamb√©m na URL para permitir compartilhamento de links
            window.location.href = `detalhes.html?id=${encodeURIComponent(id)}`;
        }

        // Fun√ß√£o para favoritar an√∫ncio
        async function toggleFavorite(anuncioId) {
            // Verificar se est√° logado
            if (!window.authService || !window.authService.getCurrentUser) {
                if (window.toast) {
                    window.toast.info('Fa√ßa login para favoritar an√∫ncios');
                } else {
                    alert('Fa√ßa login para favoritar an√∫ncios');
                }
                return;
            }

            try {
                const service = window.authService;
                if (!service.isInitialized) {
                    await service.initialize();
                }

                const user = await service.getCurrentUser();
                if (!user || !user.id) {
                    if (window.toast) {
                        window.toast.error('Erro ao identificar usu√°rio');
                    }
                    return;
                }

                const supabase = service.getSupabase();
                if (!supabase) {
                    throw new Error('Supabase n√£o dispon√≠vel');
                }

                const favoriteBtn = event.target.closest('.listing-favorite');
                
                // Verificar se j√° est√° favoritado
                const { data: favoritosExistentes, error: checkError } = await supabase
                    .from('favoritos')
                    .select('id')
                    .eq('usuario_id', user.id)
                    .eq('anuncio_id', anuncioId)
                    .limit(1);

                if (checkError) {
                    throw checkError;
                }

                const favoritoExistente = favoritosExistentes && favoritosExistentes.length > 0 ? favoritosExistentes[0] : null;

                if (favoritoExistente) {
                    // Remover dos favoritos
                    const { error: deleteError } = await supabase
                        .from('favoritos')
                        .delete()
                        .eq('id', favoritoExistente.id);

                    if (deleteError) {
                        throw deleteError;
                    }

                    favoriteBtn.classList.remove('active');
                    if (window.toast) {
                        window.toast.success('Removido dos favoritos');
                    }
                } else {
                    // Adicionar aos favoritos
                    const { error: insertError } = await supabase
                        .from('favoritos')
                        .insert({
                            usuario_id: user.id,
                            anuncio_id: anuncioId
                        });

                    if (insertError) {
                        throw insertError;
                    }

                    favoriteBtn.classList.add('active');
                    if (window.toast) {
                        window.toast.success('Adicionado aos favoritos');
                    }
                }
            } catch (error) {
                if (window.toast) {
                    window.toast.error('Erro ao atualizar favoritos: ' + (error.message || 'Erro desconhecido'));
                } else {
                    alert('Erro ao atualizar favoritos');
                }
            }
        }

        // Carregar estado dos favoritos ao renderizar
        async function carregarFavoritos() {
            // Verificar se est√° logado
            if (!window.authService || !window.authService.getCurrentUser) {
                return;
            }

            try {
                const service = window.authService;
                if (!service.isInitialized) {
                    await service.initialize();
                }

                const user = await service.getCurrentUser();
                if (!user || !user.id) {
                    return;
                }

                const supabase = service.getSupabase();
                if (!supabase) {
                    return;
                }

                // Buscar favoritos do usu√°rio
                const { data: favoritos, error } = await supabase
                    .from('favoritos')
                    .select('anuncio_id')
                    .eq('usuario_id', user.id);

                if (error) {
                    return;
                }

                const anunciosFavoritados = favoritos ? favoritos.map(f => f.anuncio_id) : [];

                // Atualizar bot√µes de favorito
                document.querySelectorAll('.listing-favorite').forEach(btn => {
                    const anuncioId = btn.getAttribute('data-anuncio-id') || btn.closest('.listing-card')?.getAttribute('data-anuncio-id');
                    if (anuncioId && anunciosFavoritados.includes(anuncioId)) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            } catch (error) {
                // Silenciosamente falhar se n√£o conseguir carregar favoritos
            }
        }

        // Fun√ß√µes do carrossel
        function navigateCarousel(container, direction) {
            const images = container.querySelectorAll('.carousel-image');
            const activeImage = container.querySelector('.carousel-image.active');
            let currentIndex = Array.from(images).indexOf(activeImage);
            
            // Remover classe active da imagem atual
            activeImage.classList.remove('active');
            
            // Calcular pr√≥ximo √≠ndice
            currentIndex += direction;
            
            // Loop infinito
            if (currentIndex >= images.length) {
                currentIndex = 0;
            } else if (currentIndex < 0) {
                currentIndex = images.length - 1;
            }
            
            // Adicionar classe active √† nova imagem
            images[currentIndex].classList.add('active');
        }

        function startCarousel(container) {
            const images = container.querySelectorAll('.carousel-image');
            if (images.length <= 1) return;
            
            // Limpar interval anterior se existir
            if (container.carouselInterval) {
                clearInterval(container.carouselInterval);
            }
            
            // Iniciar carrossel autom√°tico
            container.carouselInterval = setInterval(() => {
                navigateCarousel(container, 1);
            }, 3000);
        }

        function stopCarousel(container) {
            if (container.carouselInterval) {
                clearInterval(container.carouselInterval);
                container.carouselInterval = null;
            }
        }

        // Touch/swipe support
        function addSwipeSupport(container) {
            let startX = 0;
            let startY = 0;
            let isScrolling = false;
            
            container.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isScrolling = false;
            });
            
            container.addEventListener('touchmove', (e) => {
                if (!startX || !startY) return;
                
                const currentX = e.touches[0].clientX;
                const currentY = e.touches[0].clientY;
                const diffX = Math.abs(currentX - startX);
                const diffY = Math.abs(currentY - startY);
                
                if (diffY > diffX) {
                    isScrolling = true;
                }
            });
            
            container.addEventListener('touchend', (e) => {
                if (!startX || !startY || isScrolling) return;
                
                const endX = e.changedTouches[0].clientX;
                const diffX = startX - endX;
                
                if (Math.abs(diffX) > 50) {
                    if (diffX > 0) {
                        navigateCarousel(container, 1); // Swipe left = next
                    } else {
                        navigateCarousel(container, -1); // Swipe right = prev
                    }
                }
                
                startX = 0;
                startY = 0;
            });
        }

        function verificarPlanoPublicidade() {
            const plano = localStorage.getItem('planoEscolhido');
            const adBanner = document.getElementById('adBanner');

            if (plano) {
                const planoData = JSON.parse(plano);
                if (planoData.incluiAds) {
                    adBanner.classList.add('visible');
                }
            } else {
                adBanner.classList.add('visible');
            }
        }

        // Fun√ß√£o removida - funcionalidade movida para assets/js/header-auth.js

        document.getElementById('searchInput').addEventListener('input', buscarImoveis);

        // Fun√ß√£o para carregar cidades da Bahia da API do IBGE
        async function carregarCidadesBahia() {
            try {
                const response = await fetch('https://servicodados.ibge.gov.br/api/v1/localidades/estados/29/municipios');
                if (!response.ok) {
                    throw new Error('Erro ao buscar cidades');
                }
                const municipios = await response.json();
                
                // Ordenar por nome
                municipios.sort((a, b) => a.nome.localeCompare(b.nome, 'pt-BR'));
                
                // Popular o select
                const selectCidade = document.getElementById('filterCidade');
                if (selectCidade) {
                    // Limpar op√ß√µes existentes (exceto a primeira "Todas as cidades")
                    selectCidade.innerHTML = '<option value="">Todas as cidades</option>';
                    
                    // Adicionar cada cidade
                    municipios.forEach(municipio => {
                        const option = document.createElement('option');
                        option.value = municipio.nome;
                        option.textContent = municipio.nome;
                        selectCidade.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar cidades da Bahia:', error);
                // Em caso de erro, manter apenas a op√ß√£o padr√£o
            }
        }

        // Carregar cidades quando a p√°gina carregar
        window.addEventListener('DOMContentLoaded', function() {
            carregarCidadesBahia();
        });

        // Adicionar event listeners para filtro autom√°tico
        function adicionarEventListenersFiltros() {
            // Filtros de categoria
            document.getElementById('filterVenda').addEventListener('change', aplicarFiltros);
            document.getElementById('filterAluguel').addEventListener('change', aplicarFiltros);
            
            // Filtros de tipo
            document.getElementById('filterCasa').addEventListener('change', aplicarFiltros);
            document.getElementById('filterApartamento').addEventListener('change', aplicarFiltros);
            document.getElementById('filterTerreno').addEventListener('change', aplicarFiltros);
            document.getElementById('filterComercial').addEventListener('change', aplicarFiltros);
            
            // Filtros de pre√ßo
            document.getElementById('filterMinPrice').addEventListener('input', aplicarFiltros);
            document.getElementById('filterMaxPrice').addEventListener('input', aplicarFiltros);
            
            // Filtro de cidade
            document.getElementById('filterCidade').addEventListener('change', aplicarFiltros);
            
            // Novos filtros de quartos e banheiros
            document.getElementById('filterQuartos').addEventListener('change', aplicarFiltros);
            document.getElementById('filterBanheiros').addEventListener('change', aplicarFiltros);
            
            // Filtros de garagem
            document.getElementById('filterTemGaragem').addEventListener('change', function() {
                const temGaragem = this.checked;
                const vagasContainer = document.getElementById('filterVagasContainer');
                
                if (temGaragem) {
                    vagasContainer.style.display = 'block';
                } else {
                    vagasContainer.style.display = 'none';
                    // Limpar o valor do select quando desmarcar
                    document.getElementById('filterVagasGaragem').value = '';
                }
                
                aplicarFiltros();
            });
            document.getElementById('filterVagasGaragem').addEventListener('change', aplicarFiltros);
            
            // Filtros de caracter√≠sticas
            document.getElementById('filterPiscina').addEventListener('change', aplicarFiltros);
            document.getElementById('filterVistaMar').addEventListener('change', aplicarFiltros);
            document.getElementById('filterChurrasqueira').addEventListener('change', aplicarFiltros);
            document.getElementById('filterRoca').addEventListener('change', aplicarFiltros);
            document.getElementById('filterFesta').addEventListener('change', aplicarFiltros);
            document.getElementById('filterVaranda').addEventListener('change', aplicarFiltros);
            document.getElementById('filterQuintal').addEventListener('change', aplicarFiltros);
            document.getElementById('filterCoco').addEventListener('change', aplicarFiltros);
            document.getElementById('filterPoco').addEventListener('change', aplicarFiltros);
            document.getElementById('filterCasaVerao').addEventListener('change', aplicarFiltros);
        }

        // Fun√ß√µes de autentica√ß√£o ser√£o carregadas do assets/js/header-auth.js

        function aplicarFiltros() {
            const categoria = getCheckboxValues(['filterVenda', 'filterAluguel']);
            const tipo = getCheckboxValues(['filterCasa', 'filterApartamento', 'filterTerreno', 'filterComercial']);
            const precoMin = parseFloat(document.getElementById('filterMinPrice').value) || 0;
            const precoMax = parseFloat(document.getElementById('filterMaxPrice').value) || Infinity;
            const cidade = document.getElementById('filterCidade').value;
            const quartosMin = parseInt(document.getElementById('filterQuartos').value) || 0;
            const banheirosMin = parseInt(document.getElementById('filterBanheiros').value) || 0;
            const temGaragem = document.getElementById('filterTemGaragem').checked;
            const vagasMin = parseInt(document.getElementById('filterVagasGaragem').value) || 0;
            const caracteristicas = getCheckboxValues(['filterPiscina', 'filterVistaMar', 'filterChurrasqueira', 'filterRoca', 'filterFesta', 'filterVaranda', 'filterQuintal', 'filterCoco', 'filterPoco', 'filterCasaVerao']);
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            const filtrados = todosAnuncios.filter(anuncio => {
                const matchCategoria = categoria.length === 0 || categoria.includes(anuncio.categoria);
                const matchTipo = tipo.length === 0 || tipo.includes(anuncio.tipo);
                const matchPreco = anuncio.preco >= precoMin && anuncio.preco <= precoMax;
                // Match de cidade: converter ambas para mai√∫sculas para compara√ß√£o
                const matchCidade = !cidade || (anuncio.cidade && anuncio.cidade.toUpperCase() === cidade.toUpperCase());
                const matchQuartos = quartosMin === 0 || (anuncio.quartos && anuncio.quartos >= quartosMin);
                const matchBanheiros = banheirosMin === 0 || (anuncio.banheiros && anuncio.banheiros >= banheirosMin);
                const matchGaragem = !temGaragem || (anuncio.garagem === true);
                const matchVagas = vagasMin === 0 || (anuncio.vagasGaragem && anuncio.vagasGaragem >= vagasMin);
                const matchSearch = !searchTerm || anuncio.titulo.toLowerCase().includes(searchTerm) ||
                                  anuncio.localizacao.toLowerCase().includes(searchTerm);
                
                // Verificar caracter√≠sticas
                const matchCaracteristicas = caracteristicas.length === 0 || 
                    (anuncio.caracteristicas && caracteristicas.every(carac => anuncio.caracteristicas.includes(carac)));

                return matchCategoria && matchTipo && matchPreco && matchCidade && matchQuartos && 
                       matchBanheiros && matchGaragem && matchVagas && matchCaracteristicas && matchSearch;
            });

            renderizarAnuncios(filtrados);
            atualizarContador(filtrados.length);
            
            // Mostrar/esconder bot√£o de limpar filtros
            const clearBtn = document.getElementById('clearFiltersBtn');
            const temFiltrosAtivos = categoria.length > 0 || tipo.length > 0 || 
                                   precoMin > 0 || precoMax < Infinity || 
                                   cidade !== '' || quartosMin > 0 || banheirosMin > 0 ||
                                   temGaragem || vagasMin > 0 || caracteristicas.length > 0 || searchTerm !== '';
            
            if (temFiltrosAtivos) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
            }
        }

        function limparFiltros() {
            // Limpar todos os checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Limpar campos de pre√ßo
            document.getElementById('filterMinPrice').value = '';
            document.getElementById('filterMaxPrice').value = '';
            
            // Limpar selects
            document.getElementById('filterCidade').value = '';
            document.getElementById('filterQuartos').value = '';
            document.getElementById('filterBanheiros').value = '';
            document.getElementById('filterVagasGaragem').value = '';
            
            // Esconder campo de vagas de garagem
            document.getElementById('filterVagasContainer').style.display = 'none';
            
            // Limpar campo de busca
            document.getElementById('searchInput').value = '';
            
            // Aplicar filtros (que agora mostrar√° todos os resultados)
            aplicarFiltros();
        }

        function getCheckboxValues(ids) {
            return ids.filter(id => document.getElementById(id).checked).map(id => document.getElementById(id).value);
        }

        function ordenarResultados() {
            const sortBy = document.getElementById('sortSelect').value;
            const container = document.getElementById('listingsContainer');
            const cards = Array.from(container.children);

            cards.sort((a, b) => {
                const precoA = parseFloat(a.querySelector('.listing-price').textContent.replace(/[^\d]/g, ''));
                const precoB = parseFloat(b.querySelector('.listing-price').textContent.replace(/[^\d]/g, ''));

                switch(sortBy) {
                    case 'preco-menor':
                        return precoA - precoB;
                    case 'preco-maior':
                        return precoB - precoA;
                    case 'mais-recente':
                        return 0; // Implementar l√≥gica de data se necess√°rio
                    default:
                        return 0;
                }
            });

            cards.forEach(card => container.appendChild(card));
        }

        function atualizarContador(total) {
            const contador = document.getElementById('resultsCount');
            if (contador) {
                contador.textContent = `Encontrados ${total} im√≥veis`;
            }
            // Atualizar contador no modal mobile
            const mobileCount = document.getElementById('mobileFiltersCount');
            if (mobileCount) {
                mobileCount.textContent = total;
            }
        }

        // Fun√ß√µes para o modal mobile de filtros
        window.abrirFiltrosMobile = function() {
            const modal = document.getElementById('mobileFiltersModal');
            const body = document.getElementById('mobileFiltersBody');
            const sidebar = document.querySelector('.sidebar');
            
            if (!modal) {
                console.error('Modal n√£o encontrado!');
                return;
            }
            
            if (!sidebar) {
                console.error('Sidebar n√£o encontrado!');
                return;
            }
            
            if (!body) {
                console.error('Body do modal n√£o encontrado!');
                return;
            }
            
            // Limpar o body do modal
            body.innerHTML = '';
            
            // Copiar apenas os filhos do sidebar (filter-sections), n√£o o container sidebar
            const filterSections = sidebar.querySelectorAll('.filter-section');
            
            filterSections.forEach(section => {
                const clonedSection = section.cloneNode(true);
                body.appendChild(clonedSection);
            });
            
            // Sincronizar valores dos inputs do sidebar para o modal
            sidebar.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                const modalCheckbox = body.querySelector(`#${checkbox.id}`);
                if (modalCheckbox) {
                    modalCheckbox.checked = checkbox.checked;
                }
            });
            sidebar.querySelectorAll('input[type="number"], select').forEach(input => {
                const modalInput = body.querySelector(`#${input.id}`);
                if (modalInput) {
                    modalInput.value = input.value;
                }
            });
            
            // Re-adicionar event listeners aos filtros do modal
            adicionarEventListenersFiltrosMobile();
            
            // Atualizar contador
            atualizarContadorMobile();
            
            // Abrir modal
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        };

        window.fecharFiltrosMobile = function() {
            const modal = document.getElementById('mobileFiltersModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        };

        window.aplicarFiltrosMobile = function() {
            // Sincronizar valores do modal para o sidebar antes de aplicar
            const modalBody = document.getElementById('mobileFiltersBody');
            const sidebar = document.querySelector('.sidebar');
            
            if (modalBody && sidebar) {
                // Sincronizar checkboxes
                modalBody.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    const sidebarCheckbox = sidebar.querySelector(`#${checkbox.id}`);
                    if (sidebarCheckbox) {
                        sidebarCheckbox.checked = checkbox.checked;
                    }
                });
                // Sincronizar inputs e selects
                modalBody.querySelectorAll('input[type="number"], select').forEach(input => {
                    const sidebarInput = sidebar.querySelector(`#${input.id}`);
                    if (sidebarInput) {
                        sidebarInput.value = input.value;
                    }
                });
            }
            
            aplicarFiltros();
            window.fecharFiltrosMobile();
        };

        window.limparFiltrosMobile = function() {
            limparFiltros();
            atualizarContadorMobile();
        };

        function atualizarContadorMobile() {
            // Buscar valores do modal ou do sidebar (se modal n√£o estiver aberto)
            const modalBody = document.getElementById('mobileFiltersBody');
            
            // Fun√ß√£o auxiliar para buscar valores do container correto
            const getCheckboxValue = (id) => {
                // Primeiro tenta buscar no modal, depois no documento
                const el = modalBody ? modalBody.querySelector(`#${id}`) : document.getElementById(id);
                return el ? el.checked : false;
            };
            
            const getInputValue = (id) => {
                // Primeiro tenta buscar no modal, depois no documento
                const el = modalBody ? modalBody.querySelector(`#${id}`) : document.getElementById(id);
                return el ? el.value : '';
            };
            
            const categoria = [];
            if (getCheckboxValue('filterVenda')) categoria.push('venda');
            if (getCheckboxValue('filterAluguel')) categoria.push('aluguel');
            
            const tipo = [];
            if (getCheckboxValue('filterCasa')) tipo.push('casa');
            if (getCheckboxValue('filterApartamento')) tipo.push('apartamento');
            if (getCheckboxValue('filterTerreno')) tipo.push('terreno');
            if (getCheckboxValue('filterComercial')) tipo.push('comercial');
            
            const precoMin = parseFloat(getInputValue('filterMinPrice')) || 0;
            const precoMax = parseFloat(getInputValue('filterMaxPrice')) || Infinity;
            const cidade = getInputValue('filterCidade');
            const quartosMin = parseInt(getInputValue('filterQuartos')) || 0;
            const banheirosMin = parseInt(getInputValue('filterBanheiros')) || 0;
            const temGaragem = getCheckboxValue('filterTemGaragem');
            const vagasMin = parseInt(getInputValue('filterVagasGaragem')) || 0;
            
            const caracteristicas = [];
            ['filterPiscina', 'filterVistaMar', 'filterChurrasqueira', 'filterRoca', 'filterFesta', 
             'filterVaranda', 'filterQuintal', 'filterCoco', 'filterPoco', 'filterCasaVerao'].forEach(id => {
                if (getCheckboxValue(id)) {
                    const el = modalBody ? modalBody.querySelector(`#${id}`) : document.getElementById(id);
                    if (el) caracteristicas.push(el.value);
                }
            });
            
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';

            const filtrados = todosAnuncios.filter(anuncio => {
                const matchCategoria = categoria.length === 0 || categoria.includes(anuncio.categoria);
                const matchTipo = tipo.length === 0 || tipo.includes(anuncio.tipo);
                const matchPreco = anuncio.preco >= precoMin && anuncio.preco <= precoMax;
                // Match de cidade: converter ambas para mai√∫sculas para compara√ß√£o
                const matchCidade = cidade === '' || (anuncio.cidade && anuncio.cidade.toUpperCase() === cidade.toUpperCase());
                const matchQuartos = quartosMin === 0 || (anuncio.quartos && anuncio.quartos >= quartosMin);
                const matchBanheiros = banheirosMin === 0 || (anuncio.banheiros && anuncio.banheiros >= banheirosMin);
                const matchGaragem = !temGaragem || (anuncio.vagasGaragem && anuncio.vagasGaragem > 0);
                const matchVagas = vagasMin === 0 || (anuncio.vagasGaragem && anuncio.vagasGaragem >= vagasMin);
                const matchCaracteristicas = caracteristicas.length === 0 || 
                    (anuncio.caracteristicas && caracteristicas.every(carac => anuncio.caracteristicas.includes(carac)));
                const matchSearch = searchTerm === '' || 
                    (anuncio.titulo && anuncio.titulo.toLowerCase().includes(searchTerm)) ||
                    (anuncio.endereco && anuncio.endereco.toLowerCase().includes(searchTerm));

                return matchCategoria && matchTipo && matchPreco && matchCidade && matchQuartos && 
                       matchBanheiros && matchGaragem && matchVagas && matchCaracteristicas && matchSearch;
            });

            const mobileCount = document.getElementById('mobileFiltersCount');
            if (mobileCount) {
                mobileCount.textContent = filtrados.length;
            }
        }

        function adicionarEventListenersFiltrosMobile() {
            // Re-adicionar listeners para os filtros dentro do modal
            const modalBody = document.getElementById('mobileFiltersBody');
            if (!modalBody) return;

            // Filtros de categoria
            const filterVenda = modalBody.querySelector('#filterVenda');
            const filterAluguel = modalBody.querySelector('#filterAluguel');
            if (filterVenda) filterVenda.addEventListener('change', () => { atualizarContadorMobile(); });
            if (filterAluguel) filterAluguel.addEventListener('change', () => { atualizarContadorMobile(); });
            
            // Filtros de tipo
            ['filterCasa', 'filterApartamento', 'filterTerreno', 'filterComercial'].forEach(id => {
                const el = modalBody.querySelector(`#${id}`);
                if (el) el.addEventListener('change', () => { atualizarContadorMobile(); });
            });
            
            // Filtros de pre√ßo
            const filterMinPrice = modalBody.querySelector('#filterMinPrice');
            const filterMaxPrice = modalBody.querySelector('#filterMaxPrice');
            if (filterMinPrice) filterMinPrice.addEventListener('input', () => { atualizarContadorMobile(); });
            if (filterMaxPrice) filterMaxPrice.addEventListener('input', () => { atualizarContadorMobile(); });
            
            // Outros filtros
            ['filterCidade', 'filterQuartos', 'filterBanheiros', 'filterVagasGaragem'].forEach(id => {
                const el = modalBody.querySelector(`#${id}`);
                if (el) el.addEventListener('change', () => { atualizarContadorMobile(); });
            });
            
            // Filtro de garagem
            const filterTemGaragem = modalBody.querySelector('#filterTemGaragem');
            if (filterTemGaragem) {
                filterTemGaragem.addEventListener('change', function() {
                    const temGaragem = this.checked;
                    const vagasContainer = modalBody.querySelector('#filterVagasContainer');
                    if (vagasContainer) {
                        vagasContainer.style.display = temGaragem ? 'block' : 'none';
                    }
                    atualizarContadorMobile();
                });
            }
            
            // Filtros de caracter√≠sticas
            ['filterPiscina', 'filterVistaMar', 'filterChurrasqueira', 'filterRoca', 'filterFesta', 
             'filterVaranda', 'filterQuintal', 'filterCoco', 'filterPoco', 'filterCasaVerao'].forEach(id => {
                const el = modalBody.querySelector(`#${id}`);
                if (el) el.addEventListener('change', () => { atualizarContadorMobile(); });
            });
        }

        // Fun√ß√£o para ler par√¢metros da URL e preencher campo de busca
        function lerParametroBusca() {
            const urlParams = new URLSearchParams(window.location.search);
            const searchTerm = urlParams.get('search');
            if (searchTerm) {
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.value = decodeURIComponent(searchTerm);
                    // Aplicar filtros automaticamente ap√≥s preencher o campo
                    setTimeout(() => {
                        aplicarFiltros();
                    }, 500);
                }
            }
        }

        window.addEventListener('load', async function() {
            carregarAnunciosSalvos();
            adicionarEventListenersFiltros();
            
            // Aguardar um pouco para garantir que scripts est√£o carregados
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Carregar an√∫ncios do Supabase
            await carregarAnunciosDoSupabase();
            
            // Ler par√¢metro de busca da URL e aplicar filtros
            lerParametroBusca();
            
            // Aplicar filtros (ser√° chamado novamente por lerParametroBusca se houver termo de busca)
            if (!new URLSearchParams(window.location.search).get('search')) {
                aplicarFiltros();
            }
        });

        // Carregar header dinamicamente
        function loadHeader() {
            fetch('../../components/header-component.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('header-container').innerHTML = html;
                    
                    // Aguardar o header ser renderizado antes de carregar os scripts
                    setTimeout(() => {
                        // Carregar scripts na ordem correta
                        loadAuthScripts();
                    }, 100);
                })
                .catch(error => {
                });
        }

        // Carregar scripts de autentica√ß√£o na ordem correta
        function loadAuthScripts() {
            // Verificar se Supabase CDN j√° est√° carregado
            if (typeof window.supabase === 'undefined') {
                const supabaseCDN = document.createElement('script');
                supabaseCDN.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                supabaseCDN.onload = function() {
                    loadAuthService();
                };
                document.head.appendChild(supabaseCDN);
            } else {
                loadAuthService();
            }
        }

        function loadAuthService() {
            // Verificar se auth-service j√° est√° carregado
            if (typeof window.authService === 'undefined') {
                const authServiceScript = document.createElement('script');
                authServiceScript.src = '../../assets/js/supabase-auth-service.js';
                authServiceScript.onload = function() {
                    loadHeaderAuth();
                };
                document.head.appendChild(authServiceScript);
            } else {
                loadHeaderAuth();
            }
        }

        function loadHeaderAuth() {
            // Verificar se header-auth j√° est√° carregado
            if (!document.querySelector('script[src*="header-auth.js"]')) {
                const headerAuthScript = document.createElement('script');
                headerAuthScript.src = '../../assets/js/header-auth.js';
                headerAuthScript.onload = function() {
                    // For√ßar verifica√ß√£o ap√≥s carregar
                    setTimeout(() => {
                        if (typeof checkUserLogin === 'function') {
                            checkUserLogin();
                        }
                    }, 500);
                };
                document.head.appendChild(headerAuthScript);
            } else {
                // Script j√° est√° carregado, apenas verificar
                setTimeout(() => {
                    if (typeof checkUserLogin === 'function') {
                        checkUserLogin();
                    }
                }, 500);
            }
        }

        // ============================================
        // SISTEMA DE PUBLICIDADES
        // ============================================
        let publicidadesBanners = [];
        let publicidadeCurrentIndex = 0;
        let publicidadeInterval = null;

        // Fun√ß√£o para renderizar publicidades
        function renderizarPublicidades() {
            const slidesContainer = document.getElementById('publicidadesSlides');
            const dotsContainer = document.getElementById('publicidadesDots');
            const sliderSection = document.getElementById('publicidadesSlider');

            if (!slidesContainer || !sliderSection) return;

            if (publicidadesBanners.length === 0) {
                sliderSection.style.display = 'none';
                return;
            }

            sliderSection.style.display = 'block';
            slidesContainer.innerHTML = '';
            dotsContainer.innerHTML = '';

            publicidadesBanners.forEach((banner, index) => {
                const slide = document.createElement('div');
                slide.className = `publicidades-slide ${index === 0 ? 'active' : ''}`;
                
                const link = banner.link ? `<a href="${banner.link}" target="_blank" rel="noopener noreferrer">` : '';
                const linkClose = banner.link ? '</a>' : '';
                
                slide.innerHTML = `
                    ${link}
                        <img src="${banner.imagem}" alt="${banner.descricao}" onerror="this.style.display='none'">
                    ${linkClose}
                `;
                slidesContainer.appendChild(slide);

                const dot = document.createElement('div');
                dot.className = `publicidades-dot ${index === 0 ? 'active' : ''}`;
                dot.onclick = () => goToPublicidade(index);
                dotsContainer.appendChild(dot);
            });

            iniciarSliderPublicidades();
        }

        // Fun√ß√£o para navegar publicidades
        function navigatePublicidade(direction) {
            if (publicidadesBanners.length === 0) return;

            if (typeof direction === 'string') {
                publicidadeCurrentIndex += direction === 'next' ? 1 : -1;
            } else {
                publicidadeCurrentIndex += direction;
            }

            if (publicidadeCurrentIndex >= publicidadesBanners.length) {
                publicidadeCurrentIndex = 0;
            } else if (publicidadeCurrentIndex < 0) {
                publicidadeCurrentIndex = publicidadesBanners.length - 1;
            }

            goToPublicidade(publicidadeCurrentIndex);
        }

        // Fun√ß√£o para ir para publicidade espec√≠fica
        function goToPublicidade(index) {
            const slides = document.querySelectorAll('.publicidades-slide');
            const dots = document.querySelectorAll('.publicidades-dot');

            if (index >= publicidadesBanners.length || index < 0) return;

            publicidadeCurrentIndex = index;

            slides.forEach((slide, i) => {
                slide.classList.toggle('active', i === index);
            });

            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });

            reiniciarSliderPublicidades();
        }

        // Fun√ß√£o para iniciar slider autom√°tico
        function iniciarSliderPublicidades() {
            pararSliderPublicidades();
            if (publicidadesBanners.length <= 1) return;

            publicidadeInterval = setInterval(() => {
                navigatePublicidade(1);
            }, 5000);
        }

        // Fun√ß√£o para parar slider
        function pararSliderPublicidades() {
            if (publicidadeInterval) {
                clearInterval(publicidadeInterval);
                publicidadeInterval = null;
            }
        }

        // Fun√ß√£o para reiniciar slider
        function reiniciarSliderPublicidades() {
            pararSliderPublicidades();
            iniciarSliderPublicidades();
        }


        // Vari√°veis globais para armazenar clientes Supabase e subscriptions
        let publicidadesSupabaseClient = null;
        let publicidadesSubscription = null;
        let anunciosSupabaseClient = null;
        let anunciosSubscription = null;

        // Fun√ß√£o para configurar realtime subscription
        function configurarRealtimePublicidades(supabaseClient) {
            // Se j√° existe uma subscription, remover antes de criar nova
            if (publicidadesSubscription) {
                supabaseClient.removeChannel(publicidadesSubscription);
            }

            // Criar subscription para escutar mudan√ßas na tabela publicidades
            // Escutamos todas as mudan√ßas e filtramos no callback
            publicidadesSubscription = supabaseClient
                .channel('publicidades-realtime')
                .on(
                    'postgres_changes',
                    {
                        event: '*', // Escutar INSERT, UPDATE, DELETE
                        schema: 'public',
                        table: 'publicidades'
                    },
                    (payload) => {
                        // Quando houver mudan√ßa, verificar se afeta publicidades aprovadas, vis√≠veis e n√£o expiradas
                        const agora = new Date();
                        
                        if (payload.eventType === 'INSERT') {
                            // Nova publicidade inserida - verificar se est√° aprovada, vis√≠vel e n√£o expirada
                            const newRecord = payload.new;
                            if (newRecord && newRecord.aprovada === true && newRecord.visivel === true) {
                                // Verificar se n√£o est√° expirada (considerando data e hora)
                                const isNotExpired = !newRecord.data_fim_publicacao || new Date(newRecord.data_fim_publicacao) >= agora;
                                if (isNotExpired) {
                                    setTimeout(() => {
                                        carregarPublicidades();
                                    }, 500);
                                }
                            }
                        } else if (payload.eventType === 'UPDATE') {
                            // Publicidade atualizada - recarregar se estava ou agora est√° aprovada e vis√≠vel
                            const oldRecord = payload.old;
                            const newRecord = payload.new;
                            const wasVisible = oldRecord && oldRecord.aprovada === true && oldRecord.visivel === true;
                            const isVisible = newRecord && newRecord.aprovada === true && newRecord.visivel === true;
                            
                            // Verificar expira√ß√£o considerando data e hora
                            const wasNotExpired = !oldRecord?.data_fim_publicacao || new Date(oldRecord.data_fim_publicacao) >= agora;
                            const isNotExpired = !newRecord?.data_fim_publicacao || new Date(newRecord.data_fim_publicacao) >= agora;
                            
                            if ((wasVisible && wasNotExpired) || (isVisible && isNotExpired)) {
                                setTimeout(() => {
                                    carregarPublicidades();
                                }, 500);
                            }
                        } else if (payload.eventType === 'DELETE') {
                            // Publicidade deletada - sempre recarregar (pode ter sido removida)
                            setTimeout(() => {
                                carregarPublicidades();
                            }, 500);
                        }
                    }
                )
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        // Subscription ativa com sucesso
                    } else if (status === 'CHANNEL_ERROR') {
                        // Erro na subscription - tentar reconectar ap√≥s delay
                        setTimeout(() => {
                            if (publicidadesSupabaseClient) {
                                configurarRealtimePublicidades(publicidadesSupabaseClient);
                            }
                        }, 5000);
                    }
                });
        }

        // Fun√ß√£o para carregar publicidades do banco de dados
        async function carregarPublicidades() {
            try {
                // Aguardar carregamento do Supabase se necess√°rio
                if (typeof window.supabase === 'undefined') {
                    await new Promise((resolve) => {
                        const script = document.createElement('script');
                        script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                        script.onload = resolve;
                        document.head.appendChild(script);
                    });
                }

                // Obter cliente Supabase - sempre usar getSupabaseClient para garantir inst√¢ncia √∫nica
                let supabaseClient = null;
                
                // Prioridade 1: tentar usar getSupabaseClient (que gerencia singleton)
                if (typeof window.getSupabaseClient === 'function') {
                    supabaseClient = window.getSupabaseClient();
                }
                
                // Prioridade 2: se getSupabaseClient n√£o retornou nada, tentar authService
                if (!supabaseClient && typeof window.authService !== 'undefined' && window.authService && window.authService.isInitialized) {
                    supabaseClient = window.authService.getSupabase();
                }
                
                // Se ainda n√£o conseguiu, n√£o criar nova inst√¢ncia para evitar m√∫ltiplas inst√¢ncias
                if (!supabaseClient) {
                    return;
                }

                // Armazenar cliente globalmente para usar na subscription
                publicidadesSupabaseClient = supabaseClient;

                // Buscar publicidades aprovadas, vis√≠veis e n√£o expiradas
                // Usar timestamp completo (data + hora + minuto)
                const agora = new Date();
                const agoraISO = agora.toISOString();
                
                // Filtrar publicidades n√£o expiradas (considerando data e hora completa)
                // Primeiro buscar todas aprovadas e vis√≠veis que N√ÉO s√£o do admin
                // Se o campo admin n√£o existir ou for null, considerar como false (n√£o admin)
                // Buscar todas publicidades aprovadas e vis√≠veis
                // Filtrar por expira√ß√£o: data_fim_publicacao √© NULL ou >= agora
                const { data: publicidades, error } = await supabaseClient
                    .from('publicidades')
                    .select('*')
                    .eq('aprovada', true)
                    .eq('visivel', true)
                    .or(`data_fim_publicacao.is.null,data_fim_publicacao.gte.${agoraISO}`)
                    .order('criada_em', { ascending: false });
                
                // Filtro adicional no JavaScript para garantir compara√ß√£o correta (com hora/minuto)
                // E tamb√©m filtrar por admin (apenas false ou null)
                const publicidadesFiltradas = (publicidades || []).filter(pub => {
                    // Filtrar por admin: apenas publicidades que N√ÉO s√£o admin
                    if (pub.admin === true) {
                        return false;
                    }
                    
                    // Filtrar por expira√ß√£o
                    if (!pub.data_fim_publicacao) {
                        return true; // Sem data de expira√ß√£o = sempre v√°lida
                    }
                    const dataFim = new Date(pub.data_fim_publicacao);
                    return dataFim >= agora; // Compara√ß√£o com data e hora completa
                });

                if (error) {
                    throw error;
                }

                // Processar banners principais
                const todosBanners = [];
                (publicidadesFiltradas || []).forEach(pub => {
                    if (pub.banners_principais && Array.isArray(pub.banners_principais)) {
                        pub.banners_principais.forEach(banner => {
                            if (banner.ativo !== false && banner.imagem) {
                                todosBanners.push({
                                    id: `${pub.id}-${banner.imagem}`,
                                    imagem: banner.imagem,
                                    link: banner.link || pub.link_externo || '',
                                    descricao: pub.descricao || pub.titulo || ''
                                });
                            }
                        });
                    }
                });

                if (todosBanners.length === 0) {
                    document.getElementById('publicidadesSlider').style.display = 'none';
                    return;
                }

                publicidadesBanners = todosBanners;
                renderizarPublicidades();

                // Configurar realtime subscription ap√≥s carregar pela primeira vez
                if (publicidadesSupabaseClient && !publicidadesSubscription) {
                    configurarRealtimePublicidades(publicidadesSupabaseClient);
                }
            } catch (error) {
                // Em caso de erro, n√£o mostrar banners
            }
        }

        // Fun√ß√£o para configurar realtime subscription de an√∫ncios
        function configurarRealtimeAnuncios(supabaseClient) {
            // Se j√° existe uma subscription, remover antes de criar nova
            if (anunciosSubscription) {
                supabaseClient.removeChannel(anunciosSubscription);
            }

            // Criar subscription para escutar mudan√ßas na tabela anuncios
            anunciosSubscription = supabaseClient
                .channel('anuncios-realtime')
                .on(
                    'postgres_changes',
                    {
                        event: '*', // Escutar INSERT, UPDATE, DELETE
                        schema: 'public',
                        table: 'anuncios'
                    },
                    (payload) => {
                        // Quando houver mudan√ßa, recarregar an√∫ncios
                        const agora = new Date().toISOString();
                        
                        if (payload.eventType === 'INSERT') {
                            // Novo an√∫ncio inserido - verificar se est√° publicado e ativo
                            const newRecord = payload.new;
                            if (newRecord && newRecord.ativo === true && newRecord.status === 'publicado') {
                                const isNotExpired = !newRecord.data_fim_publicacao || new Date(newRecord.data_fim_publicacao) >= new Date(agora);
                                if (isNotExpired) {
                                    setTimeout(() => {
                                        carregarAnunciosDoSupabase();
                                    }, 500);
                                }
                            }
                        } else if (payload.eventType === 'UPDATE') {
                            // An√∫ncio atualizado - recarregar se estava ou agora est√° publicado e ativo
                            const oldRecord = payload.old;
                            const newRecord = payload.new;
                            const wasVisible = oldRecord && oldRecord.ativo === true && oldRecord.status === 'publicado';
                            const isVisible = newRecord && newRecord.ativo === true && newRecord.status === 'publicado';
                            
                            const wasNotExpired = !oldRecord?.data_fim_publicacao || new Date(oldRecord.data_fim_publicacao) >= new Date(agora);
                            const isNotExpired = !newRecord?.data_fim_publicacao || new Date(newRecord.data_fim_publicacao) >= new Date(agora);
                            
                            if ((wasVisible && wasNotExpired) || (isVisible && isNotExpired)) {
                                setTimeout(() => {
                                    carregarAnunciosDoSupabase();
                                }, 500);
                            }
                        } else if (payload.eventType === 'DELETE') {
                            // An√∫ncio deletado - sempre recarregar
                            setTimeout(() => {
                                carregarAnunciosDoSupabase();
                            }, 500);
                        }
                    }
                )
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        // Subscription ativa com sucesso
                    } else if (status === 'CHANNEL_ERROR') {
                        // Erro na subscription - tentar reconectar ap√≥s delay
                        setTimeout(() => {
                            if (anunciosSupabaseClient) {
                                configurarRealtimeAnuncios(anunciosSupabaseClient);
                            }
                        }, 5000);
                    }
                });
        }

        // Limpar subscriptions quando a p√°gina for fechada
        window.addEventListener('beforeunload', function() {
            if (publicidadesSubscription && publicidadesSupabaseClient) {
                publicidadesSupabaseClient.removeChannel(publicidadesSubscription);
            }
            if (anunciosSubscription && anunciosSupabaseClient) {
                anunciosSupabaseClient.removeChannel(anunciosSubscription);
            }
        });

        // Pausar sliders quando o usu√°rio passar o mouse sobre eles e carregar publicidades
        document.addEventListener('DOMContentLoaded', function() {
            loadHeader();
            
            // Aguardar um pouco para garantir que os elementos foram renderizados
            setTimeout(() => {
                // Carregar publicidades
                carregarPublicidades();
            }, 500);
        });

        // Scroll para o topo quando a p√°gina for carregada
        window.addEventListener('load', function() {
            window.scrollTo(0, 0);
        });

        // Tamb√©m scroll para o topo quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', function() {
            window.scrollTo(0, 0);
        });
    </script>
</body>
</html>
