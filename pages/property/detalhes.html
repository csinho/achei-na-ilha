<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Achei na Ilha - Detalhes do Im√≥vel</title>
    <link rel="icon" type="image/svg+xml" href="../../assets/images/logo-achei-na-ilha.png">
    <link rel="alternate icon" href="../../assets/images/logo-achei-na-ilha.png">
    <link rel="stylesheet" href="../../assets/css/header.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .main-content {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .property-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
        }

        .gallery {
            background: linear-gradient(135deg, #e0e0e0, #f5f5f5);
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .gallery-main {
            font-size: 120px;
        }

        .carousel-container {
            position: relative;
            width: 100%;
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .carousel-images {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
        }

        .carousel-image {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .carousel-image.active {
            opacity: 1;
        }

        .carousel-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
        }

        .carousel-button.prev {
            left: 15px;
        }

        .carousel-button.next {
            right: 15px;
        }

        .carousel-container:hover .carousel-button {
            opacity: 1;
        }

        .carousel-button:hover {
            background: rgba(0, 0, 0, 0.7);
        }

        .gallery-nav {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }

        .gallery-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
        }

        .gallery-dot.active {
            background: white;
        }

        .property-content {
            padding: 30px;
        }

        .property-header {
            margin-bottom: 25px;
        }

        .property-title {
            font-size: 32px;
            color: #333333;
            margin-bottom: 10px;
        }

        .property-price {
            font-size: 36px;
            color: #0077B6;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .property-location {
            color: #666;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .property-badges {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 8px 16px;
            background: #FFE8D6;
            color: #C9643B;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .property-details {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .detail-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e8f4fd;
            border-radius: 50%;
        }

        .detail-info {
            flex: 1;
        }

        .detail-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .detail-value {
            font-size: 16px;
            color: #333;
            font-weight: 600;
        }

        .characteristics {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .characteristic-tag {
            padding: 6px 12px;
            background: #e8f4fd;
            color: #0077B6;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .property-description {
            margin: 30px 0;
            line-height: 1.8;
            color: #333333;
        }

        .section-title {
            font-size: 22px;
            color: #333333;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .interaction-section {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            padding: 20px 0;
            border-top: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
        }

        .btn-like {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: 2px solid #0077B6;
            background: white;
            color: #0077B6;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-like:hover {
            background: #0077B6;
            color: white;
        }

        .btn-like.liked {
            background: #0077B6;
            color: white;
        }

        .btn-whatsapp {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: 2px solid #25D366;
            background: white;
            color: #25D366;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .btn-whatsapp:hover {
            background: #25D366;
            color: white;
        }

        .comment-section {
            margin-top: 30px;
        }

        .comment-form {
            margin-bottom: 30px;
        }

        .comment-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }

        .comment-input:focus {
            outline: none;
            border-color: #0077B6;
        }

        .btn-comment {
            margin-top: 10px;
            padding: 12px 30px;
            background: #6A994E;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-comment:hover {
            background: #567a3d;
        }

        .comments-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .comment {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 12px;
        }

        .comment-author {
            font-weight: 700;
            color: #333333;
            margin-bottom: 8px;
        }

        .comment-text {
            color: #666;
            line-height: 1.6;
        }

        .comment-date {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .message.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .contact-info {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 12px;
            margin-top: 30px;
        }

        .contact-title {
            font-weight: 700;
            margin-bottom: 10px;
        }

        .video-section {
            margin: 30px 0;
        }

        .video-placeholder {
            background: linear-gradient(135deg, #333333, #555555);
            height: 300px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
        }

        @media (max-width: 768px) {
            .property-title {
                font-size: 24px;
            }

            .property-price {
                font-size: 28px;
            }

            .gallery {
                height: 300px;
            }

            .gallery-main {
                font-size: 80px;
            }

            .property-details {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .detail-item {
                padding: 10px;
            }

            .detail-icon {
                width: 35px;
                height: 35px;
                font-size: 20px;
            }

            .characteristics {
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Header ser√° carregado via JavaScript -->
    <div id="header-container"></div>

    <div class="main-content">
        <div class="property-card">
            <div class="gallery">
                <div class="carousel-container">
                    <div class="carousel-images" id="galleryMain">
                        <!-- Imagens ser√£o carregadas via JavaScript -->
                    </div>
                    <button class="carousel-button prev" onclick="navigateCarousel(this.closest('.carousel-container'), -1)">‚Äπ</button>
                    <button class="carousel-button next" onclick="navigateCarousel(this.closest('.carousel-container'), 1)">‚Ä∫</button>
                </div>
                <div class="gallery-nav" id="galleryNav"></div>
            </div>

            <div class="property-content">
                <div id="message" class="message"></div>

                <div class="property-header">
                    <h1 class="property-title" id="propertyTitle">T√≠tulo do Im√≥vel</h1>
                    <div class="property-price" id="propertyPrice">R$ 0</div>
                    <div class="property-location" id="propertyLocation">üìç Localiza√ß√£o</div>
                    <div class="property-badges" id="propertyBadges"></div>
                </div>

                <div class="interaction-section">
                    <button class="btn-like" id="btnLike" onclick="curtirAnuncio()">
                        <span id="likeIcon">‚ô°</span>
                        <span id="likeText">Curtir</span>
                        <span id="likeCount">(0)</span>
                    </button>
                    <button class="btn-whatsapp" id="whatsappBtn" onclick="abrirWhatsApp()" style="display: none;">
                        üí¨ WhatsApp
                    </button>
                </div>

                <div class="property-details" id="propertyDetails">
                    <!-- Detalhes ser√£o carregados via JavaScript -->
                </div>

                <div class="section-title">Sobre o Im√≥vel</div>
                <div class="property-description" id="propertyDescription">
                    Descri√ß√£o do im√≥vel ser√° carregada aqui...
                </div>

                <div id="videoSection" class="video-section" style="display: none;">
                    <div class="section-title">V√≠deos do Im√≥vel</div>
                    <div class="video-placeholder">üé•</div>
                </div>

                <div class="contact-info">
                    <div class="contact-title">Interessado?</div>
                    <p>Entre em contato com o anunciante para mais informa√ß√µes sobre este im√≥vel.</p>
                </div>

                <div class="comment-section">
                    <div class="section-title">Coment√°rios</div>

                    <div class="comment-form" id="commentForm">
                        <textarea
                            id="commentInput"
                            class="comment-input"
                            placeholder="Deixe seu coment√°rio sobre este im√≥vel..."
                        ></textarea>
                        <button class="btn-comment" onclick="adicionarComentario()">
                            Enviar Coment√°rio
                        </button>
                    </div>

                    <div class="comments-list" id="commentsList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // URL da imagem padr√£o para an√∫ncios sem imagens
        const IMAGEM_PADRAO = 'https://images.tcdn.com.br/img/img_prod/734896/patch_cord_cat6_amarelo_sohoplus_50_centimetros_2525_1_546d22ba08fae4a55e7ad243dfdc8b90.jpeg';
        
        let anuncioAtual = null;

        // Fun√ß√µes do carrossel
        function navigateCarousel(container, direction) {
            const images = container.querySelectorAll('.carousel-image');
            const activeImage = container.querySelector('.carousel-image.active');
            let currentIndex = Array.from(images).indexOf(activeImage);
            
            // Remover classe active da imagem atual
            activeImage.classList.remove('active');
            
            // Calcular pr√≥ximo √≠ndice
            currentIndex += direction;
            
            // Loop infinito
            if (currentIndex >= images.length) {
                currentIndex = 0;
            } else if (currentIndex < 0) {
                currentIndex = images.length - 1;
            }
            
            // Adicionar classe active √† nova imagem
            images[currentIndex].classList.add('active');
        }

        function startCarousel(container) {
            const images = container.querySelectorAll('.carousel-image');
            if (images.length <= 1) return;
            
            // Limpar interval anterior se existir
            if (container.carouselInterval) {
                clearInterval(container.carouselInterval);
            }
            
            // Iniciar carrossel autom√°tico
            container.carouselInterval = setInterval(() => {
                navigateCarousel(container, 1);
            }, 3000);
        }

        function stopCarousel(container) {
            if (container.carouselInterval) {
                clearInterval(container.carouselInterval);
                container.carouselInterval = null;
            }
        }

        // Touch/swipe support
        function addSwipeSupport(container) {
            let startX = 0;
            let startY = 0;
            let isScrolling = false;
            
            container.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isScrolling = false;
            });
            
            container.addEventListener('touchmove', (e) => {
                if (!startX || !startY) return;
                
                const currentX = e.touches[0].clientX;
                const currentY = e.touches[0].clientY;
                const diffX = Math.abs(currentX - startX);
                const diffY = Math.abs(currentY - startY);
                
                if (diffY > diffX) {
                    isScrolling = true;
                }
            });
            
            container.addEventListener('touchend', (e) => {
                if (!startX || !startY || isScrolling) return;
                
                const endX = e.changedTouches[0].clientX;
                const diffX = startX - endX;
                
                if (Math.abs(diffX) > 50) {
                    if (diffX > 0) {
                        navigateCarousel(container, 1); // Swipe left = next
                    } else {
                        navigateCarousel(container, -1); // Swipe right = prev
                    }
                }
                
                startX = 0;
                startY = 0;
            });
        }

        async function carregarDetalhes() {
            const anuncioIdStr = localStorage.getItem('anuncioSelecionado');
            if (!anuncioIdStr) {
                window.location.href = 'busca.html';
                return;
            }
            // Tentar buscar do Supabase primeiro (se for UUID ou string)
            let anuncioDoSupabase = null;
            
            // Definir supabaseClient no escopo da fun√ß√£o para estar dispon√≠vel em toda a fun√ß√£o
            let supabaseClient = null;
            
            try {
                // Aguardar Supabase estar dispon√≠vel (pode levar um tempo para carregar)
                // Nota: supabaseClient j√° foi declarado no escopo da fun√ß√£o
                let attempts = 0;
                const maxAttempts = 20; // 10 segundos (20 * 500ms)
                
                while (!supabaseClient && attempts < maxAttempts) {
                    // Tentar obter do authService
                    if (typeof window.authService !== 'undefined' && window.authService) {
                        if (window.authService.isInitialized) {
                            supabaseClient = window.authService.getSupabase();
                        } else {
                            try {
                                await window.authService.initialize();
                                supabaseClient = window.authService.getSupabase();
                            } catch (e) {
                            }
                        }
                    }
                    
                    // Se n√£o conseguiu, criar cliente direto (an√¥nimo)
                    if (!supabaseClient && typeof window.supabase !== 'undefined') {
                        try {
                            supabaseClient = window.supabase.createClient(
                                'https://svgmuxdxxrapepbodbgv.supabase.co',
                                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2Z211eGR4eHJhcGVwYm9kYmd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MTU2MTQsImV4cCI6MjA3Njk5MTYxNH0.U0rQ8-EXC6b0dkcCQBoE-VuNjNgNQREvcs3fWfZ1UGM'
                            );
                        } catch (e) {
                        }
                    }
                    
                    if (!supabaseClient) {
                        attempts++;
                        if (attempts < maxAttempts) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    }
                }
                
                if (supabaseClient) {
                    // Primeiro, tentar buscar sem relacionamento (mais simples)
                    let { data: anuncio, error } = await supabaseClient
                        .from('anuncios')
                        .select(`
                            *,
                            imagens_anuncio:imagens_anuncio(url, principal, ordem)
                        `)
                        .eq('id', anuncioIdStr)
                        .single();
                    
                    if (error) {
                    } else if (anuncio) {
                        // Verificar se o an√∫ncio est√° pausado ou n√£o ativo - redirecionar se sim
                        if (anuncio.status === 'pausado' || !anuncio.ativo || anuncio.status === 'rascunho') {
                            // Redirecionar para listagem se an√∫ncio estiver pausado, inativo ou for rascunho
                            window.location.href = 'busca.html';
                            return;
                        }
                        
                        // Buscar dados do usu√°rio separadamente se necess√°rio
                        if (anuncio.usuario_id) {
                            try {
                                // Tentar buscar com cliente autenticado primeiro
                                let usuario = null;
                                let userError = null;
                                
                                // Tentar buscar dados do usu√°rio anunciante
                                const { data: usuarioData, error: errorBuscar } = await supabaseClient
                                    .from('users')
                                    .select('nome, email, telefone')
                                    .eq('id', anuncio.usuario_id)
                                    .maybeSingle(); // Usar maybeSingle para n√£o dar erro se n√£o encontrar
                                
                                if (!errorBuscar && usuarioData) {
                                    usuario = usuarioData;
                                } else {
                                    userError = errorBuscar;
                                    
                                    // Se der erro 406 (RLS), tentar criar cliente an√¥nimo para buscar
                                    if (userError && (userError.code === 'PGRST301' || userError.message?.includes('406') || userError.message?.includes('Not Acceptable'))) {
                                        try {
                                            // Criar cliente an√¥nimo para buscar dados p√∫blicos
                                            const anonClient = window.supabase?.createClient?.(
                                                'https://svgmuxdxxrapepbodbgv.supabase.co',
                                                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2Z211eGR4eHJhcGVwYm9kYmd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MTU2MTQsImV4cCI6MjA3Njk5MTYxNH0.U0rQ8-EXC6b0dkcCQBoE-VuNjNgNQREvcs3fWfZ1UGM'
                                            );
                                            
                                            if (anonClient) {
                                                const { data: usuarioAnon, error: errorAnon } = await anonClient
                                                    .from('users')
                                                    .select('nome, email, telefone')
                                                    .eq('id', anuncio.usuario_id)
                                                    .maybeSingle();
                                                
                                                if (!errorAnon && usuarioAnon) {
                                                    usuario = usuarioAnon;
                                                }
                                            }
                                        } catch (e) {
                                        }
                                    }
                                }
                                
                                if (usuario) {
                                    anuncio.anunciante_nome = usuario.nome;
                                    anuncio.anunciante_email = usuario.email;
                                    anuncio.anunciante_telefone = usuario.telefone;
                                } else {
                                }
                            } catch (e) {
                            }
                        }
                        
                        anuncioDoSupabase = anuncio;
                    } else {
                    }
                } else {
                }
            } catch (error) {
            }

            const anunciosExemplo = [
                {
                    id: 1,
                    titulo: "Casa de Praia com Vista para o Mar",
                    preco: 850000,
                    localizacao: "Praia do Centro",
                    tipo: "casa",
                    categoria: "venda",
                    emoji: "üèñÔ∏è",
                    quartos: 4,
                    banheiros: 3,
                    garagem: true,
                    vagasGaragem: 2,
                    caracteristicas: ["piscina", "vista-mar"],
                    imagens: [
                        "https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=800",
                        "https://images.unsplash.com/photo-1571896349842-33c89424de2d?w=800",
                        "https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?w=800"
                    ],
                    videos: [
                        "https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4"
                    ],
                    descricao: "Linda casa de praia com vista panor√¢mica para o mar. Possui 4 quartos, 3 banheiros, sala ampla, cozinha completa e √°rea de lazer com churrasqueira. Localizada a apenas 50 metros da praia, ideal para quem busca tranquilidade e qualidade de vida.",
                    likes: 12,
                    comentarios: [],
                    anunciante: {
                        nome: "Jo√£o Silva",
                        email: "joao.silva@email.com",
                        telefone: "71996755745"
                    }
                },
                {
                    id: 2,
                    titulo: "Apartamento Moderno 2 Quartos",
                    preco: 2500,
                    localizacao: "Centro da Ilha",
                    tipo: "apartamento",
                    categoria: "aluguel",
                    emoji: "üè¢",
                    quartos: 2,
                    banheiros: 1,
                    garagem: true,
                    vagasGaragem: 1,
                    caracteristicas: [],
                    imagens: [
                        "https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?w=800",
                        "https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800"
                    ],
                    videos: [],
                    descricao: "Apartamento moderno e bem localizado no centro da ilha. 2 quartos com arm√°rios, banheiro social, sala integrada com cozinha americana. Pr√©dio com elevador e √°rea de lazer completa.",
                    likes: 8,
                    comentarios: [],
                    anunciante: {
                        nome: "Maria Santos",
                        email: "maria.santos@email.com",
                        telefone: "71996755745"
                    }
                },
                {
                    id: 3,
                    titulo: "Terreno com 500m¬≤ Pr√≥ximo √† Praia",
                    preco: 350000,
                    localizacao: "Praia Grande",
                    tipo: "terreno",
                    categoria: "venda",
                    emoji: "üèùÔ∏è",
                    quartos: 0,
                    banheiros: 0,
                    garagem: false,
                    vagasGaragem: 0,
                    caracteristicas: [],
                    imagens: [
                        "https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=800"
                    ],
                    videos: [],
                    descricao: "Excelente terreno plano com 500m¬≤, localizado a apenas 200 metros da Praia Grande. Documenta√ß√£o em dia, √°rea residencial consolidada. Perfeito para construir a casa dos seus sonhos.",
                    likes: 5,
                    comentarios: [],
                    anunciante: {
                        nome: "Carlos Oliveira",
                        email: "carlos.oliveira@email.com",
                        telefone: "71996755745"
                    }
                },
                {
                    id: 4,
                    titulo: "Casa 3 Quartos com Piscina",
                    preco: 4500,
                    localizacao: "Bairro das Palmeiras",
                    tipo: "casa",
                    categoria: "aluguel",
                    emoji: "üèä",
                    quartos: 3,
                    banheiros: 2,
                    garagem: true,
                    vagasGaragem: 2,
                    caracteristicas: ["piscina"],
                    imagens: [
                        "https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?w=800",
                        "https://images.unsplash.com/photo-1571896349842-33c89424de2d?w=800",
                        "https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=800",
                        "https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?w=800"
                    ],
                    videos: [
                        "https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4"
                    ],
                    descricao: "Casa espa√ßosa com 3 quartos, sendo 1 su√≠te, √°rea de lazer completa com piscina, churrasqueira e espa√ßo gourmet. Garagem para 2 carros. Bairro tranquilo e familiar.",
                    likes: 15,
                    comentarios: [],
                    anunciante: {
                        nome: "Ana Costa",
                        email: "ana.costa@email.com",
                        telefone: "71996755745"
                    }
                },
                {
                    id: 5,
                    titulo: "Loja Comercial no Centro",
                    preco: 3000,
                    localizacao: "Rua Principal",
                    tipo: "comercial",
                    categoria: "aluguel",
                    emoji: "üè™",
                    quartos: 0,
                    banheiros: 1,
                    garagem: false,
                    vagasGaragem: 0,
                    caracteristicas: [],
                    imagens: [
                        "https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=800"
                    ],
                    videos: [],
                    descricao: "Loja comercial em ponto estrat√©gico na rua principal. √ìtima para diversos tipos de neg√≥cio. 80m¬≤ com banheiro e espa√ßo para estoque.",
                    likes: 3,
                    comentarios: [],
                    anunciante: {
                        nome: "Roberto Lima",
                        email: "roberto.lima@email.com",
                        telefone: "71996755745"
                    }
                },
                {
                    id: 6,
                    titulo: "Cobertura Duplex Vista Mar",
                    preco: 1200000,
                    localizacao: "Orla da Praia",
                    tipo: "apartamento",
                    categoria: "venda",
                    emoji: "üåÖ",
                    quartos: 3,
                    banheiros: 3,
                    garagem: true,
                    vagasGaragem: 2,
                    caracteristicas: ["vista-mar"],
                    imagens: [
                        "https://images.unsplash.com/photo-1571896349842-33c89424de2d?w=800",
                        "https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?w=800",
                        "https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=800"
                    ],
                    videos: [
                        "https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4"
                    ],
                    descricao: "Cobertura duplex de alto padr√£o com vista privilegiada para o mar. 3 su√≠tes, sala de estar e jantar, cozinha planejada, lavabo, √°rea gourmet completa. 2 vagas de garagem.",
                    likes: 25,
                    comentarios: [],
                    anunciante: {
                        nome: "Fernanda Alves",
                        email: "fernanda.alves@email.com",
                        telefone: "71996755745"
                    }
                }
            ];

            // Se encontrou no Supabase, usar esses dados
            if (anuncioDoSupabase) {
                // Converter formato do banco para formato usado na p√°gina (usar imagem padr√£o se n√£o tiver)
                const imagens = anuncioDoSupabase.imagens_anuncio && anuncioDoSupabase.imagens_anuncio.length > 0
                    ? anuncioDoSupabase.imagens_anuncio
                        .sort((a, b) => (a.ordem || 0) - (b.ordem || 0))
                        .map(img => img.url)
                    : [IMAGEM_PADRAO];

                // Buscar coment√°rios do banco - garantir que temos o cliente Supabase
                let comentariosDB = [];
                let supabaseClientParaComentarios = supabaseClient;
                
                // Se n√£o temos o cliente, tentar obter novamente
                if (!supabaseClientParaComentarios) {
                    if (typeof window.authService !== 'undefined' && window.authService && window.authService.isInitialized) {
                        supabaseClientParaComentarios = window.authService.getSupabase();
                    } else if (typeof window.supabase !== 'undefined') {
                        try {
                            supabaseClientParaComentarios = window.supabase.createClient(
                                'https://svgmuxdxxrapepbodbgv.supabase.co',
                                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2Z211eGR4eHJhcGVwYm9kYmd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MTU2MTQsImV4cCI6MjA3Njk5MTYxNH0.U0rQ8-EXC6b0dkcCQBoE-VuNjNgNQREvcs3fWfZ1UGM'
                            );
                        } catch (e) {
                        }
                    }
                }
                
                try {
                    // Primeiro, buscar coment√°rios sem relacionamento
                    const { data: comentarios, error: comentariosError } = await supabaseClientParaComentarios
                        .from('comentarios')
                        .select('*')
                        .eq('anuncio_id', anuncioDoSupabase.id)
                        .order('criado_em', { ascending: false });
                    
                    if (!comentariosError && comentarios && comentarios.length > 0) {
                        // Buscar nomes dos usu√°rios separadamente
                        // Verificar se usa usuario_id ou visitante_id (migration pode n√£o ter sido aplicada)
                        const userIdColumn = comentarios[0].usuario_id !== undefined ? 'usuario_id' : 'visitante_id';
                        const usuariosIds = [...new Set(comentarios.map(c => c[userIdColumn] || c.visitante_id).filter(Boolean))];
                        
                        
                        let usuariosMap = {};
                        if (usuariosIds.length > 0) {
                            const { data: usuarios, error: usuariosError } = await supabaseClientParaComentarios
                                .from('users')
                                .select('id, nome, email')
                                .in('id', usuariosIds);
                            
                            if (!usuariosError && usuarios && usuarios.length > 0) {
                                usuariosMap = usuarios.reduce((acc, u) => {
                                    acc[u.id] = u;
                                    return acc;
                                }, {});
                            } else {
                                
                                // Tentar buscar um por um se o .in() falhar
                                if (usuariosError) {
                                    for (const userId of usuariosIds) {
                                        try {
                                            const { data: usuario, error: userError } = await supabaseClientParaComentarios
                                                .from('users')
                                                .select('id, nome, email')
                                                .eq('id', userId)
                                                .maybeSingle();
                                            
                                            if (!userError && usuario) {
                                                usuariosMap[userId] = usuario;
                                            } else {
                                            }
                                        } catch (e) {
                                        }
                                    }
                                }
                            }
                        } else {
                        }
                        
                        comentariosDB = comentarios.map(com => {
                            const userId = com.usuario_id || com.visitante_id;
                            const usuario = usuariosMap[userId];
                            const nomeAutor = usuario?.nome || 'Usu√°rio';
                            
                            if (!usuario) {
                            }
                            
                            return {
                                id: com.id,
                                autor: nomeAutor,
                                autor_id: userId,
                                texto: com.texto,
                                data: com.criado_em || com.atualizado_em
                            };
                        });
                    }
                } catch (e) {
                }
                
                // Buscar likes do banco - usar o mesmo cliente
                let likesCount = 0;
                try {
                    if (!supabaseClientParaComentarios) {
                        // Tentar obter cliente novamente
                        if (typeof window.authService !== 'undefined' && window.authService && window.authService.isInitialized) {
                            supabaseClientParaComentarios = window.authService.getSupabase();
                        } else if (typeof window.supabase !== 'undefined') {
                            try {
                                supabaseClientParaComentarios = window.supabase.createClient(
                                    'https://svgmuxdxxrapepbodbgv.supabase.co',
                                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2Z211eGR4eHJhcGVwYm9kYmd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MTU2MTQsImV4cCI6MjA3Njk5MTYxNH0.U0rQ8-EXC6b0dkcCQBoE-VuNjNgNQREvcs3fWfZ1UGM'
                                );
                            } catch (e) {
                            }
                        }
                    }
                    
                    const { count, error: likesError } = await supabaseClientParaComentarios
                        .from('likes')
                        .select('*', { count: 'exact', head: true })
                        .eq('anuncio_id', anuncioDoSupabase.id);
                    
                    if (!likesError && count !== null) {
                        likesCount = count;
                    }
                } catch (e) {
                }

                anuncioAtual = {
                    id: anuncioDoSupabase.id,
                    usuario_id: anuncioDoSupabase.usuario_id, // IMPORTANTE: ID do dono do an√∫ncio
                    titulo: anuncioDoSupabase.titulo,
                    preco: parseFloat(anuncioDoSupabase.valor),
                    localizacao: anuncioDoSupabase.endereco || anuncioDoSupabase.bairro || anuncioDoSupabase.cidade || 'Localiza√ß√£o n√£o informada',
                    tipo: anuncioDoSupabase.tipo_imovel,
                    categoria: anuncioDoSupabase.categoria,
                    emoji: anuncioDoSupabase.emoji || 'üè†',
                    quartos: anuncioDoSupabase.quartos || 0,
                    banheiros: anuncioDoSupabase.banheiros || 0,
                    garagem: (anuncioDoSupabase.vagas_garagem && anuncioDoSupabase.vagas_garagem > 0) || false,
                    vagasGaragem: anuncioDoSupabase.vagas_garagem || 0,
                    caracteristicas: anuncioDoSupabase.caracteristicas || [],
                    imagens: imagens,
                    videos: [], // TODO: Adicionar v√≠deos quando implementar
                    descricao: anuncioDoSupabase.descricao || 'Sem descri√ß√£o',
                    likes: likesCount,
                    comentarios: comentariosDB,
                    anunciante: {
                        nome: anuncioDoSupabase.anunciante_nome || 'Anunciante',
                        email: anuncioDoSupabase.anunciante_email || '',
                        telefone: anuncioDoSupabase.anunciante_telefone || ''
                    }
                };
            } else {
                // Tentar buscar em dados est√°ticos (para compatibilidade)
                const anuncioId = parseInt(anuncioIdStr);
                if (!isNaN(anuncioId)) {
                    anuncioAtual = anunciosExemplo.find(a => a.id === anuncioId);
                    if (anuncioAtual) {
                    } else {
                    }
                } else {
                }
            }

            if (!anuncioAtual) {
                alert('An√∫ncio n√£o encontrado. Redirecionando para busca...');
                window.location.href = 'busca.html';
                return;
            }

            // Coment√°rios e likes j√° foram carregados do banco de dados (Supabase)
            // N√£o carregar mais do localStorage
            try {
                const propertyTitleEl = document.getElementById('propertyTitle');
                if (!propertyTitleEl) {
                    throw new Error('Elemento propertyTitle n√£o encontrado');
                }
                propertyTitleEl.innerHTML = `
                    <span style="font-size: 24px; margin-right: 8px;">${anuncioAtual.emoji || 'üè†'}</span>
                    ${anuncioAtual.titulo || 'Sem t√≠tulo'}
                `;
            } catch (e) {
                throw e;
            }
            
            // Verificar se usu√°rio est√° logado para mostrar pre√ßo e localiza√ß√£o
            let isLoggedIn = false;
            try {
                isLoggedIn = await verificarUsuarioLogado();
            } catch (e) {
                isLoggedIn = false;
            }
            try {
                if (isLoggedIn) {
                    const priceEl = document.getElementById('propertyPrice');
                    const locationEl = document.getElementById('propertyLocation');
                    if (priceEl) {
                        priceEl.textContent = `R$ ${(anuncioAtual.preco || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    }
                    if (locationEl) {
                        locationEl.textContent = `üìç ${anuncioAtual.localizacao || 'Localiza√ß√£o n√£o informada'}`;
                    }
                } else {
                    const priceEl = document.getElementById('propertyPrice');
                    const locationEl = document.getElementById('propertyLocation');
                    if (priceEl) {
                        priceEl.innerHTML = `
                            <span style="color: #666; font-size: 18px;">
                                üîí <a href="../auth/login.html" style="color: #0077B6; text-decoration: none;">Fa√ßa login</a> para ver o pre√ßo
                            </span>
                        `;
                    }
                    if (locationEl) {
                        locationEl.innerHTML = `
                            <span style="color: #666;">
                                üîí <a href="../auth/login.html" style="color: #0077B6; text-decoration: none;">Fa√ßa login</a> para ver o endere√ßo
                            </span>
                        `;
                    }
                }
            } catch (e) {
                // N√£o lan√ßar erro, continuar
            }
            
            try {
                const descEl = document.getElementById('propertyDescription');
                if (descEl) {
                    descEl.textContent = anuncioAtual.descricao || 'Sem descri√ß√£o';
                }
            } catch (e) {
                // N√£o lan√ßar erro, continuar
            }
            
            // Atualizar galeria com carrossel (usar imagem padr√£o se n√£o tiver)
            const galleryMain = document.getElementById('galleryMain');
            const imagensParaExibir = anuncioAtual.imagens && anuncioAtual.imagens.length > 0 
                ? anuncioAtual.imagens 
                : [IMAGEM_PADRAO];
            
            galleryMain.innerHTML = imagensParaExibir.map((img, index) => 
                `<img src="${img}" alt="${anuncioAtual.titulo}" class="carousel-image ${index === 0 ? 'active' : ''}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='${IMAGEM_PADRAO}'">`
            ).join('');

            const badgesContainer = document.getElementById('propertyBadges');
            badgesContainer.innerHTML = `
                <span class="badge">${anuncioAtual.categoria === 'venda' ? 'Venda' : 'Aluguel'}</span>
                <span class="badge">${anuncioAtual.tipo}</span>
            `;

            // Renderizar detalhes do im√≥vel
            renderizarDetalhesImovel();

            document.getElementById('likeCount').textContent = `(${anuncioAtual.likes})`;

            // Recarregar coment√°rios e likes do banco para garantir dados atualizados
            try {
                await recarregarComentariosELikes();
            } catch (e) {
                // N√£o lan√ßar erro, continuar
            }
            
            try {
                await verificarLike();
            } catch (e) {
                // N√£o lan√ßar erro, continuar
            }
            
            // Verificar se usu√°rio √© dono do an√∫ncio e desabilitar curtir/comentar
            await verificarSeEDonoDoAnuncio();
            
            // Inicializar carrossel ap√≥s carregar as imagens
            setTimeout(() => {
                const container = document.querySelector('.carousel-container');
                if (container) {
                    startCarousel(container);
                    addSwipeSupport(container);
                }
            }, 100);
            
            // Verificar se deve mostrar bot√£o WhatsApp
            await verificarBotaoWhatsApp();
            await verificarPermissaoComentario();
            
            // Aguardar um pouco e verificar novamente (caso o authService carregue depois)
            setTimeout(async () => {
                await atualizarUIComLogin();
                await verificarSeEDonoDoAnuncio(); // Verificar novamente ap√≥s auth carregar
            }, 1500);
        }

        function renderizarDetalhesImovel() {
            const detailsContainer = document.getElementById('propertyDetails');
            
            let detailsHTML = '';
            
            // Quartos
            if (anuncioAtual.quartos > 0) {
                detailsHTML += `
                    <div class="detail-item">
                        <div class="detail-icon">üõèÔ∏è</div>
                        <div class="detail-info">
                            <div class="detail-label">Quartos</div>
                            <div class="detail-value">${anuncioAtual.quartos} quarto${anuncioAtual.quartos > 1 ? 's' : ''}</div>
                        </div>
                    </div>
                `;
            }
            
            // Banheiros
            if (anuncioAtual.banheiros > 0) {
                detailsHTML += `
                    <div class="detail-item">
                        <div class="detail-icon">üöø</div>
                        <div class="detail-info">
                            <div class="detail-label">Banheiros</div>
                            <div class="detail-value">${anuncioAtual.banheiros} banheiro${anuncioAtual.banheiros > 1 ? 's' : ''}</div>
                        </div>
                    </div>
                `;
            }
            
            // Garagem
            if (anuncioAtual.garagem) {
                detailsHTML += `
                    <div class="detail-item">
                        <div class="detail-icon">üöó</div>
                        <div class="detail-info">
                            <div class="detail-label">Garagem</div>
                            <div class="detail-value">${anuncioAtual.vagasGaragem} vaga${anuncioAtual.vagasGaragem > 1 ? 's' : ''}</div>
                        </div>
                    </div>
                `;
            }
            
            // Caracter√≠sticas especiais
            if (anuncioAtual.caracteristicas && anuncioAtual.caracteristicas.length > 0) {
                const characteristicsHTML = anuncioAtual.caracteristicas.map(carac => {
                    const labels = {
                        'piscina': 'üèä Piscina',
                        'vista-mar': 'üåÖ Vista para o Mar',
                        'garagem': 'üöó Garagem'
                    };
                    return `<span class="characteristic-tag">${labels[carac] || carac}</span>`;
                }).join('');
                
                detailsHTML += `
                    <div class="detail-item" style="grid-column: 1 / -1;">
                        <div class="detail-icon">‚≠ê</div>
                        <div class="detail-info">
                            <div class="detail-label">Caracter√≠sticas</div>
                            <div class="characteristics">${characteristicsHTML}</div>
                        </div>
                    </div>
                `;
            }
            
            detailsContainer.innerHTML = detailsHTML;
        }

        async function verificarUsuarioLogado() {
            // Verificar via Supabase Auth (usar window.authService)
            let service = null;
            if (typeof window.authService !== 'undefined') {
                service = window.authService;
            } else if (typeof authService !== 'undefined') {
                service = authService;
            }
            
            if (service) {
                try {
                    if (!service.isInitialized) {
                        await service.initialize();
                    }
                    const user = await service.getCurrentUser();
                    return !!user;
                } catch (error) {
                }
            }
            
            // Fallback: verificar token no localStorage
            const tokenKey = Object.keys(localStorage).find(key => key.includes('supabase') && key.includes('auth-token'));
            if (tokenKey) {
                try {
                    const tokenData = JSON.parse(localStorage.getItem(tokenKey));
                    const hasToken = !!(tokenData && tokenData.access_token);
                    return hasToken;
                } catch (e) {
                    return false;
                }
            }
            return false;
        }

        async function verificarSeEDonoDoAnuncio() {
            // Verificar se o an√∫ncio tem usuario_id (vindo do Supabase)
            if (!anuncioAtual.usuario_id) {
                return false;
            }

            try {
                let service = null;
                if (typeof window.authService !== 'undefined') {
                    service = window.authService;
                } else if (typeof authService !== 'undefined') {
                    service = authService;
                }

                if (!service) {
                    return false;
                }

                if (!service.isInitialized) {
                    await service.initialize();
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                const user = await service.getCurrentUser();
                if (!user) {
                    return false;
                }

                const isDono = user.id === anuncioAtual.usuario_id;
                
                if (isDono) {
                    // Desabilitar bot√£o de curtir
                    const btnLike = document.getElementById('btnLike');
                    if (btnLike) {
                        btnLike.disabled = true;
                        btnLike.style.opacity = '0.6';
                        btnLike.style.cursor = 'not-allowed';
                        btnLike.title = 'Voc√™ n√£o pode curtir seu pr√≥prio an√∫ncio';
                        btnLike.onclick = null; // Remover onclick
                    }
                    
                    // Esconder/desabilitar formul√°rio de coment√°rios
                    const commentForm = document.getElementById('commentForm');
                    if (commentForm) {
                        commentForm.style.display = 'none';
                        // Ou mostrar mensagem
                        const commentSection = document.querySelector('.comment-section');
                        if (commentSection && !commentSection.querySelector('.owner-message')) {
                            const message = document.createElement('div');
                            message.className = 'owner-message';
                            message.style.cssText = 'text-align: center; padding: 20px; color: #666; background: #f5f5f5; border-radius: 8px; margin-bottom: 20px;';
                            message.innerHTML = 'üë§ Voc√™ √© o dono deste an√∫ncio. Voc√™ pode ver os coment√°rios, mas n√£o pode comentar ou curtir.';
                            commentSection.insertBefore(message, commentForm);
                        }
                    }
                }
                
                return isDono;
            } catch (error) {
                return false;
            }
        }

        async function curtirAnuncio() {
            const isLoggedIn = await verificarUsuarioLogado();
            if (!isLoggedIn) {
                showMessage('Fa√ßa login para curtir este an√∫ncio', 'error');
                window.location.href = '../auth/login.html';
                return;
            }

            // Verificar se √© dono do an√∫ncio
            const isDono = await verificarSeEDonoDoAnuncio();
            if (isDono) {
                showMessage('Voc√™ n√£o pode curtir seu pr√≥prio an√∫ncio', 'error');
                return;
            }

            try {
                // Obter usu√°rio logado e Supabase
                let service = null;
                let user = null;
                
                if (typeof window.authService !== 'undefined') {
                    service = window.authService;
                } else if (typeof authService !== 'undefined') {
                    service = authService;
                }

                if (!service) {
                    showMessage('Erro ao conectar com o servidor', 'error');
                    return;
                }

                if (!service.isInitialized) {
                    await service.initialize();
                }

                user = await service.getCurrentUser();
                if (!user) {
                    showMessage('Erro ao identificar usu√°rio', 'error');
                    return;
                }

                const supabase = service.getSupabase();
                if (!supabase) {
                    showMessage('Erro ao conectar com o banco de dados', 'error');
                    return;
                }

                // Verificar se o usu√°rio j√° curtiu este an√∫ncio
                const { data: likeExistente, error: errorVerificar } = await supabase
                    .from('likes')
                    .select('id')
                    .eq('anuncio_id', anuncioAtual.id)
                    .eq('usuario_id', user.id)
                    .maybeSingle(); // Usar maybeSingle() ao inv√©s de single() para n√£o dar erro quando n√£o encontra

                if (errorVerificar && errorVerificar.code !== 'PGRST116') { // PGRST116 = n√£o encontrado (esperado)
                    showMessage('Erro ao verificar curtida', 'error');
                    return;
                }

                if (likeExistente) {
                    // Remover like (descurtir)
                    const { error: errorRemover } = await supabase
                        .from('likes')
                        .delete()
                        .eq('id', likeExistente.id);

                    if (errorRemover) {
                        showMessage('Erro ao remover curtida', 'error');
                        return;
                    }

                    // Atualizar contador
                    const { count, error: errorCount } = await supabase
                        .from('likes')
                        .select('*', { count: 'exact', head: true })
                        .eq('anuncio_id', anuncioAtual.id);

                    if (!errorCount && count !== null) {
                        anuncioAtual.likes = count;
                    } else {
                        anuncioAtual.likes = Math.max(0, anuncioAtual.likes - 1);
                    }

                    document.getElementById('likeIcon').textContent = '‚ô°';
                    document.getElementById('likeText').textContent = 'Curtir';
                    document.getElementById('btnLike').classList.remove('liked');
                    document.getElementById('likeCount').textContent = `(${anuncioAtual.likes})`;
                    showMessage('Curtida removida', 'success');
                    
                    // Recarregar dados do banco para garantir sincroniza√ß√£o
                    await recarregarComentariosELikes(false); // false = apenas likes, n√£o coment√°rios
                } else {
                    // Adicionar like
                    const { error: errorInserir } = await supabase
                        .from('likes')
                        .insert([{
                            anuncio_id: anuncioAtual.id,
                            usuario_id: user.id
                        }]);

                    if (errorInserir) {
                        showMessage('Erro ao curtir: ' + (errorInserir.message || 'Erro desconhecido'), 'error');
                        return;
                    }

                    // Atualizar contador
                    const { count, error: errorCount } = await supabase
                        .from('likes')
                        .select('*', { count: 'exact', head: true })
                        .eq('anuncio_id', anuncioAtual.id);

                    if (!errorCount && count !== null) {
                        anuncioAtual.likes = count;
                    } else {
                        anuncioAtual.likes++;
                    }

                    document.getElementById('likeIcon').textContent = '‚ô•';
                    document.getElementById('likeText').textContent = 'Curtido';
                    document.getElementById('btnLike').classList.add('liked');
                    document.getElementById('likeCount').textContent = `(${anuncioAtual.likes})`;
                    showMessage('Im√≥vel curtido!', 'success');
                    
                    // Recarregar dados do banco para garantir sincroniza√ß√£o
                    await recarregarComentariosELikes(false); // false = apenas likes, n√£o coment√°rios
                }
            } catch (error) {
                showMessage('Erro ao curtir an√∫ncio: ' + (error.message || 'Erro desconhecido'), 'error');
            }
        }

        async function verificarLike() {
            try {
                // Verificar se usu√°rio est√° logado
                const isLoggedIn = await verificarUsuarioLogado();
                if (!isLoggedIn || !anuncioAtual.usuario_id) {
                    return;
                }

                // Obter usu√°rio logado e Supabase
                let service = null;
                let user = null;
                
                if (typeof window.authService !== 'undefined') {
                    service = window.authService;
                } else if (typeof authService !== 'undefined') {
                    service = authService;
                }

                if (!service) {
                    return;
                }

                if (!service.isInitialized) {
                    await service.initialize();
                }

                user = await service.getCurrentUser();
                if (!user) {
                    return;
                }

                const supabase = service.getSupabase();
                if (!supabase) {
                    return;
                }

                // Verificar se o usu√°rio j√° curtiu este an√∫ncio
                const { data: likeExistente, error } = await supabase
                    .from('likes')
                    .select('id')
                    .eq('anuncio_id', anuncioAtual.id)
                    .eq('usuario_id', user.id)
                    .maybeSingle(); // Usar maybeSingle() ao inv√©s de single() para n√£o dar erro quando n√£o encontra

                if (!error && likeExistente) {
                    document.getElementById('likeIcon').textContent = '‚ô•';
                    document.getElementById('likeText').textContent = 'Curtido';
                    document.getElementById('btnLike').classList.add('liked');
                }
            } catch (error) {
            }
        }

        async function adicionarComentario() {
            const isLoggedIn = await verificarUsuarioLogado();
            if (!isLoggedIn) {
                showMessage('Fa√ßa login para comentar', 'error');
                window.location.href = '../auth/login.html';
                return;
            }
            
            // Verificar se √© dono do an√∫ncio
            const isDono = await verificarSeEDonoDoAnuncio();
            if (isDono) {
                showMessage('Voc√™ n√£o pode comentar no seu pr√≥prio an√∫ncio', 'error');
                return;
            }

            const comentarioInput = document.getElementById('commentInput');
            const texto = comentarioInput.value.trim();

            if (!texto) {
                showMessage('Digite um coment√°rio', 'error');
                return;
            }

            try {
                // Obter usu√°rio logado
                let service = null;
                let user = null;
                let userProfile = null;
                
                if (typeof window.authService !== 'undefined') {
                    service = window.authService;
                } else if (typeof authService !== 'undefined') {
                    service = authService;
                }

                if (service) {
                    if (!service.isInitialized) {
                        await service.initialize();
                    }
                    user = await service.getCurrentUser();
                    
                    if (user) {
                        userProfile = await service.getCurrentUserProfile();
                    }
                }

                if (!user) {
                    showMessage('Erro ao identificar usu√°rio', 'error');
                    return;
                }

                const supabase = service ? service.getSupabase() : null;
                if (!supabase) {
                    showMessage('Erro ao conectar com o banco de dados. Tente novamente.', 'error');
                    return;
                }

                // Salvar coment√°rio no Supabase
                // Nota: A tabela deve usar usuario_id (se migration foi aplicada) ou visitante_id (se n√£o foi)
                let comentarioSalvo;
                let insertError = null;
                
                // Tentar com usuario_id primeiro (se migration foi aplicada)
                const { data: comentarioComUsuarioId, error: errorUsuarioId } = await supabase
                    .from('comentarios')
                    .insert([{
                        anuncio_id: anuncioAtual.id,
                        usuario_id: user.id,
                        texto: texto
                    }])
                    .select('*')
                    .single();
                
                if (errorUsuarioId) {
                    // Se erro indica que usuario_id n√£o existe, tentar com visitante_id
                    if (errorUsuarioId.message && errorUsuarioId.message.includes('usuario_id')) {
                        const { data: comentarioComVisitanteId, error: errorVisitanteId } = await supabase
                            .from('comentarios')
                            .insert([{
                                anuncio_id: anuncioAtual.id,
                                visitante_id: user.id,
                                texto: texto
                            }])
                            .select('*')
                            .single();
                        
                        if (errorVisitanteId) {
                            insertError = errorVisitanteId;
                        } else {
                            comentarioSalvo = comentarioComVisitanteId;
                        }
                    } else {
                        insertError = errorUsuarioId;
                    }
                } else {
                    comentarioSalvo = comentarioComUsuarioId;
                }

                if (insertError) {
                    showMessage('Erro ao salvar coment√°rio: ' + (insertError.message || 'Erro desconhecido'), 'error');
                    return;
                }

                // Buscar nome do usu√°rio do coment√°rio
                let nomeUsuario = userProfile?.nome || 'Usu√°rio';
                if (userProfile && userProfile.nome) {
                    nomeUsuario = userProfile.nome;
                } else {
                    // Tentar buscar do banco se n√£o tiver no profile
                    try {
                        const { data: usuarioData, error: userError } = await supabase
                            .from('users')
                            .select('nome')
                            .eq('id', user.id)
                            .single();
                        
                        if (!userError && usuarioData && usuarioData.nome) {
                            nomeUsuario = usuarioData.nome;
                        }
                    } catch (e) {
                    }
                }

                // Adicionar coment√°rio √† lista local
                const novoComentario = {
                    id: comentarioSalvo.id,
                    autor: nomeUsuario,
                    autor_id: user.id,
                    texto: comentarioSalvo.texto,
                    data: comentarioSalvo.criado_em || new Date().toISOString()
                };

                // Recarregar coment√°rios do banco para garantir sincroniza√ß√£o
                await recarregarComentariosELikes();
                
                comentarioInput.value = '';
                showMessage('Coment√°rio adicionado com sucesso!', 'success');
            } catch (error) {
                showMessage('Erro ao adicionar coment√°rio: ' + (error.message || 'Erro desconhecido'), 'error');
            }
        }

        // Fun√ß√£o para recarregar coment√°rios e likes do banco
        async function recarregarComentariosELikes(recarregarComentarios = true) {
            try {
                if (!anuncioAtual || !anuncioAtual.id) {
                    return;
                }

                let service = null;
                if (typeof window.authService !== 'undefined') {
                    service = window.authService;
                } else if (typeof authService !== 'undefined') {
                    service = authService;
                }

                if (!service || !service.isInitialized) {
                    return;
                }

                const supabase = service.getSupabase();
                if (!supabase) {
                    return;
                }

                // Recarregar likes
                try {
                    const { count, error: likesError } = await supabase
                        .from('likes')
                        .select('*', { count: 'exact', head: true })
                        .eq('anuncio_id', anuncioAtual.id);
                    
                    if (!likesError && count !== null) {
                        anuncioAtual.likes = count;
                        document.getElementById('likeCount').textContent = `(${count})`;
                    } else {
                    }
                } catch (e) {
                }

                // Recarregar coment√°rios se solicitado
                if (recarregarComentarios) {
                    try {
                        const { data: comentarios, error: comentariosError } = await supabase
                            .from('comentarios')
                            .select('*')
                            .eq('anuncio_id', anuncioAtual.id)
                            .order('criado_em', { ascending: false });
                        
                        if (!comentariosError && comentarios) {
                            // Buscar nomes dos usu√°rios
                            const userIdColumn = comentarios.length > 0 && comentarios[0].usuario_id !== undefined ? 'usuario_id' : 'visitante_id';
                            const usuariosIds = [...new Set(comentarios.map(c => c[userIdColumn] || c.visitante_id).filter(Boolean))];
                            let usuariosMap = {};
                            if (usuariosIds.length > 0) {
                                const { data: usuarios, error: usuariosError } = await supabase
                                    .from('users')
                                    .select('id, nome, email')
                                    .in('id', usuariosIds);
                                
                                if (!usuariosError && usuarios && usuarios.length > 0) {
                                    usuariosMap = usuarios.reduce((acc, u) => {
                                        acc[u.id] = u;
                                        return acc;
                                    }, {});
                                } else {
                                    // Tentar buscar um por um se o .in() falhar
                                    if (usuariosError) {
                                        for (const userId of usuariosIds) {
                                            try {
                                                const { data: usuario, error: userError } = await supabase
                                                    .from('users')
                                                    .select('id, nome, email')
                                                    .eq('id', userId)
                                                    .maybeSingle();
                                                
                                                if (!userError && usuario) {
                                                    usuariosMap[userId] = usuario;
                                                } else {
                                                }
                                            } catch (e) {
                                            }
                                        }
                                    }
                                }
                            } else {
                            }
                            
                            anuncioAtual.comentarios = comentarios.map(com => {
                                const userId = com.usuario_id || com.visitante_id;
                                const usuario = usuariosMap[userId];
                                const nomeAutor = usuario?.nome || 'Usu√°rio';
                                
                                if (!usuario) {
                                }
                                
                                return {
                                    id: com.id,
                                    autor: nomeAutor,
                                    autor_id: userId,
                                    texto: com.texto,
                                    data: com.criado_em || com.atualizado_em
                                };
                            });
                            renderizarComentarios();
                        } else {
                        }
                    } catch (e) {
                    }
                }
            } catch (error) {
            }
        }

        async function renderizarComentarios() {
            const container = document.getElementById('commentsList');

            if (!anuncioAtual.comentarios || anuncioAtual.comentarios.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Nenhum coment√°rio ainda. Seja o primeiro a comentar!</p>';
                return;
            }

            // Se os coment√°rios vieram do banco mas n√£o t√™m nome do usu√°rio, buscar
            const comentariosComNomes = await Promise.all(anuncioAtual.comentarios.map(async (comentario) => {
                // Se j√° tem nome, usar
                if (comentario.autor && comentario.autor !== 'Usu√°rio') {
                    return comentario;
                }

                // Se n√£o tem nome mas tem autor_id, buscar do banco
                if (comentario.autor_id && typeof window.authService !== 'undefined') {
                    try {
                        const service = window.authService;
                        if (service && service.isInitialized) {
                            const supabase = service.getSupabase();
                            if (supabase) {
                                const { data: usuario, error } = await supabase
                                    .from('users')
                                    .select('nome')
                                    .eq('id', comentario.autor_id)
                                    .single();
                                
                                if (!error && usuario) {
                                    comentario.autor = usuario.nome;
                                }
                            }
                        }
                    } catch (e) {
                    }
                }

                return comentario;
            }));

            container.innerHTML = comentariosComNomes.map(comentario => `
                <div class="comment">
                    <div class="comment-author">${comentario.autor || 'Usu√°rio'}</div>
                    <div class="comment-text">${comentario.texto}</div>
                    <div class="comment-date">${new Date(comentario.data).toLocaleDateString('pt-BR', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}</div>
                </div>
            `).join('');
        }

        async function verificarPermissaoComentario() {
            const commentForm = document.getElementById('commentForm');
            if (!commentForm) return;

            const isLoggedIn = await verificarUsuarioLogado();
            if (!isLoggedIn) {
                commentForm.innerHTML = '<p style="text-align: center; color: #666;"><a href="../auth/login.html" style="color: #0077B6;">Fa√ßa login</a> para deixar coment√°rios</p>';
                return;
            }

            // Verificar se √© dono do an√∫ncio (j√° verificado em verificarSeEDonoDoAnuncio, mas garantir)
            const isDono = await verificarSeEDonoDoAnuncio();
            if (isDono && commentForm.style.display !== 'none') {
                // J√° foi escondido em verificarSeEDonoDoAnuncio, mas garantir
                commentForm.style.display = 'none';
            }
        }

        async function verificarBotaoWhatsApp() {
            const whatsappBtn = document.getElementById('whatsappBtn');
            if (!whatsappBtn) return;
            
            const isLoggedIn = await verificarUsuarioLogado();
            if (!isLoggedIn) {
                // Usu√°rio n√£o logado - mostrar bot√£o para fazer login
                whatsappBtn.textContent = 'üîë Fa√ßa login para contatar';
                whatsappBtn.onclick = () => {
                    window.location.href = '../auth/login.html';
                };
                whatsappBtn.style.display = 'flex';
                return;
            }
            
            // Usu√°rio logado - verificar se tem telefone do anunciante
            // Primeiro, tentar pegar do anuncioAtual.anunciante (dados do Supabase)
            let telefoneAnunciante = null;
            
            if (anuncioAtual.anunciante && anuncioAtual.anunciante.telefone) {
                telefoneAnunciante = anuncioAtual.anunciante.telefone;
            } else {
                // Fallback: tentar buscar do localStorage (para dados est√°ticos)
                const anunciante = anuncioAtual.usuarioEmail || anuncioAtual.anunciante?.email;
                if (anunciante) {
                    const todosUsuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
                    const usuarioAnunciante = todosUsuarios.find(u => u.email === anunciante);
                    if (usuarioAnunciante && usuarioAnunciante.telefone) {
                        telefoneAnunciante = usuarioAnunciante.telefone;
                    }
                }
            }
            
            // Se ainda n√£o encontrou, tentar buscar diretamente do Supabase usando usuario_id
            if (!telefoneAnunciante && anuncioAtual.usuario_id) {
                try {
                    let service = null;
                    if (typeof window.authService !== 'undefined') {
                        service = window.authService;
                    } else if (typeof authService !== 'undefined') {
                        service = authService;
                    }
                    
                    if (service && service.isInitialized) {
                        const supabase = service.getSupabase();
                        if (supabase) {
                            // Tentar buscar com cliente autenticado
                            let usuario = null;
                            let buscarError = null;
                            
                            const { data: usuarioData, error: errorBuscar } = await supabase
                                .from('users')
                                .select('telefone')
                                .eq('id', anuncioAtual.usuario_id)
                                .maybeSingle();
                            
                            if (!errorBuscar && usuarioData) {
                                usuario = usuarioData;
                            } else {
                                buscarError = errorBuscar;
                                
                                // Se der erro 406 (RLS), tentar com cliente an√¥nimo
                                if (buscarError && (buscarError.code === 'PGRST301' || buscarError.message?.includes('406') || buscarError.message?.includes('Not Acceptable'))) {
                                    try {
                                        const anonClient = window.supabase?.createClient?.(
                                            'https://svgmuxdxxrapepbodbgv.supabase.co',
                                            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2Z211eGR4eHJhcGVwYm9kYmd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MTU2MTQsImV4cCI6MjA3Njk5MTYxNH0.U0rQ8-EXC6b0dkcCQBoE-VuNjNgNQREvcs3fWfZ1UGM'
                                        );
                                        
                                        if (anonClient) {
                                            const { data: usuarioAnon, error: errorAnon } = await anonClient
                                                .from('users')
                                                .select('telefone')
                                                .eq('id', anuncioAtual.usuario_id)
                                                .maybeSingle();
                                            
                                            if (!errorAnon && usuarioAnon) {
                                                usuario = usuarioAnon;
                                            }
                                        }
                                    } catch (e) {
                                    }
                                }
                            }
                            
                            if (usuario && usuario.telefone) {
                                telefoneAnunciante = usuario.telefone;
                                // Atualizar anuncioAtual para pr√≥xima vez
                                if (!anuncioAtual.anunciante) {
                                    anuncioAtual.anunciante = {};
                                }
                                anuncioAtual.anunciante.telefone = telefoneAnunciante;
                            } else {
                            }
                        }
                    }
                } catch (e) {
                }
            }
            
            if (telefoneAnunciante) {
                whatsappBtn.textContent = 'üí¨ WhatsApp';
                whatsappBtn.disabled = false;
                whatsappBtn.style.opacity = '1';
                whatsappBtn.onclick = abrirWhatsApp;
                whatsappBtn.style.display = 'flex';
            } else {
                // Anunciante n√£o tem telefone cadastrado
                whatsappBtn.textContent = 'üìû Telefone n√£o dispon√≠vel';
                whatsappBtn.disabled = true;
                whatsappBtn.style.opacity = '0.6';
                whatsappBtn.style.display = 'flex';
            }
        }

        function abrirWhatsApp() {
            if (!anuncioAtual) return;
            
            // Buscar telefone do anunciante
            let telefoneAnunciante = null;
            
            // Primeiro, tentar pegar do anuncioAtual.anunciante (dados do Supabase)
            if (anuncioAtual.anunciante && anuncioAtual.anunciante.telefone) {
                telefoneAnunciante = anuncioAtual.anunciante.telefone;
            } else {
                // Fallback: tentar buscar do localStorage (para dados est√°ticos)
                const anunciante = anuncioAtual.usuarioEmail || anuncioAtual.anunciante?.email;
                if (anunciante) {
                    const todosUsuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
                    const usuarioAnunciante = todosUsuarios.find(u => u.email === anunciante);
                    if (usuarioAnunciante && usuarioAnunciante.telefone) {
                        telefoneAnunciante = usuarioAnunciante.telefone;
                    }
                }
            }
            
            if (!telefoneAnunciante) {
                alert('Telefone do anunciante n√£o est√° dispon√≠vel.');
                return;
            }
            
            // Limpar telefone (remover caracteres n√£o num√©ricos)
            const telefoneLimpo = telefoneAnunciante.replace(/\D/g, '');
            
            // Criar mensagem pr√©-formatada
            const mensagem = `Ol√°, vim pelo Achei na Ilha, e gostei do an√∫ncio da ${anuncioAtual.titulo}. Gostaria de saber mais informa√ß√µes.`;
            const mensagemCodificada = encodeURIComponent(mensagem);
            
            // Abrir WhatsApp
            const urlWhatsApp = `https://wa.me/55${telefoneLimpo}?text=${mensagemCodificada}`;
            window.open(urlWhatsApp, '_blank');
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';

            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        // Fun√ß√µes de autentica√ß√£o ser√£o carregadas do assets/js/header-auth.js

        window.addEventListener('load', async function() {
            // Aguardar um pouco para garantir que scripts est√£o carregados
            await new Promise(resolve => setTimeout(resolve, 500));
            
            try {
                await carregarDetalhes();
            } catch (error) {
                // Mostrar erro mais detalhado no console antes de redirecionar
                const errorMsg = error.message || 'Erro desconhecido';
                // Aguardar um pouco antes de redirecionar para permitir ver o erro no console
                setTimeout(() => {
                    alert('Erro ao carregar detalhes do an√∫ncio. Redirecionando...\n\nErro: ' + errorMsg);
                    window.location.href = 'busca.html';
                }, 2000);
                return;
            }
            
            // Aguardar um pouco e verificar novamente (caso o authService carregue depois)
            setTimeout(async () => {
                await atualizarUIComLogin();
            }, 2000);
        });

        // Carregar header dinamicamente
        function loadHeader() {
            fetch('../../components/header-component.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('header-container').innerHTML = html;
                    
                    // Aguardar o header ser renderizado antes de carregar os scripts
                    setTimeout(() => {
                        loadAuthScripts();
                    }, 100);
                })
                .catch(error => {
                });
        }

        // Carregar scripts de autentica√ß√£o na ordem correta
        function loadAuthScripts() {
            // Verificar se Supabase CDN j√° est√° carregado
            if (typeof window.supabase === 'undefined') {
                const supabaseCDN = document.createElement('script');
                supabaseCDN.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                supabaseCDN.onload = function() {
                    loadAuthService();
                };
                document.head.appendChild(supabaseCDN);
            } else {
                loadAuthService();
            }
        }

        function loadAuthService() {
            // Verificar se auth-service j√° est√° carregado
            if (typeof window.authService === 'undefined') {
                const authServiceScript = document.createElement('script');
                authServiceScript.src = '../../assets/js/supabase-auth-service.js';
                authServiceScript.onload = function() {
                    loadHeaderAuth();
                };
                document.head.appendChild(authServiceScript);
            } else {
                loadHeaderAuth();
            }
        }

        function loadHeaderAuth() {
            // Verificar se header-auth j√° est√° carregado
            if (!document.querySelector('script[src*="header-auth.js"]')) {
                const headerAuthScript = document.createElement('script');
                headerAuthScript.src = '../../assets/js/header-auth.js';
                headerAuthScript.onload = function() {
                    // For√ßar verifica√ß√£o ap√≥s carregar
                    setTimeout(async () => {
                        if (typeof checkUserLogin === 'function') {
                            await checkUserLogin();
                        }
                        // Atualizar UI da p√°gina ap√≥s verificar login
                        setTimeout(async () => {
                            await atualizarUIComLogin();
                        }, 300);
                    }, 500);
                };
                document.head.appendChild(headerAuthScript);
            } else {
                // Script j√° est√° carregado, apenas verificar
                setTimeout(async () => {
                    if (typeof checkUserLogin === 'function') {
                        await checkUserLogin();
                    }
                    // Atualizar UI da p√°gina ap√≥s verificar login
                    setTimeout(async () => {
                        await atualizarUIComLogin();
                    }, 300);
                }, 500);
            }
        }

        // Fun√ß√£o para atualizar UI da p√°gina quando o login for detectado
        async function atualizarUIComLogin() {
            try {
                const isLoggedIn = await verificarUsuarioLogado();
                
                if (isLoggedIn && anuncioAtual) {
                    // Atualizar pre√ßo e localiza√ß√£o
                    const priceElement = document.getElementById('propertyPrice');
                    const locationElement = document.getElementById('propertyLocation');
                    
                    if (priceElement && anuncioAtual.preco) {
                        priceElement.textContent = `R$ ${anuncioAtual.preco.toLocaleString('pt-BR')}`;
                    }
                    
                    if (locationElement && anuncioAtual.localizacao) {
                        locationElement.textContent = `üìç ${anuncioAtual.localizacao}`;
                    }
                    
                    // Atualizar bot√µes
                    await verificarBotaoWhatsApp();
                    await verificarPermissaoComentario();
                }
            } catch (error) {
            }
        }

        // Configurar listener para atualizar UI quando auth mudar
        function setupAuthListener() {
            // Aguardar authService estar dispon√≠vel
            const checkAuthService = setInterval(() => {
                if (typeof window.authService !== 'undefined' && window.authService.isInitialized) {
                    clearInterval(checkAuthService);
                    
                    // Adicionar listener para atualizar UI quando auth mudar
                    window.authService.onAuthStateChange((event, session, user) => {
                        if ((event === 'SIGNED_IN' || event === 'INITIAL_SESSION') && user) {
                            setTimeout(() => {
                                atualizarUIComLogin();
                            }, 500);
                        }
                    });
                }
            }, 100);
            
            // Limitar tentativas
            setTimeout(() => {
                clearInterval(checkAuthService);
            }, 10000);
        }

        // Configurar listener quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            setupAuthListener();
        });

        window.addEventListener('load', function() {
            setupAuthListener();
        });

        // Carregar header quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            loadHeader();
        });
    </script>
</body>
</html>
