<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Achei na Ilha - Novo An√∫ncio</title>
    <link rel="icon" type="image/svg+xml" href="../../assets/images/logo-achei-na-ilha.png">
    <link rel="alternate icon" href="../../assets/images/logo-achei-na-ilha.png">
    <link rel="stylesheet" href="../../assets/css/header.css">
    <!-- Sistema de Toast -->
    <script src="../../assets/js/toast.js"></script>
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../assets/js/supabase-config.js"></script>
    <script src="../../assets/js/supabase-auth-service.js"></script>
    <!-- Servi√ßo de Configura√ß√µes -->
    <script src="../../assets/js/config-service.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding-bottom: 100px;
        }

        .main-content {
            max-width: 800px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .form-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
        }

        .form-title {
            font-size: 28px;
            color: #333333;
            margin-bottom: 10px;
        }

        .form-subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            color: #333333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #0077B6;
            box-shadow: 0 0 0 3px rgba(0, 119, 182, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .file-upload {
            border: 2px dashed #e0e0e0;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: #0077B6;
            background: #f5f9fc;
        }

        .file-upload input {
            display: none;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #666;
            font-size: 14px;
        }

        .file-list {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .btn-remove {
            background: #c62828;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .limit-info {
            margin-top: 10px;
            font-size: 13px;
            color: #666;
        }

        .limit-warning {
            color: #f57c00;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .checkbox-item:hover {
            background: #e9ecef;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .checkbox-item label {
            font-size: 14px;
            color: #333;
            cursor: pointer;
            margin: 0;
            font-weight: 500;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .btn-primary {
            background: #0077B6;
            color: white;
        }

        .btn-primary:hover {
            background: #005a8d;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 119, 182, 0.3);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(108, 117, 125, 0.3);
        }

        .form-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 30px;
        }

        .form-actions .btn {
            margin-top: 0;
        }

        .message {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .message.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .plan-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid #0077B6;
        }

        .plan-info-title {
            font-weight: 700;
            color: #0077B6;
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .form-card {
                padding: 25px;
            }

            .form-title {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <!-- Header ser√° carregado via JavaScript -->
    <div id="header-container"></div>

    <div class="main-content">
        <div class="form-card">
            <h1 class="form-title">Criar Novo An√∫ncio</h1>
            <p class="form-subtitle">Preencha as informa√ß√µes do seu im√≥vel</p>

            <div id="message" class="message"></div>

            <form id="anuncioForm">
                <div class="form-group">
                    <label>Escolha um √≠cone para o an√∫ncio</label>
                    <select id="emoji">
                        <option value="üè†">üè† Casa</option>
                        <option value="üèñÔ∏è">üèñÔ∏è Praia</option>
                        <option value="üè¢">üè¢ Pr√©dio</option>
                        <option value="üèùÔ∏è">üèùÔ∏è Ilha</option>
                        <option value="üèä">üèä Piscina</option>
                        <option value="üåÖ">üåÖ Vista Mar</option>
                        <option value="üè™">üè™ Comercial</option>
                        <option value="üå¥">üå¥ Palmeiras</option>
                        <option value="üè°">üè° Ch√°cara</option>
                        <option value="üåä">üåä Orla</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="titulo">T√≠tulo do Im√≥vel *</label>
                    <input type="text" id="titulo" required placeholder="Ex: Casa de praia com vista para o mar">
                </div>

                <div class="form-group">
                    <label for="descricao">Descri√ß√£o *</label>
                    <textarea id="descricao" required placeholder="Descreva as caracter√≠sticas do im√≥vel..."></textarea>
                </div>

                <div class="form-group">
                    <label for="categoria">Categoria *</label>
                    <select id="categoria" required>
                        <option value="">Selecione</option>
                        <option value="venda">Venda</option>
                        <option value="aluguel">Aluguel</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tipoImovel">Tipo do Im√≥vel *</label>
                    <select id="tipoImovel" required>
                        <option value="">Selecione</option>
                        <option value="casa">Casa</option>
                        <option value="apartamento">Apartamento</option>
                        <option value="terreno">Terreno</option>
                        <option value="comercial">Comercial</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="localizacao">Localiza√ß√£o *</label>
                    <input type="text" id="localizacao" required placeholder="Ex: Praia do Centro">
                </div>

                <div class="form-group">
                    <label for="valor">Valor (R$) *</label>
                    <input type="text" id="valor" required placeholder="0,00" min="0" maxlength="20">
                </div>

                <div class="form-group">
                    <label for="quartos">N√∫mero de Quartos *</label>
                    <select id="quartos" required>
                        <option value="">Selecione</option>
                        <option value="0">0 (Terreno/Comercial)</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6+</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="banheiros">N√∫mero de Banheiros *</label>
                    <select id="banheiros" required>
                        <option value="">Selecione</option>
                        <option value="0">0 (Terreno)</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5+</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="garagem">Possui Garagem?</label>
                    <select id="garagem">
                        <option value="false">N√£o</option>
                        <option value="true">Sim</option>
                    </select>
                </div>

                <div class="form-group" id="vagasGroup" style="display: none;">
                    <label for="vagasGaragem">N√∫mero de Vagas na Garagem</label>
                    <select id="vagasGaragem">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5+</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Caracter√≠sticas Especiais</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="caracPiscina" value="piscina">
                            <label for="caracPiscina">üèä Com Piscina</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="caracVistaMar" value="vista-mar">
                            <label for="caracVistaMar">üåÖ Vista para o Mar</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="caracChurrasqueira" value="churrasqueira">
                            <label for="caracChurrasqueira">üî• Churrasqueira</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="caracRoca" value="roca">
                            <label for="caracRoca">üåæ √Årea de Ro√ßa</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="caracFesta" value="area-festa">
                            <label for="caracFesta">üéâ √Årea para Festa</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="caracVaranda" value="varanda">
                            <label for="caracVaranda">üè° Varanda Grande</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="caracQuintal" value="quintal">
                            <label for="caracQuintal">üå≥ Quintal Espa√ßoso</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="caracCoco" value="coqueiros">
                            <label for="caracCoco">üå¥ Coqueiros</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="caracPoco" value="poco">
                            <label for="caracPoco">üíß Po√ßo Artesiano</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="caracCasa" value="casa-verao">
                            <label for="caracCasa">üèñÔ∏è Casa de Ver√£o</label>
                        </div>
                    </div>
                </div>


                <div class="form-group">
                    <label>Imagens do Im√≥vel</label>
                    <div class="file-upload" onclick="document.getElementById('imageInput').click()">
                        <div class="upload-icon">üì∑</div>
                        <div class="upload-text">Clique para adicionar imagens</div>
                        <input type="file" id="imageInput" accept="image/*" multiple>
                    </div>
                    <div class="limit-info" id="imageLimit"></div>
                    <div class="file-list" id="imageList"></div>
                </div>


                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="btnDraft" onclick="salvarRascunho()">
                        üíæ Salvar como Rascunho
                    </button>
                    <button type="button" class="btn btn-primary" id="btnPublish" onclick="publicarAnuncio()">
                        üöÄ Publicar An√∫ncio
                    </button>
                    <button type="button" class="btn btn-primary" id="btnSaveChanges" onclick="salvarAlteracoes()" style="display: none;">
                        üíæ Salvar altera√ß√µes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Array para armazenar URLs das imagens (ap√≥s upload no Cloudinary)
        let imagensSelecionadas = [];
        // Limite de imagens usando configura√ß√£o centralizada (com fallback)
        // Vari√°vel de configura√ß√£o (ser√° carregada do banco - SEM valores hardcoded)
        let MAX_IMAGENS = null;

        function atualizarLimites() {
            const limitEl = document.getElementById('imageLimit');
            if (!limitEl) return;
            
            if (MAX_IMAGENS === null) {
                limitEl.innerHTML = '<span>Carregando configura√ß√µes...</span>';
                return;
            }
            
            limitEl.innerHTML = `
                <span class="${imagensSelecionadas.length >= MAX_IMAGENS ? 'limit-warning' : ''}">
                    ${imagensSelecionadas.length} / ${MAX_IMAGENS} imagens
                </span>
            `;
        }

        document.getElementById('imageInput').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);

            for (const file of files) {
                if (imagensSelecionadas.length >= MAX_IMAGENS) {
                    showMessage(`Limite de ${MAX_IMAGENS} imagens atingido`, 'error');
                    break;
                }

                // Fazer upload para Cloudinary
                try {
                    const imageUrl = await uploadToCloudinary(file);
                    imagensSelecionadas.push(imageUrl);
                    showMessage('Imagem enviada com sucesso!', 'success');
                } catch (error) {
                    showMessage('Erro ao fazer upload: ' + error.message, 'error');
                }
            }

            renderizarImagensSelecionadas();
            atualizarLimites();
            e.target.value = '';
        });

        // Controlar exibi√ß√£o do campo de vagas baseado na sele√ß√£o de garagem
            document.getElementById('garagem').addEventListener('change', function() {
                const vagasGroup = document.getElementById('vagasGroup');
                if (this.value === 'true') {
                    vagasGroup.style.display = 'block';
                    document.getElementById('vagasGaragem').value = '1'; // Inicia com 1 vaga
                } else {
                    vagasGroup.style.display = 'none';
                    document.getElementById('vagasGaragem').value = '0';
                }
            });

        function renderizarImagensSelecionadas() {
            const container = document.getElementById('imageList');
            container.innerHTML = imagensSelecionadas.map((imageUrl, index) => `
                <div class="file-item" style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px;">
                    <img src="${imageUrl}" alt="Imagem ${index + 1}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;">
                    <span style="flex: 1; word-break: break-all;">${imageUrl.substring(0, 50)}...</span>
                    <button type="button" class="btn-remove" onclick="removerImagem(${index})">Remover</button>
                </div>
            `).join('');
        }

        function removerImagem(index) {
            imagensSelecionadas.splice(index, 1);
            renderizarImagensSelecionadas();
            atualizarLimites();
        }

        // Desabilitar submit padr√£o do form
        document.getElementById('anuncioForm').addEventListener('submit', function(e) {
            e.preventDefault();
        });

        function validarFormulario() {
            // Valida√ß√£o dos campos
            const garagem = document.getElementById('garagem').value === 'true';
            const vagasGaragem = parseInt(document.getElementById('vagasGaragem').value);
            
            if (garagem && vagasGaragem === 0) {
                showMessage('Selecione o n√∫mero de vagas na garagem', 'error');
                return false;
            }

            // Validar campos obrigat√≥rios
            if (!document.getElementById('titulo').value ||
                !document.getElementById('descricao').value ||
                !document.getElementById('categoria').value ||
                !document.getElementById('valor').value || 
                converterMoedaParaNumero(document.getElementById('valor').value) <= 0) {
                showMessage('Por favor, preencha todos os campos obrigat√≥rios', 'error');
                return false;
            }

            return true;
        }

        function coletarDadosAnuncio() {
            return {
                id: anuncioEditandoId || 'temp_' + Date.now(),
                titulo: document.getElementById('titulo').value,
                descricao: document.getElementById('descricao').value,
                categoria: document.getElementById('categoria').value,
                tipo: document.getElementById('tipoImovel').value,
                localizacao: document.getElementById('localizacao').value,
                preco: converterMoedaParaNumero(document.getElementById('valor').value),
                emoji: document.getElementById('emoji').value,
                quartos: parseInt(document.getElementById('quartos').value),
                banheiros: parseInt(document.getElementById('banheiros').value),
                garagem: document.getElementById('garagem').value === 'true',
                vagasGaragem: parseInt(document.getElementById('vagasGaragem').value),
                caracteristicas: getCaracteristicasSelecionadas(),
                imagens: imagensSelecionadas, // Array de URLs das imagens
                imagensCount: imagensSelecionadas.length,
                usuarioEmail: getUsuarioEmail(),
                criadoEm: new Date().toISOString(),
                status: 'rascunho' // ou 'publicado'
            };
        }

        async function salvarRascunho() {
            if (!validarFormulario()) return;

            const btnDraft = document.getElementById('btnDraft');
            btnDraft.disabled = true;
            btnDraft.textContent = 'üíæ Salvando...';

            try {
                // Obter authService
                let service = null;
                if (typeof window.authService !== 'undefined') {
                    service = window.authService;
                } else if (typeof authService !== 'undefined') {
                    service = authService;
                }

                if (!service) {
                    // Tentar encontrar service
                    let attempts = 0;
                    while (!service && attempts < 10) {
                        if (typeof window.authService !== 'undefined') {
                            service = window.authService;
                        } else if (typeof authService !== 'undefined') {
                            service = authService;
                        }
                        if (!service) {
                            await new Promise(resolve => setTimeout(resolve, 300));
                            attempts++;
                        }
                    }
                }

                if (!service || !service.isInitialized) {
                    if (service && !service.isInitialized) {
                        await service.initialize();
                        await new Promise(resolve => setTimeout(resolve, 500));
                    } else {
                        throw new Error('AuthService n√£o dispon√≠vel');
                    }
                }

                const user = await service.getCurrentUser();
                if (!user) {
                    throw new Error('Usu√°rio n√£o logado');
                }

                const supabase = service.getSupabase();
                if (!supabase) {
                    throw new Error('Supabase n√£o dispon√≠vel');
                }

                const dadosAnuncio = coletarDadosAnuncio();
                
                // Mapear dados do formul√°rio para o banco de dados
                const anuncioData = {
                    usuario_id: user.id,
                    titulo: dadosAnuncio.titulo,
                    descricao: dadosAnuncio.descricao,
                    tipo_imovel: dadosAnuncio.tipo,
                    categoria: dadosAnuncio.categoria,
                    valor: dadosAnuncio.preco,
                    endereco: dadosAnuncio.localizacao || '',
                    bairro: null, // Pode ser adicionado depois se necess√°rio
                    cidade: 'Ilha',
                    estado: 'BA',
                    cep: null,
                    area_terreno: null,
                    area_construida: null,
                    quartos: dadosAnuncio.quartos || null,
                    banheiros: dadosAnuncio.banheiros || null,
                    vagas_garagem: dadosAnuncio.vagasGaragem || null,
                    emoji: dadosAnuncio.emoji || null,
                    caracteristicas: dadosAnuncio.caracteristicas || [],
                    imagens: dadosAnuncio.imagens || [], // Array de URLs das imagens do Cloudinary
                    ativo: false // Rascunho n√£o est√° ativo
                };

                // Adicionar campo status se existir na tabela
                try {
                    anuncioData.status = 'rascunho';
                } catch (e) {
                }

                // Verificar se √© edi√ß√£o ou novo an√∫ncio
                let data, error;
                if (anuncioEditandoId) {
                    // Atualizar an√∫ncio existente
                    const { data: updatedData, error: updateError } = await supabase
                        .from('anuncios')
                        .update(anuncioData)
                        .eq('id', anuncioEditandoId)
                        .select()
                        .single();
                    data = updatedData;
                    error = updateError;
                } else {
                    // Criar novo an√∫ncio
                    const { data: insertedData, error: insertError } = await supabase
                        .from('anuncios')
                        .insert([anuncioData])
                        .select()
                        .single();
                    data = insertedData;
                    error = insertError;
                }

                if (error) {
                    throw error;
                }
                showMessage('Rascunho salvo com sucesso!', 'success');

                setTimeout(() => {
                    window.location.href = '../user/meus-anuncios.html';
                }, 1500);
            } catch (error) {
                showMessage('Erro ao salvar rascunho: ' + (error.message || 'Erro desconhecido'), 'error');
            } finally {
                btnDraft.disabled = false;
                btnDraft.textContent = 'üíæ Salvar como Rascunho';
            }
        }

        async function publicarAnuncio() {
            if (!validarFormulario()) return;

            const btnPublish = document.getElementById('btnPublish');
            btnPublish.disabled = true;
            btnPublish.textContent = '‚è≥ Preparando...';

            try {
                const novoAnuncio = coletarDadosAnuncio();
                novoAnuncio.status = 'pendente_pagamento';

                // Salvar dados do an√∫ncio para a p√°gina de pagamento
                localStorage.setItem('pendingAnnouncement', JSON.stringify({
                    id: novoAnuncio.id,
                    titulo: novoAnuncio.titulo,
                    preco: novoAnuncio.preco,
                    dados: novoAnuncio
                }));

                // Redirecionar para p√°gina de pagamento
                window.location.href = '../payment/pagamento.html';
            } catch (error) {
                showMessage('Erro ao preparar publica√ß√£o', 'error');
                btnPublish.disabled = false;
                btnPublish.textContent = 'üöÄ Publicar An√∫ncio';
            }
        }

        function getUsuarioEmail() {
            const usuarioLogado = localStorage.getItem('usuarioLogado');
            if (usuarioLogado) {
                return JSON.parse(usuarioLogado).email;
            }
            return 'anonimo@email.com';
        }

        function getCaracteristicasSelecionadas() {
            const caracteristicas = [];
            const checkboxes = [
                'caracPiscina',
                'caracVistaMar', 
                'caracChurrasqueira',
                'caracRoca',
                'caracFesta',
                'caracVaranda',
                'caracQuintal',
                'caracCoco',
                'caracPoco',
                'caracCasa'
            ];
            
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox && checkbox.checked) {
                    caracteristicas.push(checkbox.value);
                }
            });
            
            return caracteristicas;
        }

        // Fun√ß√£o para formatar valor como moeda brasileira
        function formatarMoeda(valor) {
            // Remove tudo que n√£o √© d√≠gito
            valor = valor.replace(/\D/g, '');
            
            // Se estiver vazio, retorna 0,00
            if (valor === '') {
                return '0,00';
            }
            
            // Converte para n√∫mero e divide por 100 para ter centavos
            const numero = parseInt(valor) / 100;
            
            // Formata como moeda brasileira
            return numero.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Fun√ß√£o para converter valor formatado de volta para n√∫mero
        function converterMoedaParaNumero(valorFormatado) {
            // Remove tudo que n√£o √© d√≠gito
            const apenasNumeros = valorFormatado.replace(/\D/g, '');
            
            // Divide por 100 para ter o valor real (pois os 2 √∫ltimos d√≠gitos s√£o centavos)
            return parseFloat(apenasNumeros) / 100;
        }

        // Aplicar m√°scara de moeda no campo de valor
        function aplicarMascaraMoeda() {
            const campoValor = document.getElementById('valor');
            
            if (campoValor) {
                // Aplicar m√°scara enquanto digita
                campoValor.addEventListener('input', function(e) {
                    const valor = e.target.value;
                    const valorFormatado = formatarMoeda(valor);
                    e.target.value = valorFormatado;
                });

                // Aplicar m√°scara ao perder o foco (caso n√£o tenha aplicado)
                campoValor.addEventListener('blur', function(e) {
                    if (e.target.value) {
                        const valorFormatado = formatarMoeda(e.target.value);
                        e.target.value = valorFormatado;
                    }
                });

                // Permitir apenas n√∫meros e alguns caracteres durante a digita√ß√£o
                campoValor.addEventListener('keypress', function(e) {
                    // Permite apenas n√∫meros
                    if (!/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter'].includes(e.key)) {
                        e.preventDefault();
                    }
                });
            }
        }

        function showMessage(text, type) {
            // Usar toast system
            if (window.toast && window.toast.container) {
                try {
                    if (type === 'success') {
                        const result = window.toast.success(text);
                        if (result) return; // Toast funcionou
                    } else if (type === 'error') {
                        const result = window.toast.error(text);
                        if (result) return; // Toast funcionou
                    } else {
                        const result = window.toast.info(text);
                        if (result) return; // Toast funcionou
                    }
                } catch (e) {
                    // Erro ao mostrar toast, usar fallback
                }
            }
            // Fallback: mostrar mensagem inline ou alert
            const messageDiv = document.getElementById('message');
            if (messageDiv) {
                messageDiv.textContent = text;
                messageDiv.className = 'message ' + type;
                messageDiv.style.display = 'block';
                setTimeout(() => {
                    if (type !== 'success') {
                        messageDiv.style.display = 'none';
                    }
                }, 5000);
            } else {
                alert(text);
            }
        }

        // ===== CONFIGURA√á√ÉO DO CLOUDINARY =====
        // Vari√°vel (ser√° carregada do banco - SEM valores hardcoded)
        let CLOUDINARY_CONFIG = null;

        // Fun√ß√£o para carregar configura√ß√µes do banco
        async function loadConfigurations() {
            try {
                if (!window.configService) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                if (window.configService) {
                    await window.configService.initialize();
                    
                    // Carregar configura√ß√µes de limites (OBRIGAT√ìRIO - do banco)
                    const limitsConfig = await window.configService.getLimitsConfig();
                    if (!limitsConfig.maxImagesPerAd) {
                        throw new Error('Configura√ß√£o de limite de imagens n√£o encontrada no banco de dados.');
                    }
                    MAX_IMAGENS = limitsConfig.maxImagesPerAd;

                    // Carregar configura√ß√µes Cloudinary (OBRIGAT√ìRIO - do banco)
                    const cloudinaryConfig = await window.configService.getCloudinaryConfig();
                    if (!cloudinaryConfig.cloudName || !cloudinaryConfig.uploadPreset) {
                        throw new Error('Configura√ß√µes Cloudinary n√£o encontradas no banco de dados.');
                    }
                    CLOUDINARY_CONFIG = {
                        cloudName: cloudinaryConfig.cloudName,
                        uploadPreset: cloudinaryConfig.uploadPreset
                    };
                } else {
                    throw new Error('ConfigService n√£o dispon√≠vel. Verifique se os scripts foram carregados corretamente.');
                }
            } catch (error) {
                // Em caso de erro, mostrar mensagem clara e n√£o continuar
                const errorMsg = `Erro ao carregar configura√ß√µes do banco de dados: ${error.message}`;
                console.error(errorMsg, error);
                if (window.toast && window.toast.container) {
                    window.toast.error(errorMsg);
                } else {
                    alert(errorMsg + '\n\nO sistema n√£o pode continuar sem as configura√ß√µes do banco de dados.');
                }
                throw error; // Propagar erro para que a p√°gina n√£o continue sem configura√ß√µes
            }
        }

        // Fun√ß√£o para fazer upload de imagem para Cloudinary
        async function uploadToCloudinary(file) {
            try {
                // Validar arquivo
                if (!file) {
                    throw new Error('Nenhum arquivo selecionado');
                }

                // Validar tipo de arquivo
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                if (!allowedTypes.includes(file.type)) {
                    throw new Error('Tipo de arquivo n√£o suportado. Use JPG, PNG, GIF ou WebP');
                }

                // Validar tamanho (m√°ximo 10MB)
                const maxSize = 10 * 1024 * 1024; // 10MB
                if (file.size > maxSize) {
                    throw new Error('Arquivo muito grande. M√°ximo 10MB');
                }

                // Verificar se Cloudinary est√° configurado
                if (!CLOUDINARY_CONFIG || !CLOUDINARY_CONFIG.cloudName || !CLOUDINARY_CONFIG.uploadPreset) {
                    throw new Error('Configura√ß√µes Cloudinary n√£o foram carregadas do banco de dados.');
                }
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);

                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/image/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    if (response.status === 401) {
                        throw new Error('Erro de autentica√ß√£o: Verifique as configura√ß√µes do Cloudinary');
                    } else if (response.status === 400) {
                        throw new Error('Erro na requisi√ß√£o: Verifique o upload preset');
                    } else {
                        throw new Error(`Erro no upload: ${response.status} - ${response.statusText}`);
                    }
                }

                const data = await response.json();
                return data.secure_url;
            } catch (error) {
                throw error;
            }
        }

        async function verificarPermissao() {
            // PRIMEIRO: Verificar token no localStorage (mais r√°pido e confi√°vel)
            let tokenFound = false;
            
            // Tentar diferentes padr√µes de chave do Supabase
            const possibleKeys = [
                ...Object.keys(localStorage).filter(key => key.includes('supabase') && key.includes('auth-token')),
                ...Object.keys(localStorage).filter(key => key.includes('sb-') && key.includes('auth-token')),
                ...Object.keys(localStorage).filter(key => key.startsWith('sb-svgmuxdxxrapepbodbgv-auth-token'))
            ];
            
            for (const key of possibleKeys) {
                try {
                    const tokenData = JSON.parse(localStorage.getItem(key));
                    if (tokenData && tokenData.access_token) {
                        tokenFound = true;
                        break;
                    }
                } catch (e) {
                    // Continuar tentando outras chaves
                }
            }
            
            // Tamb√©m verificar se h√° alguma chave que contenha dados de sess√£o
            if (!tokenFound) {
                const sessionKeys = Object.keys(localStorage).filter(key => 
                    key.includes('supabase') || 
                    (key.includes('sb-') && key.includes('auth'))
                );
                
                for (const key of sessionKeys) {
                    try {
                        const data = localStorage.getItem(key);
                        if (data && (data.includes('access_token') || data.includes('refresh_token'))) {
                            tokenFound = true;
                            break;
                        }
                    } catch (e) {
                        // Continuar
                    }
                }
            }
            
            if (tokenFound) {
                return;
            }
            
            // SEGUNDO: Verificar via authService (aguardar mais tempo)
            let service = null;
            let attempts = 0;
            const maxAttempts = 10; // Mais tentativas
            
            // Tentar encontrar o service com v√°rias tentativas
            while (!service && attempts < maxAttempts) {
                if (typeof window.authService !== 'undefined') {
                    service = window.authService;
                } else if (typeof authService !== 'undefined') {
                    service = authService;
                }
                
                if (!service) {
                    await new Promise(resolve => setTimeout(resolve, 300));
                    attempts++;
                }
            }
            
            if (service) {
                try {
                    if (!service.isInitialized) {
                        await service.initialize();
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    
                    // Aguardar um pouco mais para garantir que est√° pronto
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    const user = await service.getCurrentUser();
                    
                    if (user) {
                        return;
                    } else {
                    }
                } catch (error) {
                }
            } else {
            }
            
            // Se chegou aqui, verificar uma √∫ltima vez se h√° token
            // (pode ter sido salvo enquanto aguard√°vamos)
            const finalCheck = Object.keys(localStorage).find(key => 
                (key.includes('supabase') || key.includes('sb-')) && 
                (key.includes('auth-token') || key.includes('auth'))
            );
            
            if (finalCheck) {
                try {
                    const data = localStorage.getItem(finalCheck);
                    if (data && (data.includes('access_token') || data.includes('refresh_token'))) {
                        return;
                    }
                } catch (e) {
                    // Ignorar
                }
            }
            
            // √öLTIMA VERIFICA√á√ÉO: Se o bot√£o "Anunciar" est√° vis√≠vel no header, deve estar logado
            const btnAnnounce = document.getElementById('btnAnnounce');
            if (btnAnnounce && !btnAnnounce.classList.contains('hidden')) {
                return;
            }
            
            // Se chegou aqui, realmente n√£o est√° logado
            window.location.href = '../auth/login.html';
        }

        // Fun√ß√µes de autentica√ß√£o ser√£o carregadas do assets/js/header-auth.js

        // Vari√°vel global para armazenar ID do an√∫ncio sendo editado
        let anuncioEditandoId = null;

        async function carregarAnuncioParaEdicao() {
            // Verificar se h√° ID na URL
            const urlParams = new URLSearchParams(window.location.search);
            const anuncioId = urlParams.get('id');
            
            if (!anuncioId) {
                return;
            }
            anuncioEditandoId = anuncioId;

            try {
                let service = null;
                if (typeof window.authService !== 'undefined') {
                    service = window.authService;
                } else if (typeof authService !== 'undefined') {
                    service = authService;
                }

                if (!service || !service.isInitialized) {
                    if (service && !service.isInitialized) {
                        await service.initialize();
                        await new Promise(resolve => setTimeout(resolve, 500));
                    } else {
                        throw new Error('AuthService n√£o dispon√≠vel');
                    }
                }

                const supabase = service.getSupabase();
                if (!supabase) {
                    throw new Error('Supabase n√£o dispon√≠vel');
                }

                // Buscar an√∫ncio com suas imagens
                const { data: anuncio, error } = await supabase
                    .from('anuncios')
                    .select(`
                        *,
                        imagens_anuncio (
                            id,
                            url,
                            ordem,
                            principal
                        )
                    `)
                    .eq('id', anuncioId)
                    .single();

                if (error || !anuncio) {
                    throw new Error('An√∫ncio n√£o encontrado');
                }

                // Preencher formul√°rio com dados do an√∫ncio
                document.getElementById('titulo').value = anuncio.titulo || '';
                document.getElementById('descricao').value = anuncio.descricao || '';
                document.getElementById('categoria').value = anuncio.categoria || '';
                document.getElementById('tipoImovel').value = anuncio.tipo_imovel || '';
                document.getElementById('localizacao').value = anuncio.endereco || '';
                document.getElementById('emoji').value = anuncio.emoji || 'üè†';
                
                // Formatar valor para exibi√ß√£o
                if (anuncio.valor) {
                    const valorFormatado = anuncio.valor.toLocaleString('pt-BR', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    document.getElementById('valor').value = valorFormatado;
                }

                document.getElementById('quartos').value = anuncio.quartos || '';
                document.getElementById('banheiros').value = anuncio.banheiros || '';
                
                // Garagem
                if (anuncio.vagas_garagem && anuncio.vagas_garagem > 0) {
                    document.getElementById('garagem').value = 'true';
                    document.getElementById('vagasGroup').style.display = 'block';
                    document.getElementById('vagasGaragem').value = anuncio.vagas_garagem || 1;
                } else {
                    document.getElementById('garagem').value = 'false';
                    document.getElementById('vagasGroup').style.display = 'none';
                }

                // Caracter√≠sticas
                if (anuncio.caracteristicas && Array.isArray(anuncio.caracteristicas)) {
                    anuncio.caracteristicas.forEach(carac => {
                        const checkbox = document.getElementById(`carac${carac.charAt(0).toUpperCase() + carac.slice(1).replace(/-/g, '')}`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                }

                // Carregar imagens do an√∫ncio
                if (anuncio.imagens_anuncio && Array.isArray(anuncio.imagens_anuncio) && anuncio.imagens_anuncio.length > 0) {
                    // Ordenar imagens por ordem
                    const imagensOrdenadas = anuncio.imagens_anuncio.sort((a, b) => (a.ordem || 0) - (b.ordem || 0));
                    
                    // Preencher array de imagens selecionadas com as URLs
                    imagensSelecionadas = imagensOrdenadas.map(img => img.url);
                    
                    // Renderizar imagens na tela
                    renderizarImagensSelecionadas();
                    atualizarLimites();
                } else {
                    // Limpar imagens se n√£o houver
                    imagensSelecionadas = [];
                    renderizarImagensSelecionadas();
                    atualizarLimites();
                }

                // Atualizar t√≠tulo da p√°gina
                document.querySelector('.form-title').textContent = 'Editar An√∫ncio';
                document.querySelector('.form-subtitle').textContent = 'Atualize as informa√ß√µes do seu im√≥vel';

                // Atualizar visibilidade dos bot√µes
                atualizarVisibilidadeBotoes();

                showMessage('An√∫ncio carregado para edi√ß√£o', 'success');
            } catch (error) {
                showMessage('Erro ao carregar an√∫ncio: ' + (error.message || 'Erro desconhecido'), 'error');
            }
        }

        // Fun√ß√£o para atualizar visibilidade dos bot√µes baseado no modo de edi√ß√£o
        function atualizarVisibilidadeBotoes() {
            const btnDraft = document.getElementById('btnDraft');
            const btnPublish = document.getElementById('btnPublish');
            const btnSaveChanges = document.getElementById('btnSaveChanges');
            
            if (anuncioEditandoId) {
                // Modo edi√ß√£o: mostrar apenas "Salvar altera√ß√µes"
                if (btnDraft) btnDraft.style.display = 'none';
                if (btnPublish) btnPublish.style.display = 'none';
                if (btnSaveChanges) btnSaveChanges.style.display = 'inline-block';
            } else {
                // Modo cria√ß√£o: mostrar "Salvar como Rascunho" e "Publicar An√∫ncio"
                if (btnDraft) btnDraft.style.display = 'inline-block';
                if (btnPublish) btnPublish.style.display = 'inline-block';
                if (btnSaveChanges) btnSaveChanges.style.display = 'none';
            }
        }

        // Fun√ß√£o para salvar altera√ß√µes quando editando
        async function salvarAlteracoes() {
            if (!validarFormulario()) return;

            const btnSaveChanges = document.getElementById('btnSaveChanges');
            btnSaveChanges.disabled = true;
            btnSaveChanges.textContent = '‚è≥ Salvando...';

            try {
                let service = null;
                if (typeof window.authService !== 'undefined') {
                    service = window.authService;
                } else if (typeof authService !== 'undefined') {
                    service = authService;
                }

                if (!service || !service.isInitialized) {
                    if (service && !service.isInitialized) {
                        await service.initialize();
                        await new Promise(resolve => setTimeout(resolve, 500));
                    } else {
                        throw new Error('AuthService n√£o dispon√≠vel');
                    }
                }

                const supabase = service.getSupabase();
                if (!supabase) {
                    throw new Error('Supabase n√£o dispon√≠vel');
                }

                const dadosAnuncio = coletarDadosAnuncio();
                
                // Preparar dados para atualiza√ß√£o
                const anuncioData = {
                    titulo: dadosAnuncio.titulo,
                    descricao: dadosAnuncio.descricao,
                    tipo_imovel: dadosAnuncio.tipo,
                    categoria: dadosAnuncio.categoria,
                    valor: dadosAnuncio.preco,
                    endereco: dadosAnuncio.localizacao || '',
                    quartos: dadosAnuncio.quartos || null,
                    banheiros: dadosAnuncio.banheiros || null,
                    vagas_garagem: dadosAnuncio.vagasGaragem || null,
                    emoji: dadosAnuncio.emoji || null,
                    caracteristicas: dadosAnuncio.caracteristicas || []
                };

                // Atualizar an√∫ncio existente
                const { data, error } = await supabase
                    .from('anuncios')
                    .update(anuncioData)
                    .eq('id', anuncioEditandoId)
                    .select()
                    .single();

                if (error) {
                    throw error;
                }

                showMessage('Altera√ß√µes salvas com sucesso!', 'success');

                setTimeout(() => {
                    window.location.href = '../user/meus-anuncios.html';
                }, 1500);
            } catch (error) {
                showMessage('Erro ao salvar altera√ß√µes: ' + (error.message || 'Erro desconhecido'), 'error');
            } finally {
                btnSaveChanges.disabled = false;
                btnSaveChanges.textContent = 'üíæ Salvar altera√ß√µes';
            }
        }

        window.addEventListener('load', async function() {
            // Carregar configura√ß√µes do banco primeiro
            await loadConfigurations();
            // Aplicar m√°scara de moeda no campo de valor
            aplicarMascaraMoeda();
            
            // Aguardar um pouco antes de verificar (para dar tempo do header carregar)
            await new Promise(resolve => setTimeout(resolve, 1500));
            await verificarPermissao();
            atualizarLimites();
            
            // Carregar an√∫ncio se estiver editando
            await carregarAnuncioParaEdicao();
            
            // Atualizar visibilidade dos bot√µes ap√≥s carregar
            atualizarVisibilidadeBotoes();
            
            // For√ßar atualiza√ß√£o do header ap√≥s tudo carregar
            setTimeout(async () => {
                if (typeof window.updateHeaderLogin === 'function') {
                    await window.updateHeaderLogin();
                }
            }, 2000);
        });

        // Tamb√©m aplicar quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', function() {
            aplicarMascaraMoeda();
        });

        // Carregar header dinamicamente
        function loadHeader() {
            fetch('../../components/header-component.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('header-container').innerHTML = html;
                    
                    // Aguardar o header ser renderizado antes de carregar os scripts
                    setTimeout(() => {
                        loadAuthScripts();
                    }, 100);
                })
                .catch(error => {
                });
        }

        // Carregar scripts de autentica√ß√£o na ordem correta
        function loadAuthScripts() {
            // Verificar se Supabase CDN j√° est√° carregado
            if (typeof window.supabase === 'undefined') {
                const supabaseCDN = document.createElement('script');
                supabaseCDN.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                supabaseCDN.onload = function() {
                    loadAuthService();
                };
                document.head.appendChild(supabaseCDN);
            } else {
                loadAuthService();
            }
        }

        function loadAuthService() {
            // Verificar se auth-service j√° est√° carregado
            if (typeof window.authService === 'undefined') {
                const authServiceScript = document.createElement('script');
                authServiceScript.src = '../../assets/js/supabase-auth-service.js';
                authServiceScript.onload = function() {
                    loadHeaderAuth();
                };
                document.head.appendChild(authServiceScript);
            } else {
                loadHeaderAuth();
            }
        }

        function loadHeaderAuth() {
            // Verificar se header-auth j√° est√° carregado
            if (!document.querySelector('script[src*="header-auth.js"]')) {
                const headerAuthScript = document.createElement('script');
                headerAuthScript.src = '../../assets/js/header-auth.js';
                headerAuthScript.onload = function() {
                    // For√ßar verifica√ß√£o ap√≥s carregar
                    setTimeout(async () => {
                        if (typeof checkUserLogin === 'function') {
                            await checkUserLogin();
                        }
                        // For√ßar atualiza√ß√£o do header tamb√©m
                        if (typeof window.updateHeaderLogin === 'function') {
                            await window.updateHeaderLogin();
                        }
                    }, 500);
                };
                document.head.appendChild(headerAuthScript);
            } else {
                // Script j√° est√° carregado, apenas verificar
                setTimeout(async () => {
                    if (typeof checkUserLogin === 'function') {
                        await checkUserLogin();
                    }
                    // For√ßar atualiza√ß√£o do header tamb√©m
                    if (typeof window.updateHeaderLogin === 'function') {
                        await window.updateHeaderLogin();
                    }
                }, 500);
            }
        }

        // Carregar header quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            loadHeader();
        });
    </script>
</body>
</html>

